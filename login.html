<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Innovación Sindical · Acceso (Modo Seguro)</title>
  <meta name="color-scheme" content="dark"/>
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0b1022; --panel:rgba(7,17,35,.78);
      --edge:rgba(91,215,242,.35); --edge-soft:rgba(255,255,255,.14);
      --txt:#e6fbff; --muted:#b9d8e0; --accent:#5bd7f2; --accent-2:#60a5fa;
      --ok:#00d19a; --err:#ff6b6b; --warn:#ffb020;
      --shadow:0 20px 60px rgba(0,0,0,.45);
      --r-xl:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      color:var(--txt);
      background:
        radial-gradient(70vmax 60vmax at 50% 12%, rgba(96,165,250,.16), transparent 60%),
        radial-gradient(60vmax 60vmax at 80% 80%, rgba(91,215,242,.12), transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    .grid::before{content:"";position:fixed;inset:0;pointer-events:none;opacity:.16;
      background-image:linear-gradient(to right, rgba(96,165,250,.12) 1px, transparent 1px),
                       linear-gradient(to bottom, rgba(91,215,242,.10) 1px, transparent 1px);
      background-size:48px 48px,48px 48px}
    .wrap{min-height:100%;display:grid;place-items:center;padding:24px}
    .card{
      width:100%; max-width:920px; background:var(--panel); border:1px solid var(--edge);
      border-radius:var(--r-xl); box-shadow:var(--shadow); overflow:hidden
    }
    .head{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px 18px; border-bottom:1px solid var(--edge);
      background:linear-gradient(180deg, rgba(91,215,242,.10), transparent);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:40px;height:40px;border-radius:14px;display:grid;place-items:center;
      background:linear-gradient(135deg, rgba(96,165,250,.22), rgba(91,215,242,.10));
      border:1px solid var(--edge)}
    .brand h1{margin:0;font-size:18px;letter-spacing:.3px}
    .back{appearance:none;border:1px solid var(--edge-soft);background:transparent;color:var(--txt);
      padding:9px 12px;border-radius:12px;cursor:pointer}
    .back:hover{border-color:var(--edge)}

    .body{display:grid; grid-template-columns:1fr; gap:0}
    @media(min-width:940px){ .body{grid-template-columns:1.1fr .9fr} }

    .panel{ padding:20px; border-right:1px solid var(--edge); }
    @media(max-width:939px){ .panel{border-right:none; border-bottom:1px solid var(--edge)} }

    .aside{ padding:20px; }

    .tabs{display:flex; gap:8px; margin-bottom:14px}
    .tab{ padding:8px 12px; border-radius:999px; font-size:13px; cursor:pointer;
      border:1px solid var(--edge-soft); background:transparent; color:var(--txt) }
    .tab[aria-selected="true"]{ border-color:var(--accent); box-shadow:0 0 0 2px rgba(91,215,242,.15) inset }

    label{display:block; font-size:12px; color:var(--muted); margin:8px 0 6px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .grow{flex:1 1 260px}
    input{
      width:100%; padding:12px 13px; border-radius:12px;
      border:1px solid var(--edge-soft); background:#071327; color:var(--txt); outline:none
    }
    input:focus{ border-color:var(--accent) }

    .btn{
      appearance:none; border:1px solid var(--edge); background:transparent; color:var(--txt);
      padding:10px 14px; border-radius:12px; cursor:pointer; transition:transform .06s ease;
      min-width:140px; display:inline-flex; align-items:center; justify-content:center; gap:8px
    }
    .btn:hover{ transform:translateY(-1px) }
    .btn.primary{ border-color:var(--accent) }
    .btn.link{ border-color:var(--edge-soft) }

    .tag{display:inline-flex; align-items:center; gap:6px; padding:5px 9px; border-radius:999px; border:1px solid var(--edge-soft); font-size:12px; color:#b9d8e0}
    .ok{border-color:rgba(0,209,154,.35); color:#00d19a}
    .err{border-color:rgba(255,107,107,.35); color:#ff6b6b}
    .muted{color:#b9d8e0; font-size:12px}
    pre{white-space:pre-wrap; background:#061227; border:1px dashed rgba(255,255,255,.15); border-radius:12px; padding:12px; max-height:300px; overflow:auto}
    .box{border:1px dashed var(--edge-soft);border-radius:12px;padding:10px}
  </style>

  <!-- SDK Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="grid"></div>
  <div class="wrap">
    <div class="card" role="region" aria-labelledby="title">
      <header class="head">
        <div class="brand">
          <div class="logo" aria-hidden="true">◆</div>
          <h1 id="title">Innovación Sindical · Acceso</h1>
        </div>
        <a class="back" href="https://chronosbvrx.github.io/InnovacionSindical/">← Volver al inicio</a>
      </header>

      <div class="body">
        <!-- Panel -->
        <section class="panel">
          <nav class="tabs" role="tablist" aria-label="Modo de acceso">
            <button class="tab" id="tab-login" role="tab" aria-selected="true" aria-controls="panel-login">Entrar</button>
            <button class="tab" id="tab-signup" role="tab" aria-selected="false" aria-controls="panel-signup">Crear cuenta</button>
          </nav>

          <!-- Entrar -->
          <form id="panel-login" role="tabpanel" aria-labelledby="tab-login">
            <div class="row">
              <div class="grow">
                <label for="login-email">Correo</label>
                <input id="login-email" type="email" placeholder="tu@correo.com" autocomplete="username" required/>
              </div>
              <div class="grow">
                <label for="login-pass">Contraseña</label>
                <input id="login-pass" type="password" placeholder="••••••••" autocomplete="current-password" required/>
              </div>
            </div>
            <div style="height:12px"></div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button type="submit" class="btn primary" id="btn-login">Entrar</button>
              <span class="tag" id="state-login">Listo</span>
            </div>
            <div style="height:8px"></div>
            <p class="muted">¿No tienes cuenta? Cambia a <strong>Crear cuenta</strong>.</p>
          </form>

          <!-- Crear cuenta -->
          <form id="panel-signup" role="tabpanel" aria-labelledby="tab-signup" hidden>
            <div class="row">
              <div class="grow">
                <label for="su-email">Correo</label>
                <input id="su-email" type="email" placeholder="tu@correo.com" autocomplete="username" required/>
              </div>
              <div class="grow">
                <label for="su-pass">Contraseña</label>
                <input id="su-pass" type="password" placeholder="Mín. 6 caracteres" autocomplete="new-password" minlength="6" required/>
              </div>
            </div>
            <div style="height:12px"></div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button type="submit" class="btn primary" id="btn-signup">Crear cuenta</button>
              <span class="tag" id="state-signup">Listo</span>
            </div>
            <div style="height:8px"></div>
            <div class="box muted">Si la confirmación por correo está activada en Supabase, revisa tu bandeja para validar la cuenta.</div>
          </form>
        </section>

        <!-- Aside -->
        <aside class="aside">
          <h3 style="margin:4px 0 10px">Estado</h3>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <span id="authState" class="tag">No autenticado</span>
            <button class="btn link" id="btn-logout">Salir</button>
          </div>

          <div style="height:12px"></div>
          <h3 style="margin:0 0 8px">Probar API protegida</h3>
          <p class="muted">Consulta <code>/profile</code> en tu API de Render con tu token.</p>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn" id="btn-profile">GET /profile</button>
            <span class="tag" id="apiState">Listo</span>
          </div>
          <div style="height:8px"></div>
          <pre id="apiResult">—</pre>

          <div style="height:12px"></div>
          <h3 style="margin:0 0 8px">Chequeos</h3>
          <div id="checks" class="box muted">Cargando chequeos…</div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const SUPABASE_URL  = "https://axsncdwshdvsysrpikwj.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c25jZHdzaGR2c3lzcnBpa3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjkwMjQsImV4cCI6MjA3NTgwNTAyNH0.oapcH219puVjaR2DcG7dX51uhwVn530L1hhz8ASv7qs";
    const API_BASE      = "https://sinos-api.onrender.com";
    const LOGIN_URL     = "https://chronosbvrx.github.io/InnovacionSindical/login.html"; // para redirects
    // ==================

    const $ = sel => document.querySelector(sel);
    const tag = (el, text, cls='') => { el.textContent = text; el.className = 'tag ' + cls; };

    // Tabs
    $('#tab-login').onclick = ()=> selectTab('login');
    $('#tab-signup').onclick = ()=> selectTab('signup');
    function selectTab(which){
      const login = which === 'login';
      $('#tab-login').setAttribute('aria-selected', login);
      $('#tab-signup').setAttribute('aria-selected', !login);
      $('#panel-login').hidden = !login;
      $('#panel-signup').hidden = login;
    }

    // Chequeos visibles
    const checks = $('#checks');
    function setCheck(lines){ checks.innerHTML = lines.map(l=>`• ${l}`).join('<br>'); }

    // 1) Validaciones previas
    const preErrors = [];
    if (!window.supabase) preErrors.push('❌ No se cargó supabase-js (CDN).');
    if (!/^https:\/\/.+\.supabase\.co$/.test(SUPABASE_URL)) preErrors.push('❌ SUPABASE_URL inválida.');
    if (!SUPABASE_ANON || SUPABASE_ANON.length < 40) preErrors.push('❌ ANON KEY vacía o demasiado corta.');
    if (!/^https?:\/\//.test(API_BASE)) preErrors.push('❌ API_BASE inválida.');

    // 2) Crear cliente o reportar errores
    let supa = null;
    if (preErrors.length === 0) {
      const { createClient } = window.supabase;
      try {
        supa = createClient(SUPABASE_URL, SUPABASE_ANON);
        setCheck(['✅ SDK cargado','✅ URL válida','✅ ANON presente','✅ API_BASE válida']);
      } catch(e) {
        preErrors.push('❌ Error creando cliente: ' + e.message);
      }
    }
    if (preErrors.length) setCheck(preErrors);

    // 3) Reflejar sesión y escuchar cambios (importante tras email)
    async function reflectSession(){
      if (!supa) { tag($('#authState'), 'Sin cliente', 'err'); return null; }
      const { data:{ session }, error } = await supa.auth.getSession();
      if (error) tag($('#authState'), 'Error sesión', 'err');
      if (session?.user) tag($('#authState'), `Autenticado: ${session.user.email}`, 'ok');
      else tag($('#authState'), 'No autenticado');
      return session || null;
    }
    if (supa) {
      supa.auth.onAuthStateChange((_event, _session) => {
        // Se dispara cuando volvemos del correo con #access_token
        reflectSession();
      });
    }

    // 4) Entrar
    $('#panel-login').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!supa) { tag($('#state-login'),'Sin cliente', 'err'); return; }
      tag($('#state-login'), 'Validando…');
      const email = $('#login-email').value.trim();
      const password = $('#login-pass').value;
      if (!email || !password) { tag($('#state-login'), 'Completa los campos', 'err'); return; }
      const { error } = await supa.auth.signInWithPassword({ email, password });
      if (error) tag($('#state-login'), error.message, 'err');
      else {
        tag($('#state-login'), 'Sesión iniciada', 'ok');
        // Opcional: redirigir automáticamente
        // location.href = './protected.html';
      }
      reflectSession();
    });

    // 5) Crear cuenta (con emailRedirectTo → vuelve a este login)
    $('#panel-signup').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!supa) { tag($('#state-signup'),'Sin cliente', 'err'); return; }
      tag($('#state-signup'), 'Creando…');
      const email = $('#su-email').value.trim();
      const password = $('#su-pass').value;
      if (!email || !password) { tag($('#state-signup'), 'Completa los campos', 'err'); return; }
      if (password.length < 6) { tag($('#state-signup'), 'Contraseña muy corta', 'err'); return; }
      const { error } = await supa.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: LOGIN_URL
        }
      });
      if (error) tag($('#state-signup'), error.message, 'err');
      else tag($('#state-signup'), 'Revisa tu correo para confirmar', 'ok');
      reflectSession();
    });

    // 6) Salir
    $('#btn-logout').onclick = async ()=>{
      if (!supa) return;
      await supa.auth.signOut();
      tag($('#state-login'),'Listo'); tag($('#state-signup'),'Listo');
      reflectSession();
    };

    // 7) Probar API
    $('#btn-profile').onclick = async ()=>{
      if (!supa) { tag($('#apiState'),'Sin cliente','err'); return; }
      tag($('#apiState'),'Llamando…');
      $('#apiResult').textContent = 'Llamando API...';
      const { data:{ session } } = await supa.auth.getSession();
      if (!session){ tag($('#apiState'),'Sin sesión','err'); $('#apiResult').textContent='Inicia sesión primero.'; return; }
      try{
        const res = await fetch(`${API_BASE}/profile`, { headers:{ Authorization:`Bearer ${session.access_token}` } });
        const json = await res.json();
        $('#apiResult').textContent = JSON.stringify(json, null, 2);
        tag($('#apiState'), res.ok ? 'OK' : `Error ${res.status}`, res.ok ? 'ok' : 'err');
      }catch(e){
        tag($('#apiState'),'Error','err');
        $('#apiResult').textContent = 'Error: ' + e.message;
      }
    };

    // 8) Al cargar
    reflectSession();
  </script>
</body>
</html>
