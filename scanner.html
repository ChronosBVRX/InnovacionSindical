<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Esc√°ner de Asistencia ‚Äî Unidad en Acci√≥n</title>
<link rel="icon" href="https://github.com/ChronosBVRX/InnovacionSindical/blob/main/Logo%20Unidad%20en%20Accion.png?raw=true">
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0b1022; --panel:#101a33; --ring:rgba(91,215,242,.35);
    --txt:#e6fbff; --muted:#aee9f7; --primary:#5bd7f2; --sky:#60a5fa;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  body{min-height:100vh;background:linear-gradient(180deg,#0b1220,#0b1022);color:var(--txt);display:flex;flex-direction:column;padding:20px}
  h2{color:#5bd7f2;margin-bottom:10px}
  .wrap{max-width:520px;margin:0 auto}
  .card{background:var(--panel);border:1px solid rgba(91,215,242,.25);border-radius:16px;padding:16px;box-shadow:0 8px 25px rgba(0,0,0,.25)}
  #reader{width:100%;max-width:420px;margin:12px auto;border:1px solid rgba(91,215,242,.3);border-radius:12px;overflow:hidden}
  #loginBox{display:grid;gap:10px;margin:20px auto}
  input{padding:10px;border-radius:10px;border:1px solid rgba(91,215,242,.35);background:#101a33;color:#e6fbff}
  button{padding:10px;background:linear-gradient(90deg,#5bd7f2,#60a5fa);border:none;border-radius:10px;color:#072133;font-weight:700;cursor:pointer}
  .meta{font-size:13px;color:#9fdcf0;margin-top:8px}
  .ok{color:#80ff9b}
  .err{color:#ff8080}
</style>
</head>
<body>
  <div class="wrap">
    <h2>üîé Esc√°ner de Asistencia</h2>

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <div id="loginBox">
        <input id="email" type="email" placeholder="Correo de verificador">
        <input id="password" type="password" placeholder="Contrase√±a">
        <button id="btnLogin">Iniciar sesi√≥n</button>
        <div id="loginStatus" class="meta"></div>
      </div>
      <div id="who" class="meta" style="display:none"></div>
    </div>

    <!-- SCANNER -->
    <div id="scannerCard" class="card" style="margin-top:16px; display:none">
      <div class="meta">Apunta la c√°mara al c√≥digo QR del asistente</div>
      <div id="reader"></div>
      <div id="result" class="meta"></div>
      <button id="btnLogout" style="margin-top:10px">Cerrar sesi√≥n</button>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://axsncdwshdvsysrpikwj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c25jZHdzaGR2c3lzcnBpa3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjkwMjQsImV4cCI6MjA3NTgwNTAyNH0.oapcH219puVjaR2DcG7dX51uhwVn530L1hhz8ASv7qs";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession: true, autoRefreshToken: true } });

const loginCard = document.getElementById("loginCard");
const scannerCard = document.getElementById("scannerCard");
const loginStatus = document.getElementById("loginStatus");
const who = document.getElementById("who");
const readerElem = document.getElementById("reader");
let QR;

document.getElementById("btnLogin").onclick = onLogin;
document.getElementById("btnLogout").onclick = onLogout;

init();

async function init(){
  await supabase.auth.refreshSession();
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    const ok = await checkIsAdmin(session.user);
    if (ok) {
      showScanner(session.user);
      return;
    }
  }
  showLogin();
}

function showLogin(){
  loginCard.style.display = 'block';
  scannerCard.style.display = 'none';
  who.style.display = 'none';
}
function showScanner(user){
  loginCard.style.display = 'block';
  who.style.display = 'block';
  who.textContent = `Conectado como: ${user.email} ‚Ä¢ rol: ${user.app_metadata?.role || '‚Äî'}`;
  scannerCard.style.display = 'block';
  startScanner();
}

async function onLogin(){
  loginStatus.textContent = "Verificando credenciales‚Ä¶";
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) { loginStatus.textContent = "‚ùå " + error.message; return; }
  const ok = await checkIsAdmin(data.user);
  if (!ok) {
    loginStatus.textContent = "‚ùå No tienes permisos de verificador.";
    await supabase.auth.signOut();
    return;
  }
  loginStatus.textContent = "";
  showScanner(data.user);
}

async function onLogout(){
  try { await supabase.auth.signOut(); } catch {}
  stopScanner();
  showLogin();
}

async function checkIsAdmin(user){
  // Preferimos app_metadata.role; como respaldo leemos profiles.role o profiles.is_staff
  if (user?.app_metadata?.role === 'admin') return true;
  try{
    const { data: profile } = await supabase.from("profiles").select("role,is_staff").eq("user_id", user.id).maybeSingle();
    return (profile?.role === 'admin' || profile?.is_staff === true);
  }catch{ return false; }
}

function startScanner(){
  if (QR) { try{ QR.stop(); }catch{} QR = null; }
  QR = new Html5Qrcode("reader");
  QR.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 260 },
    async (decoded) => { await onScan(decoded); },
    (err) => { /* onScanFailure: silenciar */ }
  ).catch(err=>{
    document.getElementById("result").innerHTML = `<span class='err'>‚ùå No se pudo iniciar la c√°mara: ${err}</span>`;
  });
}
function stopScanner(){
  try { QR?.stop(); } catch {}
}

async function onScan(decoded){
  const resultEl = document.getElementById("result");
  try{
    const data = JSON.parse(decoded);
    const evt = data.event;
    const usr = data.user;
    if (!evt || !usr) { resultEl.innerHTML = "<span class='err'>‚ùå QR inv√°lido</span>"; return; }

    // Registrar el check-in (attendance_scans)
    const me = (await supabase.auth.getUser())?.data?.user;
    const { error: insErr } = await supabase.from("attendance_scans").insert({
      event_uid: evt,
      attendee_id: usr,
      scanned_by: me?.id || null,
      scanned_at: new Date().toISOString(),
      raw: data
    });
    if (insErr) {
      resultEl.innerHTML = `<span class='err'>‚ùå No se pudo registrar: ${insErr.message}</span>`;
      return;
    }

    // (Opcional) Actualiza rsvps a checked_in si usas esa tabla
    try{
      await supabase.from("rsvps")
        .update({ status: "checked_in", updated_at: new Date().toISOString() })
        .eq("user_id", usr)
        .eq("event_uid", evt);
    }catch{}

    resultEl.innerHTML = `<span class='ok'>‚úÖ Asistencia registrada correctamente</span>`;
    // Peque√±o cooldown para evitar dobles lecturas
    stopScanner();
    setTimeout(()=> startScanner(), 600);
  }catch(e){
    resultEl.innerHTML = "<span class='err'>‚ùå QR inv√°lido</span>";
  }
}
</script>
</body>
</html>