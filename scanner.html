<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Esc√°ner de Asistencia ‚Äî Unidad en Acci√≥n</title>
<link rel="icon" href="https://github.com/ChronosBVRX/InnovacionSindical/blob/main/Logo%20Unidad%20en%20Accion.png?raw=true">
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{ --bg:#0b1022; --panel:#101a33; --txt:#e6fbff; --muted:#9fdcf0; --pri:#5bd7f2; --sky:#60a5fa; --ring:rgba(91,215,242,.35); }
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto;min-height:100vh;margin:0}
  h2{color:var(--pri);margin:16px 0;text-align:center}
  #wrap{max-width:680px;margin:0 auto;padding:20px}
  #loginBox{display:grid;gap:10px;max-width:360px;margin:16px auto}
  input,select{padding:10px;border-radius:8px;border:1px solid var(--ring);background:var(--panel);color:var(--txt)}
  button{padding:10px;background:linear-gradient(90deg,var(--pri),var(--sky));border:none;border-radius:8px;color:#072133;font-weight:600;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .meta{font-size:13px;color:var(--muted);margin-top:8px}
  .ok{color:#80ff9b}
  .err{color:#ff8080}
  #scannerBox{display:none}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;max-width:360px;margin:0 auto 8px}

  /* Contenedor con altura fija: clave para iframes/pesta√±as */
  #reader{
    width:min(560px,94vw);
    height:420px;
    margin:16px auto;
    border:1px solid rgba(91,215,242,.3);
    border-radius:12px;overflow:hidden;
    background:rgba(255,255,255,.03);
    position:relative;
  }
  /* Forzar <video>/<canvas> visibles */
  #reader video, #reader canvas, #reader img {
    position:absolute; inset:0;
    width:100% !important; height:100% !important;
    display:block !important; visibility:visible !important; opacity:1 !important;
    object-fit:cover;
  }
  #result{min-height:20px}
</style>
</head>
<body>
  <div id="wrap">
    <h2>üéüÔ∏è Esc√°ner de Asistencia</h2>

    <div id="loginBox">
      <input id="email" type="email" placeholder="Correo de verificador" autocomplete="username">
      <input id="password" type="password" placeholder="Contrase√±a" autocomplete="current-password">
      <button id="btnLogin">Iniciar sesi√≥n</button>
      <div id="loginStatus" class="meta"></div>
      <div id="secureHint" class="meta"></div>
    </div>

    <div id="scannerBox">
      <div class="row">
        <select id="cameraSelect" title="Selecciona c√°mara"></select>
        <button id="btnSwitch">Cambiar</button>
      </div>
      <div class="meta">Apunta la c√°mara al c√≥digo QR</div>
      <div id="reader"></div>
      <div id="result" class="meta"></div>
      <div id="scanStatus" class="meta"></div>
      <button id="btnLogout">Cerrar sesi√≥n</button>
    </div>
  </div>

<script>
/* ===== Supabase ===== */
const SUPABASE_URL = "https://axsncdwshdvsysrpikwj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c25jZHdzaGR2c3lzcnBpa3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjkwMjQsImV4cCI6MjA3NTgwNTAyNH0.oapcH219puVjaR2DcG7dX51uhwVn530L1hhz8ASv7qs";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== UI ===== */
const loginBox     = document.getElementById("loginBox");
const scannerBox   = document.getElementById("scannerBox");
const loginStatus  = document.getElementById("loginStatus");
const secureHint   = document.getElementById("secureHint");
const readerElem   = document.getElementById("reader");
const cameraSelect = document.getElementById("cameraSelect");
const resultEl     = document.getElementById("result");
const scanStatus   = document.getElementById("scanStatus");

let reader = null;
let currentCameraId = null;
let lastOkAt = 0;
let resizeObs = null;

/* HTTPS aviso */
secureHint.textContent = (location.protocol === "https:" || location.hostname === "localhost")
  ? "" : "‚ö†Ô∏è Abre esta p√°gina por HTTPS (o en localhost) para usar la c√°mara.";

/* ===== Login ===== */
document.getElementById("btnLogin").onclick = async () => {
  try {
    loginStatus.textContent = "Verificando credenciales‚Ä¶";
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) throw error;

    const user = data.user;
    const role = user?.app_metadata?.role;
    if (role !== "admin") {
      await supabase.auth.signOut();
      loginStatus.textContent = "‚ùå No tienes permisos de verificador.";
      return;
    }

    loginBox.style.display = "none";
    scannerBox.style.display = "block";
    await setupAndStartScanner();
  } catch (e) {
    console.error(e);
    loginStatus.textContent = "‚ùå " + (e?.message || e);
  }
};

document.getElementById("btnLogout").onclick = async () => {
  await supabase.auth.signOut();
  await stopScanner();
  loginBox.style.display = "grid";
  scannerBox.style.display = "none";
  loginStatus.textContent = "";
};

/* ===== Util ===== */
function isVisible(el){
  const s = getComputedStyle(el);
  if (s.display === "none" || s.visibility === "hidden" || +s.opacity === 0) return false;
  const r = el.getBoundingClientRect(); return r.width>0 && r.height>0;
}
function waitForVisible(el, timeout=3000){
  return new Promise(res=>{
    if (isVisible(el)) return res();
    const t0 = performance.now();
    const iv = setInterval(()=>{
      if (isVisible(el) || performance.now()-t0>timeout){ clearInterval(iv); res(); }
    }, 100);
  });
}

/* ===== Scanner ===== */
async function setupAndStartScanner(preferredId=null){
  scanStatus.textContent = "Buscando c√°maras‚Ä¶";
  try{
    const devices = await Html5Qrcode.getCameras();
    if(!devices?.length){ scanStatus.innerHTML = "‚ùå No se detectaron c√°maras."; return; }

    cameraSelect.innerHTML = "";
    devices.forEach((d,i)=>{
      const o = document.createElement("option");
      o.value = d.id; o.textContent = d.label || `C√°mara ${i+1}`;
      cameraSelect.appendChild(o);
    });

    let chosen = preferredId
      || devices.find(d => /back|rear|environment|trasera/i.test(d.label))?.id
      || devices[0].id;

    cameraSelect.value = chosen;
    currentCameraId = chosen;

    await waitForVisible(readerElem);
    await startScannerWith(chosen);

    if (resizeObs) resizeObs.disconnect();
    resizeObs = new ResizeObserver(async ()=>{
      if (!reader) return;
      await startScannerWith(currentCameraId);
    });
    resizeObs.observe(readerElem);
  }catch(e){
    console.error(e);
    scanStatus.innerHTML = "‚ùå Error obteniendo c√°maras: " + (e?.message || e);
  }
}

async function startScannerWith(cameraId){
  await stopScanner();
  reader = new Html5Qrcode("reader", { verbose:false });
  scanStatus.textContent = "Iniciando c√°mara‚Ä¶";

  const rect = readerElem.getBoundingClientRect();
  const side = Math.max(220, Math.min(380, Math.min(rect.width, rect.height)-24));
  const config = {
    fps: 10,
    qrbox: { width: side, height: side },
    rememberLastUsedCamera: true,
    aspectRatio: 1.0,
    experimentalFeatures: { useBarCodeDetectorIfSupported: true }
  };

  try{
    await reader.start(
      { deviceId: { exact: cameraId } },
      config,
      onScanSuccess,
      () => {}
    );
    scanStatus.innerHTML = "<span class='ok'>üì∑ C√°mara lista</span>";
  }catch(e){
    console.error(e);
    scanStatus.innerHTML = "‚ùå No se pudo iniciar la c√°mara: " + (e?.message || e);
  }
}

async function stopScanner(){
  if (!reader) return;
  try{ await reader.stop(); }catch{}
  try{ await reader.clear(); }catch{}
  reader = null;
}

document.getElementById("btnSwitch").onclick = async () => {
  const id = cameraSelect.value;
  currentCameraId = id;
  scanStatus.textContent = "Cambiando de c√°mara‚Ä¶";
  await startScannerWith(id);
};

/* ===== QR handler ===== */
async function onScanSuccess(decodedText){
  const now = Date.now();
  if (now - (window.__lastScan||0) < 1200) return;
  window.__lastScan = now;

  try{
    const data = JSON.parse(decodedText);
    const { user, event } = data;
    if (!user || !event) throw new Error("Faltan 'user' o 'event' en el QR.");

    const { error } = await supabase
      .from("rsvps")
      .update({ status: "checked_in", updated_at: new Date().toISOString() })
      .eq("user_id", user)
      .eq("event_uid", event);

    if (error) resultEl.innerHTML = `<span class='err'>‚ùå Error registrando: ${error.message}</span>`;
    else       resultEl.innerHTML = `<span class='ok'>‚úÖ Asistencia registrada</span>`;
  }catch(e){
    resultEl.innerHTML = `<span class='err'>‚ùå QR inv√°lido: ${(e?.message||e)}</span>`;
  }
}
</script>
</body>
</html>
