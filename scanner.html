<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Esc√°ner de Asistencia ‚Äî Unidad en Acci√≥n</title>
<link rel="icon" href="https://github.com/ChronosBVRX/InnovacionSindical/blob/main/Logo%20Unidad%20en%20Accion.png?raw=true">
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0b1022; --panel:#101a33; --ring:rgba(91,215,242,.35);
    --txt:#e6fbff; --muted:#aee9f7; --primary:#5bd7f2; --sky:#60a5fa;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  body{min-height:100vh;background:linear-gradient(180deg,#0b1220,#0b1022);color:var(--txt);display:flex;flex-direction:column;padding:18px}
  h2{color:#5bd7f2;margin-bottom:12px}
  .wrap{max-width:560px;margin:0 auto}
  .card{background:var(--panel);border:1px solid rgba(91,215,242,.25);border-radius:16px;padding:16px;box-shadow:0 8px 25px rgba(0,0,0,.25)}
  #reader{width:100%;max-width:460px;margin:12px auto;border:1px solid rgba(91,215,242,.3);border-radius:12px;overflow:hidden}
  input{padding:10px;border-radius:10px;border:1px solid rgba(91,215,242,.35);background:#101a33;color:#e6fbff}
  button{padding:10px;background:linear-gradient(90deg,#5bd7f2,#60a5fa);border:none;border-radius:10px;color:#072133;font-weight:700;cursor:pointer}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .meta{font-size:13px;color:#9fdcf0;margin-top:8px}
  .ok{color:#80ff9b}
  .err{color:#ff8080}

  /* Barra de sesi√≥n compacta cuando ya est√°s logueado */
  #statusBar{display:none; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px}
  #statusBar .info{font-size:14px;color:#cfefff}
  #statusBar .btn{padding:8px 12px;border-radius:10px;background:rgba(255,80,80,.15);border:1px solid rgba(255,100,100,.35);color:#ffd1d1}
  #statusBar .btn:hover{background:#ff5555;color:#fff}
</style>
</head>
<body>
  <div class="wrap">
    <h2>üîé Esc√°ner de Asistencia</h2>

    <!-- Barra de estado (solo visible si hay sesi√≥n) -->
    <div id="statusBar" class="card row">
      <div class="info" id="who">Conectado como: ‚Äî</div>
      <div class="row" style="margin-left:auto">
        <button id="btnLogout" class="btn">Cerrar sesi√≥n</button>
      </div>
    </div>

    <!-- LOGIN (se muestra solo sin sesi√≥n) -->
    <div id="loginCard" class="card" style="display:none">
      <div class="row" style="flex-direction:column;gap:10px;width:100%">
        <input id="email" type="email" placeholder="Correo de verificador" style="width:100%">
        <input id="password" type="password" placeholder="Contrase√±a" style="width:100%">
        <button id="btnLogin" style="width:100%">Iniciar sesi√≥n</button>
        <div id="loginStatus" class="meta"></div>
      </div>
    </div>

    <!-- SCANNER (solo con sesi√≥n admin) -->
    <div id="scannerCard" class="card" style="margin-top:16px; display:none">
      <div class="meta">Apunta la c√°mara al c√≥digo QR del asistente</div>
      <div id="reader"></div>
      <div id="result" class="meta"></div>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://axsncdwshdvsysrpikwj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c25jZHdzaGR2c3lzcnBpa3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjkwMjQsImV4cCI6MjA3NTgwNTAyNH0.oapcH219puVjaR2DcG7dX51uhwVn530L1hhz8ASv7qs";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession: true, autoRefreshToken: true } });

/* UI refs */
const statusBar  = document.getElementById("statusBar");
const who        = document.getElementById("who");
const loginCard  = document.getElementById("loginCard");
const loginMsg   = document.getElementById("loginStatus");
const scannerCard= document.getElementById("scannerCard");
let QR=null;

/* events */
document.getElementById("btnLogin").onclick  = onLogin;
document.getElementById("btnLogout").onclick = onLogout;

/* boot */
init();

async function init(){
  await supabase.auth.refreshSession();
  const { data: { session } } = await supabase.auth.getSession();
  if (session && await isAdmin(session.user)) {
    showSessionUI(session.user);
    startScanner();
  } else {
    showLoginUI();
  }
}

function showSessionUI(user){
  // Barra compacta
  statusBar.style.display = 'flex';
  who.textContent = `Conectado como: ${user.email} ‚Ä¢ rol: ${user.app_metadata?.role || '‚Äî'}`;

  // Ocultar login y mostrar scanner
  loginCard.style.display   = 'none';
  scannerCard.style.display = 'block';
}
function showLoginUI(){
  statusBar.style.display   = 'none';
  scannerCard.style.display = 'none';
  loginCard.style.display   = 'block';
}

async function onLogin(){
  loginMsg.textContent = "Verificando credenciales‚Ä¶";
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error){ loginMsg.textContent = "‚ùå " + error.message; return; }
  if (!await isAdmin(data.user)){
    loginMsg.textContent = "‚ùå No tienes permisos de verificador.";
    await supabase.auth.signOut();
    return;
  }
  loginMsg.textContent = "";
  showSessionUI(data.user);
  startScanner();
}

async function onLogout(){
  try { await supabase.auth.signOut(); } catch {}
  stopScanner();
  showLoginUI();
}

async function isAdmin(user){
  if (user?.app_metadata?.role === 'admin') return true;
  try{
    const { data: profile } = await supabase
      .from("profiles").select("role,is_staff")
      .eq("user_id", user.id).maybeSingle();
    return (profile?.role === 'admin' || profile?.is_staff === true);
  }catch { return false; }
}

/* ===== Scanner ===== */
function startScanner(){
  if (QR) { try { QR.stop(); } catch {} QR = null; }
  QR = new Html5Qrcode("reader");
  QR.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 260 },
    async (decoded) => { await onScan(decoded); },
    () => {}
  ).catch(err=>{
    document.getElementById("result").innerHTML = `<span class='err'>‚ùå No se pudo iniciar la c√°mara: ${err}</span>`;
  });
}
function stopScanner(){ try { QR?.stop(); } catch {} }

async function onScan(decoded){
  const resultEl = document.getElementById("result");
  try{
    const data = JSON.parse(decoded);           // { event, user, ... }
    const evt = data.event, usr = data.user;
    if (!evt || !usr){ resultEl.innerHTML = "<span class='err'>‚ùå QR inv√°lido</span>"; return; }

    const me = (await supabase.auth.getUser())?.data?.user;

    // Inserta check-in
    const { error: insErr } = await supabase.from("attendance_scans").insert({
      event_uid: evt,
      attendee_id: usr,
      scanned_by: me?.id || null,
      scanned_at: new Date().toISOString(),
      raw: data
    });
    if (insErr){ resultEl.innerHTML = `<span class='err'>‚ùå No se pudo registrar: ${insErr.message}</span>`; return; }

    // (Opcional) marca rsvps
    try{
      await supabase.from("rsvps")
        .update({ status: "checked_in", updated_at: new Date().toISOString() })
        .eq("user_id", usr).eq("event_uid", evt);
    }catch{}

    resultEl.innerHTML = `<span class='ok'>‚úÖ Asistencia registrada correctamente</span>`;
    stopScanner(); setTimeout(startScanner, 600); // cooldown anti doble lectura
  }catch{ resultEl.innerHTML = "<span class='err'>‚ùå QR inv√°lido</span>"; }
}
</script>
</body>
</html>