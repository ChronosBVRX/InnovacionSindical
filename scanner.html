<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Esc√°ner de Asistencia ‚Äî Unidad en Acci√≥n</title>
<link rel="icon" href="https://github.com/ChronosBVRX/InnovacionSindical/blob/main/Logo%20Unidad%20en%20Accion.png?raw=true">
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body{background:#0b1022;color:#e6fbff;font-family:system-ui,-apple-system,Segoe UI,Roboto;text-align:center;padding:20px}
  h2{color:#5bd7f2;margin-bottom:10px}
  #reader{width:320px;margin:20px auto;border:1px solid rgba(91,215,242,.3);border-radius:10px;overflow:hidden}
  #loginBox{display:grid;gap:10px;max-width:320px;margin:40px auto}
  input{padding:10px;border-radius:8px;border:1px solid rgba(91,215,242,.35);background:#101a33;color:#e6fbff}
  button{padding:10px;background:linear-gradient(90deg,#5bd7f2,#60a5fa);border:none;border-radius:8px;color:#072133;font-weight:600;cursor:pointer}
  .meta{font-size:13px;color:#9fdcf0;margin-top:10px}
  .ok{color:#80ff9b}
  .err{color:#ff8080}
</style>
</head>
<body>
<h2>üéüÔ∏è Esc√°ner de Asistencia</h2>

<div id="loginBox">
  <input id="email" type="email" placeholder="Correo de verificador">
  <input id="password" type="password" placeholder="Contrase√±a">
  <button id="btnLogin">Iniciar sesi√≥n</button>
  <div id="loginStatus" class="meta"></div>
</div>

<div id="scannerBox" style="display:none">
  <div class="meta">Apunta la c√°mara al c√≥digo QR</div>
  <div id="reader"></div>
  <div id="result" class="meta"></div>
  <button id="btnLogout">Cerrar sesi√≥n</button>
</div>

<script>
const SUPABASE_URL = "https://axsncdwshdvsysrpikwj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c25jZHdzaGR2c3lzcnBpa3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjkwMjQsImV4cCI6MjA3NTgwNTAyNH0.oapcH219puVjaR2DcG7dX51uhwVn530L1hhz8ASv7qs";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const loginBox = document.getElementById("loginBox");
const scannerBox = document.getElementById("scannerBox");
const loginStatus = document.getElementById("loginStatus");
const readerElem = document.getElementById("reader");
let reader;

document.getElementById("btnLogin").onclick = async () => {
  loginStatus.textContent = "Verificando credenciales...";
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) { loginStatus.textContent = "‚ùå " + error.message; return; }

  const user = data.user;
  const { data: profile } = await supabase.from("profiles").select("is_staff").eq("user_id", user.id).single();
  if (!profile?.is_staff) {
    loginStatus.textContent = "‚ùå No tienes permisos de verificador.";
    await supabase.auth.signOut();
    return;
  }

  loginBox.style.display = "none";
  scannerBox.style.display = "block";
  startScanner();
};

document.getElementById("btnLogout").onclick = async () => {
  await supabase.auth.signOut();
  stopScanner();
  loginBox.style.display = "grid";
  scannerBox.style.display = "none";
  loginStatus.textContent = "";
};

function startScanner() {
  reader = new Html5Qrcode("reader");
  reader.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    async (decoded) => { await handleQR(decoded); }
  );
}

function stopScanner() {
  try { reader?.stop(); } catch {}
}

async function handleQR(decoded) {
  const resultEl = document.getElementById("result");
  try {
    const data = JSON.parse(decoded);
    const { user, event } = data;
    const { error } = await supabase.from("rsvps")
      .update({ status: "checked_in", updated_at: new Date().toISOString() })
      .eq("user_id", user)
      .eq("event_uid", event);

    if (error) {
      resultEl.innerHTML = `<span class='err'>‚ùå Error: ${error.message}</span>`;
    } else {
      resultEl.innerHTML = `<span class='ok'>‚úÖ Asistencia registrada correctamente</span>`;
    }
  } catch (e) {
    resultEl.innerHTML = "<span class='err'>‚ùå QR inv√°lido</span>";
  }
}
</script>
</body>
</html>
