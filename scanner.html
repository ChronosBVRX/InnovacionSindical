<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Esc√°ner de Asistencia ‚Äî Unidad en Acci√≥n</title>
<link rel="icon" href="https://github.com/ChronosBVRX/InnovacionSindical/blob/main/Logo%20Unidad%20en%20Accion.png?raw=true">
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{ --bg:#0b1022; --panel:#101a33; --txt:#e6fbff; --muted:#9fdcf0; --pri:#5bd7f2; --sky:#60a5fa; }
  body{background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto;text-align:center;padding:20px}
  h2{color:var(--pri);margin-bottom:10px}
  #loginBox{display:grid;gap:10px;max-width:340px;margin:24px auto}
  input,select{padding:10px;border-radius:8px;border:1px solid rgba(91,215,242,.35);background:var(--panel);color:var(--txt)}
  button{padding:10px;background:linear-gradient(90deg,var(--pri),var(--sky));border:none;border-radius:8px;color:#072133;font-weight:600;cursor:pointer}
  .meta{font-size:13px;color:var(--muted);margin-top:10px}
  .ok{color:#80ff9b}
  .err{color:#ff8080}
  #scannerBox{max-width:520px;margin:0 auto;display:none}
  #reader{width:min(480px,92vw);min-height:320px;margin:16px auto;border:1px solid rgba(91,215,242,.3);border-radius:10px;overflow:hidden}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;max-width:340px;margin:0 auto}
</style>
</head>
<body>
<h2>üéüÔ∏è Esc√°ner de Asistencia</h2>

<div id="loginBox">
  <input id="email" type="email" placeholder="Correo de verificador" autocomplete="username">
  <input id="password" type="password" placeholder="Contrase√±a" autocomplete="current-password">
  <button id="btnLogin">Iniciar sesi√≥n</button>
  <div id="loginStatus" class="meta"></div>
  <div class="meta" id="secureHint"></div>
</div>

<div id="scannerBox">
  <div class="row">
    <select id="cameraSelect" title="Selecciona c√°mara"></select>
    <button id="btnSwitch">Cambiar</button>
  </div>
  <div class="meta">Apunta la c√°mara al c√≥digo QR</div>
  <div id="reader"></div>
  <div id="result" class="meta"></div>
  <button id="btnLogout">Cerrar sesi√≥n</button>
  <div id="scanStatus" class="meta"></div>
</div>

<script>
/* ====== Supabase ====== */
const SUPABASE_URL = "https://axsncdwshdvsysrpikwj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c25jZHdzaGR2c3lzcnBpa3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjkwMjQsImV4cCI6MjA3NTgwNTAyNH0.oapcH219puVjaR2DcG7dX51uhwVn530L1hhz8ASv7qs";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ====== UI refs ====== */
const loginBox     = document.getElementById("loginBox");
const scannerBox   = document.getElementById("scannerBox");
const loginStatus  = document.getElementById("loginStatus");
const secureHint   = document.getElementById("secureHint");
const readerElem   = document.getElementById("reader");
const cameraSelect = document.getElementById("cameraSelect");
const resultEl     = document.getElementById("result");
const scanStatus   = document.getElementById("scanStatus");

let reader = null;
let currentCameraId = null;

/* ====== HTTPS hint ====== */
secureHint.textContent = (location.protocol === "https:" || location.hostname === "localhost")
  ? "" : "‚ö†Ô∏è Para usar la c√°mara necesitas servir esta p√°gina en HTTPS o en localhost.";

/* ====== Auth flow ====== */
document.getElementById("btnLogin").onclick = async () => {
  loginStatus.textContent = "Verificando credenciales‚Ä¶";
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) { loginStatus.innerHTML = "‚ùå " + error.message; return; }

  // Verifica rol
  const user = data.user;
  const { data: profile, error: pErr } = await supabase
      .from("profiles").select("is_staff").eq("user_id", user.id).single();

  if (pErr) { loginStatus.innerHTML = "‚ùå " + pErr.message; await supabase.auth.signOut(); return; }
  if (!profile?.is_staff) {
    loginStatus.textContent = "‚ùå No tienes permisos de verificador.";
    await supabase.auth.signOut();
    return;
  }

  loginBox.style.display = "none";
  scannerBox.style.display = "block";
  await setupAndStartScanner();
};

document.getElementById("btnLogout").onclick = async () => {
  await supabase.auth.signOut();
  await stopScanner();
  loginBox.style.display = "grid";
  scannerBox.style.display = "none";
  loginStatus.textContent = "";
};

/* ====== C√°mara / Scanner ====== */
async function setupAndStartScanner(preferredId = null) {
  scanStatus.textContent = "Buscando c√°maras‚Ä¶";
  try {
    const devices = await Html5Qrcode.getCameras();

    if (!devices || devices.length === 0) {
      scanStatus.innerHTML = "‚ùå No se detectaron c√°maras.";
      return;
    }

    // Rellena selector
    cameraSelect.innerHTML = "";
    devices.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.label || `C√°mara ${cameraSelect.length + 1}`;
      cameraSelect.appendChild(opt);
    });

    // Elige trasera si existe
    let chosen = preferredId
      || devices.find(d => /back|rear|environment|trasera/i.test(d.label))?.id
      || devices[0].id;

    cameraSelect.value = chosen;
    currentCameraId = chosen;

    await startScannerWith(chosen);
  } catch (e) {
    scanStatus.innerHTML = "‚ùå Error obteniendo c√°maras: " + (e?.message || e);
  }
}

async function startScannerWith(cameraId) {
  // Asegura un lector limpio
  await stopScanner();

  reader = new Html5Qrcode("reader", { verbose: false });
  scanStatus.textContent = "Iniciando c√°mara‚Ä¶";

  const config = {
    fps: 10,
    qrbox: { width: Math.min(300, readerElem.clientWidth - 24), height: Math.min(300, readerElem.clientWidth - 24) },
    rememberLastUsedCamera: true,
    aspectRatio: 1.0,
    experimentalFeatures: { useBarCodeDetectorIfSupported: true }
  };

  try {
    await reader.start(
      { deviceId: { exact: cameraId } },  // ‚Üê cameraId expl√≠cito evita fallos con facingMode
      config,
      async (decodedText/*, decodedResult*/) => { await handleQR(decodedText); },
      (scanErr) => { /* errores de frames; silenciado para no saturar */ }
    );
    scanStatus.innerHTML = "<span class='ok'>üì∑ C√°mara lista</span>";
  } catch (e) {
    scanStatus.innerHTML = "‚ùå No se pudo iniciar la c√°mara: " + (e?.message || e);
  }
}

async function stopScanner() {
  if (reader) {
    try { await reader.stop(); } catch {}
    try { await reader.clear(); } catch {}
    reader = null;
  }
}

document.getElementById("btnSwitch").onclick = async () => {
  const id = cameraSelect.value;
  currentCameraId = id;
  scanStatus.textContent = "Cambiando de c√°mara‚Ä¶";
  await startScannerWith(id);
};

/* ====== Manejo de QR ====== */
let lastOkAt = 0;
async function handleQR(decoded) {
  // Anti-doble lectura en r√°faga
  const now = Date.now();
  if (now - lastOkAt < 1200) return;
  lastOkAt = now;

  try {
    const data = JSON.parse(decoded);
    const { user, event } = data;
    if (!user || !event) throw new Error("Faltan campos user/event en el QR");

    const { error } = await supabase.from("rsvps")
      .update({ status: "checked_in", updated_at: new Date().toISOString() })
      .eq("user_id", user)
      .eq("event_uid", event);

    if (error) {
      resultEl.innerHTML = `<span class='err'>‚ùå Error registrando: ${error.message}</span>`;
    } else {
      resultEl.innerHTML = `<span class='ok'>‚úÖ Asistencia registrada</span>`;
    }
  } catch (e) {
    resultEl.innerHTML = `<span class='err'>‚ùå QR inv√°lido: ${(e?.message||e)}</span>`;
  }
}
</script>
</body>
</html>
