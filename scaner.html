<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lector de Asistencia ‚Äî Unidad en Acci√≥n</title>
<style>
  :root{ --panel:#101a33; --txt:#e6fbff; --ok:#22c55e; --bad:#ef4444; --muted:#9fdcf0 }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#0b1220,#0b1022);
       color:var(--txt);display:grid;place-items:center;padding:16px}
  .card{width:min(720px,96vw);background:var(--panel);border:1px solid rgba(91,215,242,.25);
        border-radius:16px;padding:16px}
  h1{margin:0 0 12px}
  #video{width:100%;max-height:50vh;border-radius:12px;background:black}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .meta{color:var(--muted);font-size:13px}
  .badge{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.2)}
  .ok{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.4)}
  .bad{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.4)}
  button{appearance:none;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn{background:linear-gradient(90deg,#5bd7f2,#60a5fa);color:#072133;font-weight:700}
  .ghost{background:rgba(91,215,242,.12);color:#fff;border:1px solid rgba(91,215,242,.3)}
  pre{white-space:pre-wrap;background:rgba(0,0,0,.25);padding:8px;border-radius:8px;
      max-height:160px;overflow:auto}
</style>
</head>
<body>
  <div class="card">
    <h1>üì∑ Lector de Asistencia</h1>
    <div class="meta">Escanea el QR de ‚ÄúAsistir√©‚Äù del miembro. Requiere sesi√≥n de personal.</div>

    <video id="video" playsinline></video>
    <div class="row" style="margin-top:10px">
      <button id="btnStart" class="btn">Iniciar c√°mara</button>
      <button id="btnStop" class="ghost">Detener</button>
      <span id="status" class="meta"></span>
    </div>

    <div id="result" style="margin-top:12px;display:none">
      <div class="row">
        <span id="badge" class="badge">‚Äî</span>
        <div id="msg" class="meta"></div>
      </div>
      <pre id="info"></pre>
    </div>
  </div>

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script>
  const SUPABASE_URL = "https://axsncdwshdvsysrpikwj.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
  const LOGIN_URL = "login.html";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });
  const $ = id => document.getElementById(id);
  let stream = null, raf = null;
  const video = $("video");
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  async function ensureStaff(){
    const { data: { session } } = await supabase.auth.getSession();
    if(!session){ location.href = LOGIN_URL; return false; }
    const { data: me } = await supabase.from('profiles').select('is_staff').eq('user_id', session.user.id).maybeSingle();
    if(!me?.is_staff){ alert('Tu cuenta no tiene permisos de personal.'); return false; }
    return true;
  }

  async function start(){
    if(!(await ensureStaff())) return;
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream; await video.play(); loop();
      $("status").textContent = "C√°mara activa. Apunta al QR‚Ä¶";
    }catch(e){ $("status").textContent = "No se pudo abrir la c√°mara."; }
  }

  function stop(){
    if(raf) cancelAnimationFrame(raf);
    if(stream) stream.getTracks().forEach(t=>t.stop());
    $("status").textContent = "C√°mara detenida."; stream = null;
  }

  async function loop(){
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(img.data, img.width, img.height);
    if(code?.data){ await handleQR(code.data); stop(); return; }
    raf = requestAnimationFrame(loop);
  }

  function showResult(ok,msg,extra){
    $("result").style.display='block';
    $("badge").textContent = ok ? "V√ÅLIDO" : "NO V√ÅLIDO";
    $("badge").className = "badge " + (ok?"ok":"bad");
    $("msg").textContent = msg;
    $("info").textContent = extra || "";
  }

  async function handleQR(text){
    let payload;
    try{ payload = JSON.parse(text); }catch{ showResult(false,"QR no reconocido",text); return; }
    if(!payload?.event || !payload?.user){ showResult(false,"QR incompleto",text); return; }

    const { data: rsvp } = await supabase.from('rsvps')
      .select('user_id,event_uid,status,qr_payload')
      .eq('user_id', payload.user).eq('event_uid', payload.event)
      .maybeSingle();

    if(!rsvp || rsvp.status!=='yes' || rsvp.qr_payload!==text){
      showResult(false,"Confirmaci√≥n inv√°lida",JSON.stringify(rsvp,null,2)); return;
    }

    const { data: { session } } = await supabase.auth.getSession();
    const { error } = await supabase.from('attendances')
      .upsert({ user_id:payload.user, event_uid:payload.event, scanned_by:session.user.id },
              { onConflict:'user_id,event_uid' });

    if(error){ showResult(false,"Error al registrar",error.message); return; }
    showResult(true,"Asistencia registrada",JSON.stringify(payload,null,2));
  }

  $("btnStart").onclick=start;
  $("btnStop").onclick=stop;
  </script>
</body>
</html>