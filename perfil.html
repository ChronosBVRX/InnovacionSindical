<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plataforma Sindical CG ‚Äî Miembros</title>
  <link rel="icon"
    href="https://raw.githubusercontent.com/ChronosBVRX/InnovacionSindical/refs/heads/main/Logo%20SNTSS.jpeg">
  <style>
    :root {
      --bg: #1b2e45;
      --panel: #2e4f77;
      --ring: rgba(77, 161, 168, .45);
      --txt: #f0fdfa;
      --muted: #bce9eb;
      --primary: #4da1a8;
      --sky: #7ad1d6;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto
    }

    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #152336, #1b2e45);
      color: var(--txt);
      display: flex;
      flex-direction: column
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: rgba(30, 50, 80, .75);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(77, 161, 168, .35)
    }

    header img {
      height: 40px
    }

    header h1 {
      font-size: 18px;
      color: #dcfce7;
      display: flex;
      align-items: center;
      gap: 10px
    }

    #btnLogout {
      background: rgba(255, 90, 90, .15);
      color: #ffcccc;
      border: 1px solid rgba(255, 100, 100, .35);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer
    }

    #btnLogout:hover {
      background: #ff5555;
      color: #fff
    }

    main {
      flex: 1;
      display: flex;
      min-height: 0
    }

    nav {
      width: 240px;
      background: rgba(27, 46, 69, .85);
      border-right: 1px solid rgba(77, 161, 168, .25);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    nav button {
      appearance: none;
      border: none;
      background: rgba(77, 161, 168, .12);
      color: var(--txt);
      padding: 10px;
      border-radius: 10px;
      text-align: left;
      cursor: pointer;
      transition: .2s
    }

    nav button:hover,
    nav button.active {
      background: linear-gradient(90deg, var(--primary), var(--sky));
      color: #0f2638;
      font-weight: 600
    }

    section.content {
      flex: 1;
      padding: 20px;
      display: none;
      min-width: 0
    }

    section.content.active {
      display: block
    }

    .card {
      background: var(--panel);
      border: 1px solid rgba(77, 161, 168, .35);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, .25);
      animation: fade .4s ease
    }

    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(10px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    h2 {
      margin-bottom: 10px;
      color: #d1f5f7
    }

    p.muted {
      color: var(--muted)
    }

    .profile-info {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 10px;
      flex-wrap: wrap
    }

    .avatar {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: #233b5c;
      border: 1px solid var(--ring);
      display: grid;
      place-items: center;
      font-size: 28px;
      overflow: hidden
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover
    }

    .profile-data p {
      margin: 2px 0
    }

    form {
      display: grid;
      gap: 10px;
      max-width: 560px;
      margin-top: 10px
    }

    label {
      font-size: 13px;
      color: #bce9eb
    }

    input,
    textarea,
    select {
      background: #1b2e45;
      border: 1px solid rgba(77, 161, 168, .4);
      color: #f0fdfa;
      padding: 9px 11px;
      border-radius: 10px
    }

    textarea {
      min-height: 90px;
      resize: vertical
    }

    .btn {
      appearance: none;
      border: none;
      cursor: pointer;
      background: linear-gradient(90deg, var(--primary), var(--sky));
      color: #0f2638;
      font-weight: 600;
      padding: 10px 16px;
      border-radius: 12px;
      margin-top: 6px;
      transition: .2s
    }

    .btn:hover {
      filter: brightness(1.12)
    }

    .subtle-btn {
      appearance: none;
      border: 1px solid rgba(77, 161, 168, .28);
      background: rgba(77, 161, 168, .1);
      color: #fff;
      padding: 6px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px
    }

    .subtle-btn:hover {
      background: rgba(77, 161, 168, .25)
    }

    .meta {
      font-size: 12px;
      color: #8ccacdb6
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(77, 161, 168, .15);
      border: 1px solid rgba(77, 161, 168, .35);
      font-size: 12px;
      color: #d1f5f7
    }

    iframe {
      width: 100%;
      min-height: 600px;
      border: 0;
      border-radius: 12px
    }

    details.forum-toggle {
      margin-top: 16px
    }

    details.forum-toggle>summary {
      list-style: none;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(77, 161, 168, .15);
      border: 1px solid rgba(77, 161, 168, .28);
      font-weight: 600;
      color: #d1f5f7
    }

    details.forum-toggle[open]>summary {
      background: rgba(77, 161, 168, .25)
    }

    details.forum-toggle>summary::-webkit-details-marker {
      display: none
    }

    .rotate {
      transition: transform .2s ease
    }

    details[open] .rotate {
      transform: rotate(90deg)
    }

    .qr-card {
      display: grid;
      place-items: center;
      background: rgba(255, 255, 255, .05);
      border: 1px solid rgba(77, 161, 168, .25);
      border-radius: 12px;
      padding: 12px;
      width: 220px
    }

    .qr-card canvas {
      width: 196px !important;
      height: 196px !important
    }

    @keyframes fadeInSmall {
      from {
        opacity: .6;
        transform: translateY(4px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    @media (max-width:980px) {
      nav {
        width: 100%;
        flex-direction: row;
        position: sticky;
        top: 52px;
        z-index: 9;
        overflow: auto;
      }

      main {
        flex-direction: column
      }
    }

    .perfil-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .perfil-main {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .perfil-extra {
      flex: 1.3;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .perfil-extra-card {
      background: #233b5c;
      border: 1px solid rgba(77, 161, 168, .35);
      border-radius: 12px;
      padding: 10px 12px;
    }

    .perfil-extra-card h3 {
      margin: 0 0 6px;
      font-size: 14px;
      color: #d1f5f7;
    }

    #perfilQuoteText {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }

    #perfilQuoteTag {
      display: block;
      margin-top: 4px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: rgba(188, 233, 235, 0.85);
    }

    .btn-mini {
      margin-top: 8px;
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(77, 161, 168, .6);
      background: rgba(21, 35, 54, 0.9);
      color: #f0fdfa;
      cursor: pointer;
    }

    .btn-mini:hover {
      background: rgba(77, 161, 168, .25);
    }

    #perfilValorList,
    #perfilAccionesList {
      margin-left: 16px;
      font-size: 13px;
      color: var(--muted);
    }

    #perfilValorList li+li,
    #perfilAccionesList li+li {
      margin-top: 4px;
    }

    .perfil-empty-actions {
      font-size: 13px;
      color: #bbf7d0;
      margin-top: 4px;
    }

    .perfil-tag-acciones {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(248, 250, 252, .1);
      background: rgba(120, 53, 15, .5);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: #fed7aa;
      margin-bottom: 4px;
    }

    @media (min-width:980px) {
      .perfil-layout {
        flex-direction: row;
        align-items: flex-start;
      }
    }

    /* ====== DIAGNOSTICO ====== */
    .diag {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 200, 120, .35);
      background: rgba(255, 200, 120, .08);
      color: #ffe8c7;
      font-size: 12px;
      white-space: pre-wrap;
    }

    /* ESTILOS NUEVOS PARA ESCALAF√ìN */
    .escalafon-promo {
      margin-top: 16px;
      padding: 12px;
      border: 1px dashed var(--sky);
      border-radius: 12px;
      background: rgba(122, 209, 214, 0.05);
    }

    .blur-box {
      background: rgba(0, 0, 0, 0.2);
      padding: 10px;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      margin-top: 8px;
    }

    .blur-text {
      filter: blur(5px);
      user-select: none;
      font-size: 13px;
    }

    .promo-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(27, 46, 69, 0.85);
      text-align: center;
      padding: 5px;
    }

    .promo-overlay p {
      font-weight: 700;
      font-size: 13px;
      color: #fff;
      line-height: 1.3;
    }

    .promo-overlay span {
      color: var(--sky);
    }
  </style>
</head>

<body>
  <header>
    <h1>
      <img src="https://raw.githubusercontent.com/ChronosBVRX/InnovacionSindical/refs/heads/main/Logo%20SNTSS.jpeg"
        alt="Logo">
      Plataforma Sindical CG ‚Äî Miembros
    </h1>
    <button id="btnLogout">Cerrar sesi√≥n</button>
  </header>

  <main>
    <nav>
      <button class="tab active" data-tab="perfil">üë§ Perfil</button>
      <button class="tab" data-tab="miembros" id="tabMiembros">üë• Miembros</button>
      <button class="tab" data-tab="calendario">üìÖ Calendario</button>
      <button class="tab" data-tab="reservas">üóìÔ∏è Reservas</button>
      <button class="tab" data-tab="foro">üó£Ô∏è Foro</button>
      <button class="tab" data-tab="videollamadas">üìû Videollamadas</button>
      <button class="tab" data-tab="biblioteca">üìö Biblioteca</button>
      <button class="tab" data-tab="comite" id="tabComite" style="display:none">üèõÔ∏è Comit√©</button>
      <button class="tab" data-tab="scanner" id="tabScanner" style="display:none">üîé Scanner</button>
      <button class="tab" data-tab="personaliza">‚öôÔ∏è Personaliza tu perfil</button>
    </nav>

    <section id="perfil" class="content active">
      <div class="card">
        <div class="perfil-layout">
          <div class="perfil-main">
            <div>
              <h2>üëã Bienvenido</h2>
              <p class="muted">Esta es tu p√°gina de miembro dentro de la Plataforma Sindical CG</p>

              <div id="diagBox" class="diag" style="display:none;"></div>

              <div class="profile-info">
                <div class="avatar" id="userAvatar">üßë</div>
                <div class="profile-data">
                  <p><strong>Nombre:</strong> <span id="pfName">Cargando‚Ä¶</span></p>
                  <p><strong>Email:</strong> <span id="pfEmail">‚Äî</span></p>

                  <p><strong>Matr√≠cula:</strong> <span id="pfMatricula">‚Äî</span></p>

                  <p><strong>Tel√©fono:</strong> <span id="pfTelefono">‚Äî</span></p>
                  <p class="meta" id="pfTelefonoVis" style="margin-top:4px"></p>
                  <p><strong>Cumplea√±os:</strong> <span id="pfCumple">‚Äî</span></p>
                  <p><strong>Categor√≠a:</strong> <span id="pfCategoria">‚Äî</span></p>
                  <p><strong>Adscripci√≥n:</strong> <span id="pfAdscripcion">‚Äî</span></p>
                  <p style="margin-top:8px"><strong>Servicios / habilidades:</strong></p>
                  <p id="pfServicios" class="muted">‚Äî</p>

                  <div class="escalafon-promo">
                    <p class="meta"><strong>Estatus de Tr√°mites y Escalaf√≥n:</strong></p>
                    <p class="meta" style="font-size: 11px; margin-bottom: 4px;">Si tienes cambio de rama, ampliaci√≥n de jornada, cambio de adscripci√≥n o turno, aqu√≠ aparecer√° tu lugar:</p>
                    <div class="blur-box">
                      <div class="blur-text">
                        Lugar en escalaf√≥n: #12 de 145 solicitudes<br>
                        Tr√°mite: Cambio de adscripci√≥n - HGR1<br>
                        Estatus: En revisi√≥n por subcomisi√≥n
                      </div>
                      <div class="promo-overlay">
                        <p>A partir del 16 de abril, <br><span>vota por la planilla azul</span> <br>para hacerlo realidad</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card" id="asistenciaResumen"
              style="margin-top:20px; background:#233b5c; animation:fadeInSmall .2s ease">
              <h3>üìä Asistencia y recompensas</h3>
              <div id="asistData" class="meta" style="margin-bottom:8px">Cargando tus datos...</div>
              <div class="row" style="flex-wrap:wrap;gap:20px">
                <div>
                  <div class="meta">Eventos asistidos (temporada)</div>
                  <div id="asistTotal" style="font-size:26px;font-weight:700">0</div>
                </div>
                <div>
                  <div class="meta">Racha actual (d√≠as)</div>
                  <div id="asistRacha" style="font-size:26px;font-weight:700">0</div>
                </div>
                <div>
                  <div class="meta">Puntos</div>
                  <div id="asistPuntos" style="font-size:26px;font-weight:700">0</div>
                </div>
                <div>
                  <div class="meta">Posici√≥n en ranking</div>
                  <div id="asistTop" style="font-size:26px;font-weight:700">‚Äî</div>
                </div>
              </div>
            </div>

            <div class="card" id="miniTop" style="margin-top:12px; background:#233b5c; animation:fadeInSmall .2s ease">
              <h3>üèÜ Top de asistencia </h3>
              <div id="miniTopMeta" class="meta" style="margin-top:6px">Cargando‚Ä¶</div>
              <div id="miniTopList" style="margin-top:10px;display:grid;gap:8px"></div>
            </div>

            <div class="card" id="perfilQRCard" style="margin-top:12px; background:#233b5c; animation:fadeInSmall .2s ease">
              <h3>‚úÖ Pr√≥ximo QR de verificaci√≥n</h3>
              <p class="muted" style="margin-top:6px">
                Aqu√≠ aparecer√° el pr√≥ximo QR para verificar tu asistencia al pr√≥ximo evento sindical.
                Confirma tu asistencia para generarlo.
              </p>

              <div id="eventBox" class="meta" style="margin-top:10px">Buscando el pr√≥ximo evento‚Ä¶</div>

              <div id="rsvpBox" style="margin-top:12px; display:none">
                <div class="row">
                  <button class="btn" id="btnYes">‚úîÔ∏è Asistir√©</button>
                  <button class="subtle-btn" id="btnNo">‚úñÔ∏è No asistir√©</button>
                  <span class="meta" id="rsvpStatus"></span>
                </div>

                <div id="qrWrap" style="margin-top:12px; display:none">
                  <div class="qr-card"><canvas id="qrCanvas" aria-label="C√≥digo QR"></canvas></div>
                  <div class="meta" style="margin-top:6px">Muestra este QR al llegar.</div>
                </div>
              </div>

              <div id="adminRSVPPanel" class="perfil-extra-card" style="margin-top:16px; display:none;">
                <h3>üìä Confirmaciones de asistencia (solo admins)</h3>
                <p class="meta" id="adminRSVPText">Cargando‚Ä¶</p>

                <div id="adminRSVPListWrap" style="margin-top:8px; display:none;">
                  <p class="meta" style="margin-bottom:4px;">Personas que confirmaron:</p>
                  <ul id="adminRSVPList"
                    style="margin:0 0 4px 18px; padding:0; font-size:13px; color:var(--muted); list-style:disc;"></ul>
                  <p class="meta" id="adminRSVPMore" style="display:none;"></p>
                </div>
              </div>
            </div>
          </div>

          <aside class="perfil-extra">
            <div class="perfil-extra-card">
              <h3>üí¨ Frase para el equipo</h3>
              <p id="perfilQuoteText">Cargando frase‚Ä¶</p>
              <small id="perfilQuoteTag"></small>
              <button type="button" class="btn-mini" onclick="cambiarFrasePerfil()">Otra frase</button>
            </div>

            <div class="perfil-extra-card">
              <h3>‚≠ê Valor para tu labor sindical</h3>
              <ul id="perfilValorList"></ul>
            </div>

            <div class="perfil-extra-card">
              <span class="perfil-tag-acciones">Pr√≥ximas acciones</span>
              <h3>Lo que puedes completar de tu perfil</h3>
              <p class="meta" style="margin:4px 0 6px;">
                Solo ver√°s lo que hace falta. Cuando completes un dato, desaparecer√° de esta lista.
              </p>
              <ul id="perfilAccionesList"></ul>
              <p id="perfilAccionesEmpty" class="perfil-empty-actions" style="display:none;">
                ‚úÖ Tu perfil est√° completo. Gracias por mantener tus datos actualizados.
              </p>
            </div>
          </aside>
        </div>
      </div>
    </section>

    <section id="miembros" class="content">
      <div class="card">
        <h2>üë• Directorio de Miembros (Solo Admin)</h2>
        <div class="row" style="margin-top:6px">
          <input id="qMembers" placeholder="Buscar por nombre, adscripci√≥n o servicios" style="min-width:260px">
          <button class="subtle-btn" id="btnRefreshMembers">Actualizar</button>
          <label class="row" style="gap:8px;align-items:center;margin-left:auto">
            <input type="checkbox" id="chkOnlineOnly"><span>üëÅÔ∏è Solo online</span>
          </label>
        </div>
        <div id="membersList" style="margin-top:14px;display:grid;gap:12px"></div>
      </div>
    </section>

    <section id="calendario" class="content">
      <div class="card">
        <h2>üìÖ Calendario de Actividades</h2>
        <iframe
          src="https://calendar.google.com/calendar/embed?src=redunidadenaccion%40gmail.com&ctz=America%2FMexico_City&showTitle=0&showPrint=0&showTz=0&showCalendars=0"></iframe>
      </div>
    </section>

    <section id="reservas" class="content">
      <div class="card">
        <h2>üóìÔ∏è Reservas</h2>
        <p class="muted">Gestiona y consulta reservas desde esta pesta√±a.</p>
        <iframe src="reservas.html"
          style="width:100%;min-height:650px;border:0;border-radius:12px;margin-top:12px" loading="lazy"></iframe>
      </div>
    </section>

    <section id="foro" class="content">
      <div class="card">
        <h2>üó£Ô∏è Foro de Miembros</h2>
        <div id="postsList" class="" style="display:grid;gap:12px"></div>
        <details class="forum-toggle" id="newPostToggle">
          <summary><span class="rotate">‚ñ∏</span><span>Crear una publicaci√≥n</span></summary>
          <form id="forumForm" style="margin-top:12px">
            <label>Escribe una publicaci√≥n (m√°x. 500 caracteres)</label>
            <textarea id="forumInput" maxlength="500"
              placeholder="¬øQu√© quieres compartir con la comunidad?"></textarea>
            <div class="row">
              <label style="font-size:13px">Categor√≠a</label>
              <select id="forumCategory">
                <option>Avisos</option>
                <option selected>Asuntos Generales</option>
                <option>Convivencia</option>
              </select>
            </div>
            <button class="btn" type="submit">‚ûï Publicar</button>
            <div class="status meta" id="forumStatus"></div>
          </form>
        </details>
      </div>
    </section>

    <section id="videollamadas" class="content">
      <div class="card">
        <h2>üìû Videollamadas</h2>
        <p class="muted">Realiza videollamadas 1 a 1 con otros miembros desde esta misma plataforma.</p>
        <iframe src="videollamadas.html"
          style="width:100%;min-height:650px;border:0;border-radius:12px;margin-top:12px" loading="lazy"></iframe>
      </div>
    </section>

    <section id="biblioteca" class="content">
      <div class="card">
        <h2>üìö Biblioteca de Recursos</h2>
        <p class="muted">Consulta y explora materiales digitales de la Plataforma Sindical CG.</p>
        <iframe src="biblioteca.html"
          style="width:100%;min-height:650px;border:0;border-radius:12px;margin-top:12px" loading="lazy"></iframe>
      </div>
    </section>
    
    <section id="comite" class="content">
      <div class="card">
        <h2>üèõÔ∏è Gesti√≥n del Comit√© Seccional</h2>
        <p class="muted">Asigna a los integrantes, modifica sus datos y sube su fotograf√≠a oficial de campa√±a.</p>
        <div id="comiteList" style="margin-top:14px;display:grid;gap:12px"></div>
      </div>
    </section>

    <section id="personaliza" class="content">
      <div class="card">
        <h2>‚öôÔ∏è Edita tu informaci√≥n</h2>
        <div class="row" style="margin-top:10px">
          <div class="avatar" id="avatarPreview">üßë</div>
          <div>
            <label>Foto de perfil (PNG/JPG/WebP, m√°x 2MB)</label>
            <input type="file" id="fAvatar" accept="image/png,image/jpeg,image/webp">
            <div class="meta">Se previsualiza al seleccionar; se sube al guardar.</div>
          </div>
        </div>

        <form id="editForm">
          <label>Nombre completo</label><input id="fNombre" placeholder="Tu nombre completo">

          <label>Matr√≠cula</label><input id="fMatricula" placeholder="Ej. 12345678" inputmode="numeric">

          <label>Tel√©fono</label><input id="fTelefono" placeholder="Ej. 5532120000">
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="fTelefonoPublico">
            <span>Mostrar mi n√∫mero de tel√©fono a otros miembros</span>
          </label>
          <label>Fecha de cumplea√±os</label><input id="fCumple" type="date">
          <label>Categor√≠a</label><input id="fCategoria" placeholder="Ej. Enfermera General A">

          <label>Adscripci√≥n (Michoac√°n)</label>
          <select id="fAdscripcion" required>
            <option value="">Seleccione una adscripci√≥n</option>
            <optgroup label="R√©gimen Ordinario ‚Äî Hospitales Generales Regionales (HGR)">
              <option value="HGR No. 1 Charo (Morelia)">HGR No. 1 Charo (Morelia)</option>
            </optgroup>
            <optgroup label="R√©gimen Ordinario ‚Äî Hospitales Generales de Zona (HGZ) y Subzona (HGSZ)">
              <option value="HGZ No. 83 Morelia (Camelinas)">HGZ No. 83 Morelia (Camelinas)</option>
              <option value="HGZ No. 8 Uruapan">HGZ No. 8 Uruapan</option>
              <option value="HGZ No. 4 Zamora">HGZ No. 4 Zamora</option>
              <option value="HGZ No. 12 L√°zaro C√°rdenas">HGZ No. 12 L√°zaro C√°rdenas</option>
              <option value="HGZ No. 2 Zacapu">HGZ No. 2 Zacapu</option>
              <option value="HGSZ No. 7 La Piedad">HGSZ No. 7 La Piedad</option>
              <option value="HGSZ No. 9 Apatzing√°n">HGSZ No. 9 Apatzing√°n</option>
              <option value="HGSZ No. 17 Los Reyes">HGSZ No. 17 Los Reyes</option>
              <option value="HGSZ No. 24 Pedernales">HGSZ No. 24 Pedernales</option>
            </optgroup>
            <optgroup label="R√©gimen Ordinario ‚Äî Unidades de Medicina Familiar (UMF)">
              <option value="UMF No. 3 Quiroga">UMF No. 3 Quiroga</option>
              <option value="UMF No. 6 Jiquilpan">UMF No. 6 Jiquilpan</option>
              <option value="UMF No. 10 Jungapeo">UMF No. 10 Jungapeo</option>
              <option value="UMF No. 11 Nueva Italia">UMF No. 11 Nueva Italia</option>
              <option value="UMF No. 13 Cotija">UMF No. 13 Cotija</option>
              <option value="UMF No. 18 Zit√°cuaro">UMF No. 18 Zit√°cuaro</option>
              <option value="UMF No. 19 Ciudad Hidalgo">UMF No. 19 Ciudad Hidalgo</option>
              <option value="UMF No. 20 P√°tzcuaro">UMF No. 20 P√°tzcuaro</option>
              <option value="UMF No. 21 Jacona">UMF No. 21 Jacona</option>
              <option value="UMF No. 23 Infiernillo">UMF No. 23 Infiernillo</option>
              <option value="UMF No. 25 Puruar√°n">UMF No. 25 Puruar√°n</option>
              <option value="UMF No. 26 Taretan">UMF No. 26 Taretan</option>
              <option value="UMF No. 28 Santa Clara">UMF No. 28 Santa Clara</option>
              <option value="UMF No. 37 Mineral de Angangueo">UMF No. 37 Mineral de Angangueo</option>
              <option value="UMF No. 40 Coalcom√°n">UMF No. 40 Coalcom√°n</option>
              <option value="UMF No. 42 Cuitzeo">UMF No. 42 Cuitzeo</option>
              <option value="UMF No. 43 Churumuco">UMF No. 43 Churumuco</option>
              <option value="UMF No. 46 La Huacana">UMF No. 46 La Huacana</option>
              <option value="UMF No. 48 Huetamo">UMF No. 48 Huetamo</option>
              <option value="UMF No. 52 Nuevo Urecho">UMF No. 52 Nuevo Urecho</option>
              <option value="UMF No. 54 Pur√©pero">UMF No. 54 Pur√©pero</option>
              <option value="UMF No. 64 Puru√°ndiro">UMF No. 64 Puru√°ndiro</option>
              <option value="UMF No. 65 Villa Madero">UMF No. 65 Villa Madero</option>
              <option value="UMF No. 66 Villamar">UMF No. 66 Villamar</option>
              <option value="UMF No. 70 Zinap√©cuaro">UMF No. 70 Zinap√©cuaro</option>
              <option value="UMF No. 71 Morelia">UMF No. 71 Morelia</option>
              <option value="UMF No. 74 Tac√°mbaro">UMF No. 74 Tac√°mbaro</option>
              <option value="UMF No. 75 Morelia (Camelinas)">UMF No. 75 Morelia (Camelinas)</option>
              <option value="UMF No. 76 Uruapan">UMF No. 76 Uruapan</option>
              <option value="UMF No. 77 La Piedad">UMF No. 77 La Piedad</option>
              <option value="UMF No. 78 L√°zaro C√°rdenas">UMF No. 78 L√°zaro C√°rdenas</option>
              <option value="UMF No. 80 Morelia (Centro)">UMF No. 80 Morelia (Centro)</option>
              <option value="UMF No. 81 Uruapan">UMF No. 81 Uruapan</option>
              <option value="UMF No. 82 Zamora">UMF No. 82 Zamora</option>
              <option value="UMF No. 84 Morelia (Tac√≠cuaro)">UMF No. 84 Morelia (Tac√≠cuaro)</option>
              <option value="UMF No. 85 Tar√≠mbaro">UMF No. 85 Tar√≠mbaro</option>
            </optgroup>
            <optgroup label="IMSS-Bienestar ‚Äî Hospitales Rurales (HR)">
              <option value="HR No. 30 Ario de Rosales">HR No. 30 Ario de Rosales</option>
              <option value="HR No. 31 Huetamo">HR No. 31 Huetamo</option>
              <option value="HR No. 33 Paracho">HR No. 33 Paracho</option>
              <option value="HR No. 35 Buenavista Tomatl√°n">HR No. 35 Buenavista Tomatl√°n</option>
              <option value="HR No. 50 Tuxpan">HR No. 50 Tuxpan</option>
              <option value="HR No. 51 Villamar">HR No. 51 Villamar</option>
              <option value="HR No. 59 Coalcom√°n">HR No. 59 Coalcom√°n</option>
            </optgroup>
          </select>

          <label>Biograf√≠a corta</label><textarea id="fBio" placeholder="Cu√©ntanos algo breve"></textarea>
          <label>Servicios / habilidades que ofreces</label>
          <textarea id="fServicios"
            placeholder="Ej. Asesor√≠a jur√≠dica, apoyo en organizaci√≥n de eventos, dise√±o gr√°fico, etc."></textarea>
          <button class="btn" type="submit">üíæ Guardar cambios</button>
          <div class="status meta" id="status"></div>
        </form>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <script>
    /* ====== Config ====== */
    const SUPABASE_URL = "https://axsncdwshdvsysrpikwj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c25jZHdzaGR2c3lzcnBpa3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjkwMjQsImV4cCI6MjA3NTgwNTAyNH0.oapcH219puVjaR2DcG7dX51uhwVn530L1hhz8ASv7qs";
    const LOGIN_URL = "login.html";
    const SCANNER_REDIRECT_URL = "https://chronosbvrx.github.io/InnovacionSindical/scanner";
    const GOOGLE_API_KEY = "AIzaSyDdtYPPE-jTvw_Gypxrq2c5UePpbK9ZxZ0";
    const CALENDAR_ID = "redunidadenaccion@gmail.com";

    /* ====== Cliente ====== */
    const supabaseClient = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY,
      { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
    );

    const $ = (id) => document.getElementById(id);

    let CURRENT_USER = null, IS_ADMIN = false, MEMBERS_CACHE = [], ONLINE_SET = new Set();
    let COMITE_CACHE = []; // NUEVO: Para guardar cach√© del comit√©

    /* ====== Debounce / Tokens ====== */
    const debounce = (fn, ms = 200) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
    let POSTS_TOKEN = 0;

    /* ====== DIAGNOSTICO ====== */
    function diag(msg, extra) {
      console.log("[DIAG]", msg, extra || "");
      const box = $("diagBox");
      if (!box) return;
      box.style.display = "block";
      box.textContent = String(msg) + (extra ? "\n\n" + (typeof extra === "string" ? extra : JSON.stringify(extra, null, 2)) : "");
    }

    function clearDiag() {
      const box = $("diagBox");
      if (!box) return;
      box.style.display = "none";
      box.textContent = "";
    }

    /* ====== Tabs ====== */
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll(".tab").forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const id = btn.dataset.tab;

          if (id === 'scanner') {
            if (!IS_ADMIN) { alert('Necesitas rol admin para acceder al Scanner.'); return; }
            window.location.assign(SCANNER_REDIRECT_URL);
            return;
          }

          if (id === 'miembros' && !IS_ADMIN) {
            alert('Solo administradores pueden ver el directorio.');
            return;
          }

          if (id === 'comite' && !IS_ADMIN) {
            alert('Solo administradores pueden editar el comit√©.');
            return;
          }

          document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));

          btn.classList.add('active');
          $(id).classList.add('active');

          location.hash = id;

          if (id === 'miembros') renderMembers();
          if (id === 'foro') loadPostsDeb();
          if (id === 'comite') loadComite(); // Carga de comit√© al dar click
        });
      });

      $("btnLogout").addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        location.href = LOGIN_URL;
      });

      $("btnRefreshMembers")?.addEventListener('click', () => loadMembers(true));
      $("qMembers")?.addEventListener('input', () => renderMembers());
      $("chkOnlineOnly")?.addEventListener('change', () => renderMembers());
      $("editForm")?.addEventListener('submit', onSaveProfile);
      $("fAvatar")?.addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (f) {
          const u = URL.createObjectURL(f);
          $("avatarPreview").innerHTML = `<img src="${u}">`;
        }
      });

      initApp();
    });

    /* ====== App init ====== */
    async function initApp() {
      clearDiag();

      // 1) sesi√≥n
      const { data: { session }, error: sessErr } = await supabaseClient.auth.getSession();
      if (sessErr) diag("Error obteniendo sesi√≥n (auth.getSession).", sessErr);

      if (!session) {
        diag("No hay sesi√≥n activa. Se redirige a login.html");
        location.href = LOGIN_URL;
        return;
      }

      CURRENT_USER = session.user;
      IS_ADMIN = false;

      // Bootstrap profiles
      await ensureProfileRow();

      // 2) cargar datos
      await loadProfile();
      initPerfilExtras();

      if (IS_ADMIN) {
        await loadMembers(true);
        await loadComite(); // Carga anticipada del comit√© para administradores
      }

      initPresence();
      initForum();
      await initVerification();

      // 3) tabs hash
      const wanted = (location.hash || '#perfil').slice(1);

      if (wanted === 'verificacion') {
        (document.querySelector('.tab[data-tab="perfil"]'))?.click();
        return;
      }

      if (wanted === 'scanner') {
        if (IS_ADMIN) window.location.replace(SCANNER_REDIRECT_URL);
        else (document.querySelector('.tab[data-tab="perfil"]'))?.click();
      } else if (wanted === 'miembros' && !IS_ADMIN) {
        (document.querySelector('.tab[data-tab="perfil"]'))?.click();
      } else if (wanted === 'comite' && !IS_ADMIN) {
        (document.querySelector('.tab[data-tab="perfil"]'))?.click();
      } else {
        (document.querySelector(`.tab[data-tab="${wanted}"]`) || document.querySelector('.tab[data-tab="perfil"]'))?.click();
      }
    }

    /* ====== PASO 4 (Bootstrap profiles) ====== */
    async function ensureProfileRow() {
      if (!CURRENT_USER?.id) return;
      try {
        const { data: prof, error } = await supabaseClient.from('profiles').select('user_id').eq('user_id', CURRENT_USER.id).maybeSingle();
        if (error) diag("Error consultando profiles (ensureProfileRow).", error);
        if (prof?.user_id) return;

        const md = CURRENT_USER.user_metadata || {};
        const display_name = (md.display_name || md.nombre || '').toString().trim() || null;
        const telefono = (md.telefono || md.phone || '').toString().trim() || null;
        const matricula = (md.matricula || md.matr√≠cula || '').toString().trim() || null;

        let cumple = md.cumple || md.birthdate || null;
        if (cumple) {
          try {
            const d = new Date(String(cumple).length <= 10 ? String(cumple) + "T00:00:00" : String(cumple));
            cumple = d.toISOString().slice(0, 10);
          } catch { }
        }

        const categoria = (md.categoria || '').toString().trim() || null;
        const adscripcion = (md.adscripcion || '').toString().trim() || null;
        const avatar_url = (md.avatar_url || null);

        const payload = {
          user_id: CURRENT_USER.id,
          display_name, matricula, telefono, telefono_publico: (md.telefono_publico === true),
          cumple, categoria, adscripcion, avatar_url, bio: (md.bio || null), servicios: (md.servicios || null),
          role: 'miembro', last_seen: new Date().toISOString()
        };

        const { error: insErr } = await supabaseClient.from('profiles').insert(payload);
        if (insErr) diag("No se pudo CREAR el profile (probable RLS).", insErr);
      } catch (e) {
        diag("Error inesperado en ensureProfileRow()", e);
      }
    }

    /* ====== Helpers ====== */
    function formatDateISOtoMX(iso) {
      if (!iso) return "‚Äî";
      try {
        const d = new Date(iso.length <= 10 ? iso + "T00:00:00" : iso);
        return new Intl.DateTimeFormat('es-MX', { day: '2-digit', month: 'long', year: 'numeric' }).format(d);
      } catch { return iso; }
    }
    const nz = (v) => { if (v == null) return null; const t = String(v).trim(); return t === "" ? null : t; };
    function escapeHtml(str) {
      return (str || '').replace(/[&<>"']/g, s => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[s]));
    }

    /* ====== Upload avatar ====== */
    async function uploadAvatar(file) {
      if (!file) return null;
      if (!['image/png', 'image/jpeg', 'image/webp'].includes(file.type)) { alert("Formato no soportado"); return null; }
      if (file.size > 2 * 1024 * 1024) { alert("M√°x 2MB"); return null; }

      const uid = CURRENT_USER.id;
      const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
      const path = `${uid}/${Date.now()}.${ext}`;

      const { error } = await supabaseClient.storage.from("avatars").upload(path, file, {
        cacheControl: "3600", upsert: false, contentType: file.type
      });

      if (error) {
        diag("No se pudo subir la imagen al bucket 'avatars'.", error);
        alert("No se pudo subir la imagen (revisa que exista el bucket y su policy).");
        return null;
      }
      const { data } = supabaseClient.storage.from("avatars").getPublicUrl(path);
      return data?.publicUrl || null;
    }

    /* ====== Gesti√≥n del Comit√© ====== */
    async function loadComite() {
      if (!IS_ADMIN) return;
      const wrap = $("comiteList");
      if (!wrap) return;
      
      wrap.innerHTML = '<div class="meta">Cargando estructura del comit√©...</div>';

      const { data, error } = await supabaseClient
        .from('comite')
        .select('*')
        .order('id', { ascending: true }); 

      if (error) {
        wrap.innerHTML = '<div class="meta">‚ùå Error cargando comit√©.</div>';
        console.error(error);
        return;
      }
      COMITE_CACHE = data || [];
      renderComite();
    }

    function renderComite() {
      const wrap = $("comiteList");
      if (!wrap) return;
      wrap.innerHTML = '';
      
      if (!COMITE_CACHE.length) {
        wrap.innerHTML = '<div class="meta">No hay carteras registradas en la base de datos.</div>';
        return;
      }

      COMITE_CACHE.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card';
        const fotoHtml = item.foto 
          ? `<img src="${item.foto}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` 
          : `üßë`;

        card.innerHTML = `
          <div class="row" style="align-items:flex-start">
            <div class="avatar" style="width:64px;height:64px;background:#152336">${fotoHtml}</div>
            <div style="flex:1;min-width:220px">
              <div style="font-weight:800; color:var(--sky)">${escapeHtml(item.cartera)}</div>
              <div class="meta">${escapeHtml(item.area)}</div>
              
              <div class="meta" style="margin-top:6px">üë§ ${escapeHtml(item.nombre || 'Vacante')}</div>
              <div class="meta">ü™™ ${escapeHtml(item.categoria || 'Sin categor√≠a')}</div>
              <div class="meta">üè• ${escapeHtml(item.unidad || 'Sin unidad')}</div>

              <button class="subtle-btn btn-edit-comite" data-id="${item.id}" style="margin-top:10px">‚úèÔ∏è Editar Candidato</button>

              <div class="edit-comite-box" data-id="${item.id}" style="display:none;margin-top:10px;background:rgba(0,0,0,0.15);padding:12px;border-radius:8px;border:1px solid rgba(77, 161, 168, .35)">
                <label style="display:block;margin-bottom:4px;font-size:12px;color:var(--muted)">Foto del Candidato (PNG/JPG):</label>
                <input type="file" class="c-foto" accept="image/png,image/jpeg,image/webp" style="width:100%;margin-bottom:10px">
                
                <input class="c-nombre" placeholder="Nombre completo" value="${escapeHtml(item.nombre || '')}" style="width:100%;margin-bottom:8px">
                <input class="c-cat" placeholder="Categor√≠a (Ej. M√©dico No Familiar)" value="${escapeHtml(item.categoria || '')}" style="width:100%;margin-bottom:8px">
                <input class="c-uni" placeholder="Adscripci√≥n (Ej. HGZ 83)" value="${escapeHtml(item.unidad || '')}" style="width:100%;margin-bottom:10px">

                <div class="row" style="gap:10px">
                  <button class="btn btn-save-comite" data-id="${item.id}">üíæ Guardar en DB</button>
                  <button class="subtle-btn btn-cancel-comite" data-id="${item.id}">Cancelar</button>
                  <span class="meta c-status"></span>
                </div>
              </div>
            </div>
          </div>
        `;
        wrap.appendChild(card);
      });

      wrap.querySelectorAll('.btn-edit-comite, .btn-cancel-comite').forEach(b => {
        b.onclick = () => {
          const box = wrap.querySelector(`.edit-comite-box[data-id="${b.dataset.id}"]`);
          if(box) box.style.display = box.style.display === 'none' ? 'block' : 'none';
        };
      });

      wrap.querySelectorAll('.btn-save-comite').forEach(b => {
        b.onclick = async () => {
          const id = b.dataset.id;
          const box = wrap.querySelector(`.edit-comite-box[data-id="${id}"]`);
          if (!box) return;
          const statusEl = box.querySelector('.c-status');
          statusEl.textContent = 'Guardando...';

          const fileInput = box.querySelector('.c-foto');
          let fotoUrl = COMITE_CACHE.find(c => c.id == id)?.foto || null;

          if (fileInput.files.length > 0) {
             statusEl.textContent = 'Subiendo imagen...';
             const uploadedUrl = await uploadAvatar(fileInput.files[0]);
             if (uploadedUrl) fotoUrl = uploadedUrl;
          }

          const updates = {
            nombre: box.querySelector('.c-nombre').value.trim() || null,
            categoria: box.querySelector('.c-cat').value.trim() || null,
            unidad: box.querySelector('.c-uni').value.trim() || null,
            foto: fotoUrl
          };

          const { error } = await supabaseClient.from('comite').update(updates).eq('id', id);

          if (error) {
            statusEl.textContent = '‚ùå Error al guardar';
            diag("Error actualizando comit√©", error);
          } else {
            statusEl.textContent = '‚úÖ Actualizado';
            await loadComite();
          }
        };
      });
    }

    /* ====== Perfil ====== */
    async function loadProfile() {
      try {
        $("pfEmail").textContent = CURRENT_USER.email || "‚Äî";

        const { data: prof, error } = await supabaseClient
          .from('profiles')
          .select('display_name, avatar_url, categoria, adscripcion, bio, cumple, telefono, telefono_publico, servicios, role, matricula')
          .eq('user_id', CURRENT_USER.id)
          .maybeSingle();

        if (error) diag("Error leyendo tabla 'profiles'. (Probable RLS / policy)", error);

        const myRole = (prof?.role || 'miembro');
        IS_ADMIN = (myRole === 'admin');

        const tabMiembros = document.getElementById("tabMiembros");
        if (tabMiembros) tabMiembros.style.display = IS_ADMIN ? "" : "none";

        if (IS_ADMIN) {
          $("tabScanner").style.removeProperty('display');
          $("tabComite").style.removeProperty('display'); // Mostrar tab Comit√© si es admin
        } else {
          $("tabScanner").style.display = "none";
          $("tabComite").style.display = "none";
        }

        const md = CURRENT_USER.user_metadata || {};
        const matriculaAny = prof?.matricula ?? md.matricula ?? md.matr√≠cula ?? null;
        $("pfMatricula").textContent = matriculaAny ? String(matriculaAny) : "‚Äî";

        const telRaw = prof?.telefono || md.telefono || md.phone || null;
        const telPublicFlag = (prof?.telefono_publico ?? md.telefono_publico) === true;
        const serviciosRaw = (prof?.servicios ?? md.servicios) || "";

        $("pfName").textContent = prof?.display_name || md.display_name || "Sin nombre";
        $("pfTelefono").textContent = telRaw || "‚Äî";
        if (!telRaw) {
          $("pfTelefonoVis").textContent = "No has capturado un n√∫mero de tel√©fono.";
        } else {
          $("pfTelefonoVis").textContent = telPublicFlag ? "Tu tel√©fono es visible para otros miembros." : "Tu tel√©fono NO es visible para otros miembros.";
        }

        const cumpleAny = prof?.cumple || md.cumple || md.birthdate || null;
        $("pfCumple").textContent = formatDateISOtoMX(cumpleAny);
        $("pfCategoria").textContent = (prof?.categoria ?? md.categoria) || "‚Äî";
        $("pfAdscripcion").textContent = (prof?.adscripcion ?? md.adscripcion) || "‚Äî";
        $("pfServicios").textContent = serviciosRaw.trim() || "‚Äî";

        const avatar = prof?.avatar_url || md.avatar_url;
        if (avatar) {
          $("userAvatar").innerHTML = `<img src="${avatar}" alt="avatar">`;
          $("avatarPreview").innerHTML = `<img src="${avatar}" alt="avatar">`;
        } else {
          const ini = (prof?.display_name || CURRENT_USER.email || "?")[0].toUpperCase();
          $("userAvatar").textContent = ini;
          $("avatarPreview").textContent = ini;
        }

        $("fNombre").value = prof?.display_name || md.display_name || "";
        $("fMatricula").value = matriculaAny ? String(matriculaAny) : "";
        $("fTelefono").value = telRaw || "";
        $("fTelefonoPublico").checked = !!telPublicFlag;

        try {
          const c = cumpleAny;
          if (c) {
            const d = new Date(String(c).length <= 10 ? String(c) + "T00:00:00" : String(c));
            $("fCumple").value = d.toISOString().slice(0, 10);
          }
        } catch { }

        $("fCategoria").value = prof?.categoria || md.categoria || "";
        $("fAdscripcion").value = prof?.adscripcion || md.adscripcion || "";
        $("fBio").value = prof?.bio || md.bio || "";
        $("fServicios").value = serviciosRaw || "";

        buildNextActionsFromProfile(telRaw, serviciosRaw.trim(), cumpleAny, matriculaAny);
        await loadAsistenciaPerfil();
        await loadMiniTopPerfil();
      } catch (e) {
        diag("Error inesperado en loadProfile()", e);
      }
    }

    /* ====== Guardar perfil (propio) ====== */
    async function onSaveProfile(e) {
      e.preventDefault();
      $("status").textContent = "Guardando‚Ä¶";

      try {
        const file = $("fAvatar").files?.[0];
        let avatar_url = null;
        if (file) avatar_url = await uploadAvatar(file);

        const rawCumple = $("fCumple").value;
        const cumple = nz(rawCumple) ? new Date(rawCumple).toISOString().slice(0, 10) : null;
        const mat = nz($("fMatricula").value);
        const matricula = mat ? String(mat).replace(/\s+/g, '') : null;

        const updates = {
          display_name: nz($("fNombre").value), matricula, telefono: nz($("fTelefono").value),
          telefono_publico: $("fTelefonoPublico").checked, cumple, categoria: nz($("fCategoria").value),
          adscripcion: nz($("fAdscripcion").value), bio: nz($("fBio").value), servicios: nz($("fServicios").value)
        };
        if (avatar_url) updates.avatar_url = avatar_url;

        const { error: authErr } = await supabaseClient.auth.updateUser({ data: updates });
        if (authErr) throw authErr;

        const { error: upErr } = await supabaseClient.from('profiles').upsert({
          user_id: CURRENT_USER.id, display_name: updates.display_name,
          avatar_url: updates.avatar_url || CURRENT_USER.user_metadata?.avatar_url || null,
          matricula: updates.matricula, telefono: updates.telefono, telefono_publico: updates.telefono_publico,
          cumple: updates.cumple, categoria: updates.categoria, adscripcion: updates.adscripcion,
          bio: updates.bio, servicios: updates.servicios, last_seen: new Date().toISOString()
        }, { onConflict: 'user_id' });

        if (upErr) {
          diag("Error haciendo upsert en 'profiles'.", upErr);
          $("status").textContent = "‚ùå Error al guardar en profiles.";
          return;
        }

        $("status").textContent = "‚úÖ Cambios guardados.";
        await loadProfile();
        await initVerification();
      } catch (e) {
        console.error(e);
        $("status").textContent = "‚ùå Ocurri√≥ un error guardando tu perfil.";
      }
    }

    /* ====== Miembros (solo admin) ====== */
    async function loadMembers(force = false) {
      if (!IS_ADMIN) return;
      if (!force && MEMBERS_CACHE.length) return;

      const wrap = $("membersList");
      if (wrap) wrap.innerHTML = '<div class="meta">Cargando miembros‚Ä¶</div>';

      const { data, error } = await supabaseClient
        .from('profiles')
        .select('user_id, display_name, avatar_url, categoria, adscripcion, last_seen, telefono, telefono_publico, servicios, role, matricula')
        .order('last_seen', { ascending: false }).limit(1000);

      if (error) {
        diag("Error cargando miembros.", error);
        if (wrap) wrap.innerHTML = '<div class="meta">‚ùå No se pudieron cargar los miembros.</div>';
        return;
      }
      MEMBERS_CACHE = data || [];
      renderMembers();
    }

    function renderMembers() {
      const wrap = $("membersList");
      if (!wrap) return;

      if (!IS_ADMIN) { wrap.innerHTML = '<div class="meta">Solo administradores.</div>'; return; }

      const q = ($("qMembers")?.value || "").trim().toLowerCase();
      const onlyOnline = $("chkOnlineOnly")?.checked;
      let list = MEMBERS_CACHE.slice();

      if (q) {
        list = list.filter(p => (p.display_name || '').toLowerCase().includes(q) || (p.adscripcion || '').toLowerCase().includes(q) ||
          (p.categoria || '').toLowerCase().includes(q) || (p.servicios || '').toLowerCase().includes(q) || String(p.matricula || '').toLowerCase().includes(q));
      }
      if (onlyOnline) list = list.filter(p => ONLINE_SET.has(p.user_id));

      const online = []; const offline = [];
      list.forEach(p => (ONLINE_SET.has(p.user_id) ? online : offline).push(p));
      list = [...online, ...offline];

      wrap.innerHTML = '';
      if (!list.length) { wrap.innerHTML = '<div class="meta">No se encontraron miembros.</div>'; return; }

      list.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        const dot = ONLINE_SET.has(p.user_id) ? 'üü¢ Online' : '‚ö™ Offline';
        const tel = (p.telefono || '').toString().trim();
        const telDisplay = !tel ? 'Sin tel√©fono' : (p.telefono_publico ? tel : 'No visible');
        const serviciosText = (p.servicios || '').trim();
        const matricula = (p.matricula || '').toString().trim();

        card.innerHTML = `
          <div class="row" style="align-items:flex-start">
            <div class="avatar" style="width:64px;height:64px">
              ${p.avatar_url ? `<img src="${p.avatar_url}">` : (escapeHtml(p.display_name || '?')[0] || '?').toUpperCase()}
            </div>
            <div style="flex:1;min-width:220px">
              <div class="row" style="justify-content:space-between;gap:10px;align-items:center">
                <div style="font-weight:800">${escapeHtml(p.display_name || '‚Äî')}</div>
                <span class="pill">üõ°Ô∏è ${escapeHtml(p.role || 'miembro')}</span>
              </div>
              <div class="meta">${escapeHtml(p.categoria || '‚Äî')} ‚Ä¢ ${escapeHtml(p.adscripcion || '‚Äî')}</div>
              <div class="meta" style="margin-top:4px">ü™™ Matr√≠cula: ${matricula ? escapeHtml(matricula) : '‚Äî'}</div>
              <div class="meta" style="margin-top:4px">üì± ${escapeHtml(telDisplay)}</div>
              ${serviciosText ? `<div class="meta" style="margin-top:4px">ü§ù ${escapeHtml(serviciosText)}</div>` : ''}
              <div class="row" style="margin-top:10px;gap:10px;align-items:center;justify-content:space-between">
                <span class="pill">${dot}</span>
                <button class="subtle-btn btn-edit-member" data-uid="${p.user_id}">‚úèÔ∏è Editar</button>
              </div>
              <div class="edit-member-box" data-uid="${p.user_id}" style="display:none;margin-top:10px">
                <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
                  <label class="meta">Rol</label>
                  <select class="m-role"><option value="miembro" ${p.role === 'miembro' ? 'selected' : ''}>miembro</option><option value="admin" ${p.role === 'admin' ? 'selected' : ''}>admin</option></select>
                </div>
                <div class="row" style="margin-top:8px;gap:10px;flex-wrap:wrap">
                  <input class="m-name" placeholder="Nombre" value="${escapeHtml(p.display_name || '')}">
                  <input class="m-mat" placeholder="Matr√≠cula" value="${escapeHtml(matricula)}" inputmode="numeric">
                </div>
                <div class="row" style="margin-top:8px;gap:10px;flex-wrap:wrap">
                  <input class="m-cat" placeholder="Categor√≠a" value="${escapeHtml(p.categoria || '')}">
                  <input class="m-ads" placeholder="Adscripci√≥n" value="${escapeHtml(p.adscripcion || '')}">
                </div>
                <div class="row" style="margin-top:8px;gap:10px;flex-wrap:wrap">
                  <input class="m-tel" placeholder="Tel√©fono" value="${escapeHtml(p.telefono || '')}">
                  <label class="row" style="gap:8px"><input type="checkbox" class="m-telpub" ${p.telefono_publico ? 'checked' : ''}><span class="meta">Tel√©fono p√∫blico</span></label>
                </div>
                <div style="margin-top:8px;display:grid;gap:8px"><textarea class="m-serv" placeholder="Servicios">${escapeHtml(p.servicios || '')}</textarea></div>
                <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap">
                  <button class="btn btn-save-member" data-uid="${p.user_id}">üíæ Guardar</button>
                  <button class="subtle-btn btn-cancel-member" data-uid="${p.user_id}">Cancelar</button>
                  <span class="meta m-status" style="margin-left:auto"></span>
                </div>
              </div>
            </div>
          </div>`;
        wrap.appendChild(card);
      });

      wrap.querySelectorAll('.btn-edit-member, .btn-cancel-member').forEach(b => {
        b.onclick = (e) => {
          e.preventDefault();
          const box = wrap.querySelector(`.edit-member-box[data-uid="${b.dataset.uid}"]`);
          if (box) box.style.display = (box.style.display === 'none' ? 'block' : 'none');
        };
      });

      wrap.querySelectorAll('.btn-save-member').forEach(b => {
        b.onclick = async (e) => {
          e.preventDefault();
          const uid = b.dataset.uid;
          const box = wrap.querySelector(`.edit-member-box[data-uid="${uid}"]`);
          if (!box) return;
          const statusEl = box.querySelector('.m-status');
          statusEl.textContent = 'Guardando‚Ä¶';
          const mat = nz(box.querySelector('.m-mat')?.value);
          const updates = {
            display_name: nz(box.querySelector('.m-name')?.value), matricula: mat ? String(mat).replace(/\s+/g, '') : null,
            categoria: nz(box.querySelector('.m-cat')?.value), adscripcion: nz(box.querySelector('.m-ads')?.value),
            telefono: nz(box.querySelector('.m-tel')?.value), telefono_publico: !!box.querySelector('.m-telpub')?.checked,
            servicios: nz(box.querySelector('.m-serv')?.value), role: box.querySelector('.m-role')?.value || 'miembro', last_seen: new Date().toISOString()
          };
          Object.keys(updates).forEach(k => { if (updates[k] === undefined) delete updates[k]; });
          const { error } = await supabaseClient.from('profiles').update(updates).eq('user_id', uid);
          if (error) { statusEl.textContent = '‚ùå Error'; return; }
          statusEl.textContent = '‚úÖ Guardado';
          await loadMembers(true);
        };
      });
    }

    /* ====== Presencia ====== */
    function initPresence() {
      try {
        const ch = supabaseClient.channel('presence:members', { config: { presence: { key: CURRENT_USER.id } } });
        ch.on('presence', { event: 'sync' }, () => {
          ONLINE_SET = new Set(Object.keys(ch.presenceState()));
          try { if (IS_ADMIN) renderMembers(); } catch { }
        });
        ch.subscribe(async (status) => {
          if (status === 'SUBSCRIBED') {
            ch.track({ last_active: Date.now() });
            await supabaseClient.from('profiles').update({ last_seen: new Date().toISOString() }).eq('user_id', CURRENT_USER.id);
          }
        });
      } catch (e) { diag("Error Presence.", e); }
    }

    /* ====== Foro ====== */
    const loadPostsDeb = debounce(loadPosts, 200);
    function initForum() {
      loadPostsDeb();
      supabaseClient.channel('realtime-foro').on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, loadPostsDeb).on('postgres_changes', { event: '*', schema: 'public', table: 'likes' }, loadPostsDeb).on('postgres_changes', { event: '*', schema: 'public', table: 'comments' }, loadPostsDeb).subscribe();
      $("forumForm")?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = ($("forumInput").value || '').trim();
        if (!text) return;
        $("forumStatus").textContent = "Publicando‚Ä¶";
        const { error } = await supabaseClient.from('posts').insert({ content: text, user_id: CURRENT_USER.id, category: $("forumCategory").value || "Asuntos Generales" });
        $("forumStatus").textContent = error ? "‚ùå Error" : "‚úÖ Publicado";
        if (!error) { $("forumInput").value = ""; loadPostsDeb(); }
      });
    }
    function fmtDate(iso) { try { return new Intl.DateTimeFormat('es-MX', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date(iso)); } catch { return iso; } }
    function canEditPost(postUserId) { return IS_ADMIN || (postUserId === CURRENT_USER.id); }
    function canDeletePost(postUserId) { return IS_ADMIN || (postUserId === CURRENT_USER.id); }
    function canDeleteComment(commentUserId) { return IS_ADMIN || (commentUserId === CURRENT_USER.id); }

    async function loadPosts() {
      const myToken = ++POSTS_TOKEN;
      const wrap = $("postsList");
      if (!document.getElementById('postsLoadingMsg')) wrap.prepend(Object.assign(document.createElement('div'), { id: 'postsLoadingMsg', className: 'meta', textContent: 'Cargando publicaciones‚Ä¶' }));
      const { data: posts, error } = await supabaseClient.from('posts').select('id, content, category, created_at, user_id').order('created_at', { ascending: false }).limit(50);
      if (myToken !== POSTS_TOKEN) return;
      wrap.innerHTML = "";
      if (error) { wrap.innerHTML = `<div class="meta">‚ùå Error cargando posts.</div>`; return; }
      if (!posts?.length) { wrap.innerHTML = `<div class="meta">A√∫n no hay publicaciones.</div>`; return; }

      const ids = posts.map(p => p.id);
      const [{ data: allLikes }, { data: myLikes }, { data: comments }] = await Promise.all([
        supabaseClient.from('likes').select('post_id, user_id').in('post_id', ids),
        supabaseClient.from('likes').select('post_id').in('post_id', ids).eq('user_id', CURRENT_USER.id),
        supabaseClient.from('comments').select('id, post_id, user_id, content, created_at').in('post_id', ids).order('created_at', { ascending: true })
      ]);
      if (myToken !== POSTS_TOKEN) return;

      const likeCount = new Map(); (allLikes || []).forEach(l => likeCount.set(l.post_id, (likeCount.get(l.post_id) || 0) + 1));
      const myLiked = new Set((myLikes || []).map(l => l.post_id));
      const commentsByPost = new Map(); (comments || []).forEach(c => { if (!commentsByPost.has(c.post_id)) commentsByPost.set(c.post_id, []); commentsByPost.get(c.post_id).push(c); });

      posts.forEach(p => {
        const card = document.createElement('div'); card.className = 'card'; card.dataset.postId = p.id;
        const count = likeCount.get(p.id) || 0; const postComments = commentsByPost.get(p.id) || [];
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:12px;align-items:center"><div class="meta">${p.user_id === CURRENT_USER.id ? 'T√∫' : 'Miembro'} ‚Ä¢ ${fmtDate(p.created_at)}</div><div class="pill">üè∑Ô∏è ${escapeHtml(p.category || 'Asuntos Generales')}</div></div>
          <div class="post-content" style="margin-top:8px;white-space:pre-wrap;line-height:1.45">${escapeHtml(p.content)}</div>
          <div class="row" style="margin-top:10px;gap:10px">
            <button class="subtle-btn btn-like" data-id="${p.id}" aria-pressed="${myLiked.has(p.id)}">${myLiked.has(p.id) ? '‚ù§Ô∏è' : 'ü§ç'} Me gusta <span class="meta">(${count})</span></button>
            <details class="forum-toggle" style="margin:0"><summary><span class="rotate">‚ñ∏</span><span>Comentarios (${postComments.length})</span></summary>
              <div class="comments" style="margin-top:10px; display:grid; gap:10px">
                ${postComments.map(c => `<div class="card" style="padding:12px"><div class="meta">${c.user_id === CURRENT_USER.id ? 'T√∫' : 'Miembro'} ‚Ä¢ ${fmtDate(c.created_at)}</div><div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(c.content)}</div>${canDeleteComment(c.user_id) ? `<button class="subtle-btn btn-del-comment" data-cid="${c.id}" data-pid="${p.id}">üóëÔ∏è Borrar</button>` : ``}</div>`).join('')}
                <form class="comment-form" data-id="${p.id}"><label class="meta">A√±adir comentario</label><textarea rows="2" class="comment-input" placeholder="Escribe algo..."></textarea><button class="btn" type="submit">Comentar</button><div class="meta comment-status"></div></form>
              </div>
            </details>
            ${canEditPost(p.user_id) ? `<button class="subtle-btn btn-edit" data-id="${p.id}">‚úèÔ∏è Editar</button>` : ``}
            ${canDeletePost(p.user_id) ? `<button class="subtle-btn btn-del-post" data-id="${p.id}">üóëÔ∏è Borrar</button>` : ``}
          </div>`;
        wrap.appendChild(card);
      });

      wrap.querySelectorAll('.btn-like').forEach(btn => btn.addEventListener('click', async (e) => {
        e.preventDefault(); e.stopPropagation(); const postId = btn.dataset.id; const isLiked = btn.getAttribute('aria-pressed') === 'true';
        btn.disabled = true;
        if (isLiked) {
          const { error } = await supabaseClient.from('likes').delete().match({ post_id: postId, user_id: CURRENT_USER.id });
          if (!error) { btn.setAttribute('aria-pressed', 'false'); btn.innerHTML = btn.innerHTML.replace('‚ù§Ô∏è', 'ü§ç'); }
        } else {
          const { error } = await supabaseClient.from('likes').upsert({ post_id: postId, user_id: CURRENT_USER.id }, { onConflict: 'post_id,user_id' });
          if (!error) { btn.setAttribute('aria-pressed', 'true'); btn.innerHTML = btn.innerHTML.replace('ü§ç', '‚ù§Ô∏è'); }
        }
        btn.disabled = false; loadPostsDeb();
      }));

      wrap.querySelectorAll('.comment-form').forEach(form => form.addEventListener('submit', async (e) => {
        e.preventDefault(); e.stopPropagation(); const text = (form.querySelector('.comment-input').value || '').trim(); if (!text) return;
        await supabaseClient.from('comments').insert({ post_id: form.dataset.id, user_id: CURRENT_USER.id, content: text });
        loadPostsDeb();
      }));

      wrap.querySelectorAll('.btn-edit').forEach(btn => btn.addEventListener('click', (e) => {
        e.preventDefault(); e.stopPropagation(); const card = btn.closest('.card'); const contentEl = card.querySelector('.post-content');
        contentEl.outerHTML = `<div class="edit-wrap" style="margin-top:8px;display:grid;gap:8px"><textarea class="edit-textarea" style="min-height:120px;background:#1b2e45;border:1px solid rgba(77, 161, 168, .3);color:#f0fdfa;padding:9px 11px;border-radius:10px">${contentEl.textContent}</textarea><div class="row"><button class="btn btn-save-edit" data-id="${btn.dataset.id}">üíæ Guardar</button><button class="subtle-btn btn-cancel-edit">Cancelar</button></div></div>`;
        card.querySelector('.btn-cancel-edit').addEventListener('click', () => loadPostsDeb());
        card.querySelector('.btn-save-edit').addEventListener('click', async () => {
          const newText = (card.querySelector('.edit-textarea').value || '').trim();
          if (newText) { await supabaseClient.from('posts').update({ content: newText }).eq('id', btn.dataset.id); loadPostsDeb(); }
        });
      }));

      wrap.querySelectorAll('.btn-del-post').forEach(btn => btn.addEventListener('click', async () => {
        if (confirm('¬øBorrar publicaci√≥n?')) { await supabaseClient.from('posts').delete().eq('id', btn.dataset.id); loadPostsDeb(); }
      }));

      wrap.querySelectorAll('.btn-del-comment').forEach(btn => btn.addEventListener('click', async () => {
        if (confirm('¬øBorrar comentario?')) { await supabaseClient.from('comments').delete().eq('id', btn.dataset.cid); loadPostsDeb(); }
      }));
    }

    /* ====== Verificaci√≥n (QR) ====== */
    function formatDateFancy(d) { try { return new Intl.DateTimeFormat('es-MX', { dateStyle: 'full', timeStyle: 'short' }).format(new Date(d)); } catch { return d; } }
    async function fetchNextEvent() {
      if (!GOOGLE_API_KEY) return null; const timeMin = new Date().toISOString();
      try {
        const res = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events?singleEvents=true&orderBy=startTime&timeMin=${encodeURIComponent(timeMin)}&maxResults=1&key=${encodeURIComponent(GOOGLE_API_KEY)}`);
        const evt = (await res.json()).items?.[0]; if (!evt) return null;
        return { uid: evt.id, title: evt.summary || 'Evento', start: evt.start?.dateTime || evt.start?.date, location: evt.location || '', description: (evt.description || '').replace(/<[^>]*>/g, '') };
      } catch { return null; }
    }
    async function initVerification() {
      if (!$("rsvpBox") || !$("eventBox")) return;
      $("rsvpBox").style.display = CURRENT_USER ? 'block' : 'none'; $("rsvpStatus").textContent = ''; $("qrWrap").style.display = 'none';
      if ($("adminRSVPPanel") && !IS_ADMIN) $("adminRSVPPanel").style.display = "none";
      const evt = await fetchNextEvent();
      if (!evt) { $("eventBox").textContent = "No hay eventos pr√≥ximos."; $("rsvpBox").style.display = 'none'; return; }
      $("eventBox").innerHTML = `<div><strong>${escapeHtml(evt.title)}</strong></div><div class="meta">üóìÔ∏è ${formatDateFancy(evt.start)} ${evt.location ? ' ‚Ä¢ üìç ' + escapeHtml(evt.location) : ''}</div>${evt.description ? `<div class="muted" style="white-space:pre-wrap;margin-top:6px">${escapeHtml(evt.description)}</div>` : ''}`;
      window.__NEXT_EVENT__ = evt;
      if (IS_ADMIN) loadAdminRSVPStats(evt.uid);
      const { data } = await supabaseClient.from('rsvps').select('status, qr_payload').eq('user_id', CURRENT_USER.id).eq('event_uid', evt.uid).maybeSingle();
      updateRSVPUI(data?.status || null, data?.qr_payload || null);
      $("btnYes").onclick = () => setRSVP('yes'); $("btnNo").onclick = () => setRSVP('no');
    }
    function buildQRPayload(evtUid) { return JSON.stringify({ v: 1, event: evtUid, user: CURRENT_USER.id, ts: Date.now() }); }
    async function setRSVP(status) {
      const evt = window.__NEXT_EVENT__; if (!evt) return;
      const qrPayload = status === 'yes' ? buildQRPayload(evt.uid) : null;
      await supabaseClient.from('rsvps').upsert({ user_id: CURRENT_USER.id, event_uid: evt.uid, status, qr_payload: qrPayload, updated_at: new Date().toISOString() }, { onConflict: 'user_id,event_uid' });
      $("rsvpStatus").textContent = status === 'yes' ? 'Confirmado ‚úîÔ∏è' : 'Registrado como no asistente.';
      updateRSVPUI(status, qrPayload); if (IS_ADMIN) loadAdminRSVPStats(evt.uid);
    }
    function updateRSVPUI(status, qrPayload) {
      const yesBtn = $("btnYes"), noBtn = $("btnNo");
      if (status === 'yes') { yesBtn.disabled = true; noBtn.disabled = false; $("qrWrap").style.display = 'block'; if (qrPayload) QRCode.toCanvas($("qrCanvas"), qrPayload, { errorCorrectionLevel: 'M' }).catch(() => { }); }
      else if (status === 'no') { yesBtn.disabled = false; noBtn.disabled = true; $("qrWrap").style.display = 'none'; }
      else { yesBtn.disabled = false; noBtn.disabled = false; $("qrWrap").style.display = 'none'; $("rsvpStatus").textContent = ''; }
    }
    async function loadAdminRSVPStats(evtUid) {
      if (!IS_ADMIN || !evtUid || !$("adminRSVPPanel")) return;
      $("adminRSVPPanel").style.display = "block"; $("adminRSVPText").textContent = "Cargando‚Ä¶";
      const { data, error } = await supabaseClient.from('rsvps').select('status, user_id').eq('event_uid', evtUid);
      if (error) { $("adminRSVPText").textContent = "‚ùå Error al cargar."; return; }
      const total = data.length; const siReg = data.filter(r => r.status === 'yes'); const si = siReg.length; const no = data.filter(r => r.status === 'no').length; const otros = total - si - no;
      $("adminRSVPText").textContent = `Confirmados: ${si} ‚úîÔ∏è ‚Ä¢ No asistir√°n: ${no} ‚úñÔ∏è ‚Ä¢ Registros totales: ${total}` + (otros > 0 ? ` ‚Ä¢ Otros estados: ${otros}` : '');
      if (!si) { $("adminRSVPListWrap").style.display = "none"; return; }
      const { data: perfiles } = await supabaseClient.from('profiles').select('user_id, display_name, categoria, adscripcion').in('user_id', siReg.map(r => r.user_id));
      const ordenados = [...(perfiles || [])].sort((a, b) => (a.display_name || '').localeCompare(b.display_name || '', 'es', { sensitivity: 'base' }));
      $("adminRSVPList").innerHTML = "";
      ordenados.slice(0, 15).forEach(p => { const li = document.createElement('li'); li.textContent = `${p.display_name || 'Sin nombre'} ‚Äî ${p.categoria || ''} ‚Ä¢ ${p.adscripcion || ''}`; $("adminRSVPList").appendChild(li); });
      $("adminRSVPMore").style.display = ordenados.length > 15 ? "block" : "none"; $("adminRSVPMore").textContent = `‚Ä¶y ${ordenados.length - 15} m√°s.`;
      $("adminRSVPListWrap").style.display = "block";
    }

    /* ====== Asistencia / ranking ====== */
    function seasonOf(dateLike) { const d = new Date(dateLike); return `${d.toLocaleString('en-CA', { timeZone: 'America/Mexico_City', year: 'numeric' })}-Q${Math.ceil(+d.toLocaleString('en-CA', { timeZone: 'America/Mexico_City', month: 'numeric' }) / 3)}`; }
    function fmtMX(iso) { try { return new Intl.DateTimeFormat('es-MX', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date(iso)); } catch { return iso; } }
    async function loadAsistenciaPerfil() {
      if (!CURRENT_USER) return;
      const { data: scans } = await supabaseClient.from('attendance_scans').select('event_uid, scanned_at').eq('attendee_id', CURRENT_USER.id).order('scanned_at', { ascending: false }).limit(200);
      if (!scans?.length) { $("asistData").textContent = "A√∫n no has registrado asistencias."; return; }
      $("asistData").textContent = `√öltimo check-in: ${fmtMX(scans[0].scanned_at)}`;
      const currentSeason = seasonOf(new Date());
      const totalTemporada = [...new Set(scans.filter(s => seasonOf(s.scanned_at) === currentSeason).map(s => s.scanned_at.slice(0, 10)))].length;
      let puntos = totalTemporada * 10, puesto = '‚Äî';
      try { const { data } = await supabaseClient.from('attendance_points').select('points').eq('user_id', CURRENT_USER.id).eq('season', currentSeason).maybeSingle(); if (data?.points != null) puntos = data.points; } catch { }
      try { const { data } = await supabaseClient.from('attendance_leaderboard').select('user_id').eq('season', currentSeason).order('points', { ascending: false }).limit(100); const pos = (data || []).findIndex(r => r.user_id === CURRENT_USER.id); if (pos >= 0) puesto = `#${pos + 1}`; } catch { }
      $("asistTotal").textContent = totalTemporada; $("asistPuntos").textContent = puntos; $("asistTop").textContent = puesto;
    }
    async function loadMiniTopPerfil() {
      if (!$("miniTopMeta") || !$("miniTopList")) return; $("miniTopMeta").textContent = 'Cargando‚Ä¶'; $("miniTopList").innerHTML = '';
      const { data } = await supabaseClient.from('attendance_leaderboard').select('user_id, display_name, avatar_url, points, total_scans, season').eq('season', seasonOf(new Date())).order('points', { ascending: false }).limit(5);
      if (!data?.length) { $("miniTopMeta").textContent = 'A√∫n no hay datos.'; return; }
      $("miniTopMeta").textContent = `Temporada: ${seasonOf(new Date())}`;
      data.forEach((r, idx) => {
        const el = document.createElement('div'); el.className = 'row';
        el.innerHTML = `<div style="width:28px;text-align:right;font-weight:800">${idx + 1}</div><div class="avatar" style="width:36px;height:36px;margin-left:8px">${r.avatar_url ? `<img src="${r.avatar_url}">` : (r.display_name || '?')[0]?.toUpperCase()}</div><div style="flex:1;margin-left:8px"><div style="font-weight:700">${escapeHtml(r.display_name || 'Miembro')}${r.user_id === CURRENT_USER.id ? ' <span class="pill">T√∫</span>' : ''}</div><div class="meta">Asistencias: ${r.total_scans} ‚Ä¢ Puntos: ${r.points}</div></div>`;
        $("miniTopList").appendChild(el);
      });
    }

    /* ====== Frases y valor ====== */
    const FRASES_PERFIL = [{ texto: "Un solo delegado puede marcar la diferencia, pero un equipo unido transforma la historia.", tag: "Trabajo en equipo" }, { texto: "La juventud no es el futuro del sindicato, es el presente que lo est√° cambiando.", tag: "Juventud" }, { texto: "El sindicalismo es la voz organizada de quienes no se rinden ante la injusticia.", tag: "Sindicalismo" }, { texto: "Ning√∫n derecho se nos regal√≥; todos se conquistaron con organizaci√≥n y compa√±erismo.", tag: "Lucha sindical" }];
    const VALOR_PERFIL = ["Comparte tu perfil con compa√±eros que puedan apoyarte en tu zona o servicio.", "Registra tus participaciones en asambleas para documentar tu liderazgo.", "Mant√©n actualizado tu tel√©fono y habilidades."];
    function cambiarFrasePerfil() { const f = FRASES_PERFIL[Math.floor(Math.random() * FRASES_PERFIL.length)]; if ($("perfilQuoteText")) $("perfilQuoteText").textContent = `"${f.texto}"`; if ($("perfilQuoteTag")) $("perfilQuoteTag").textContent = f.tag; }
    function aplicarValorPerfil() { if ($("perfilValorList")) { $("perfilValorList").innerHTML = ""; VALOR_PERFIL.forEach(v => { const li = document.createElement('li'); li.textContent = v; $("perfilValorList").appendChild(li); }); } }
    function buildNextActionsFromProfile(tel, servicios, cumple, matricula) {
      if (!$("perfilAccionesList") || !$("perfilAccionesEmpty")) return; $("perfilAccionesList").innerHTML = ""; $("perfilAccionesEmpty").style.display = "none";
      const acciones = []; if (!matricula) acciones.push("Agrega tu matr√≠cula."); if (!tel) acciones.push("Agrega tu tel√©fono de contacto."); if (!servicios) acciones.push("Describe tus servicios o habilidades."); if (!cumple) acciones.push("Captura tu fecha de cumplea√±os.");
      if (acciones.length === 0) { $("perfilAccionesEmpty").style.display = "block"; return; }
      acciones.forEach(txt => { const li = document.createElement('li'); li.textContent = txt; $("perfilAccionesList").appendChild(li); });
    }
    function initPerfilExtras() { cambiarFrasePerfil(); aplicarValorPerfil(); }
  </script>
</body>
</html>
