<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biblioteca ‚Äî Unidad en Acci√≥n</title>
  <style>
    :root {
      --bg:#0b1022;
      --panel:#101a33;
      --txt:#e6fbff;
      --muted:#aee9f7;
      --primary:#5bd7f2;
      --sky:#60a5fa;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    body{background:transparent;color:var(--txt);min-height:100vh}
    .wrap{padding:4px 0 16px}

    .card{
      background:var(--panel);
      border:1px solid rgba(91,215,242,.25);
      border-radius:16px;
      padding:16px;
      margin-bottom:12px;
      box-shadow:0 8px 25px rgba(0,0,0,.25)
    }
    h2{font-size:18px;margin-bottom:8px;color:#bff4ff}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    p.muted{color:var(--muted);font-size:14px}
    .meta{font-size:12px;color:#9fdcf0}

    input,textarea,select{
      background:#0a1329;
      color:#e6fbff;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(91,215,242,.3)
    }

    .btn{
      background:linear-gradient(90deg,var(--primary),var(--sky));
      color:#072133;
      padding:8px 14px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      border:none;
      text-decoration:none;
      display:inline-flex;
      gap:6px;
      align-items:center;
      justify-content:center
    }
    .btn:hover{filter:brightness(1.1)}

    .subtle-btn{
      background:rgba(91,215,242,.08);
      border:1px solid rgba(91,215,242,.28);
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      color:#fff
    }
    .subtle-btn:hover{background:rgba(91,215,242,.18)}

    /* GRID */
    #libraryList{
      display:grid;
      gap:12px;
      margin-top:10px;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr))
    }

    .lib-section-header{
      grid-column:1 / -1;
      border-top:1px solid rgba(91,215,242,.28);
      margin-top:6px;
      padding-top:8px;
      text-transform:uppercase;
      font-size:12px;
      color:#86d5f3;
      display:flex;
      gap:6px;
      align-items:center
    }

    /* TARJETAS */
    .resource-card{
      background:radial-gradient(circle at top left,rgba(96,165,250,.12),transparent 55%),#0c1630;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(91,215,242,.25);
      cursor:pointer;
      transition:.15s;
      box-shadow:0 10px 25px rgba(0,0,0,.35)
    }
    .resource-card:hover{
      transform:translateY(-2px);
      box-shadow:0 14px 30px rgba(0,0,0,.45);
      border-color:rgba(91,215,242,.55)
    }

    .resource-header{display:flex;gap:10px}
    .resource-title{font-size:15px;font-weight:700}
    .resource-description{
      margin-top:6px;
      white-space:pre-wrap;
      font-size:13px;
      line-height:1.35
    }
    .resource-description.long{
      display:-webkit-box;
      -webkit-line-clamp:4;
      -webkit-box-orient:vertical;
      overflow:hidden
    }

    .pill{
      padding:4px 8px;
      background:rgba(96,165,250,.12);
      border:1px solid rgba(96,165,250,.35);
      border-radius:999px;
      font-size:11px;
      color:#cfefff
    }

    /* MODAL */
    .modal-backdrop{
      position:fixed;inset:0;
      background:rgba(15,23,42,.85);
      display:flex;justify-content:center;align-items:center;
      padding:16px;
      opacity:0;
      pointer-events:none;
      transition:.18s;
      z-index:9999
    }
    .modal-backdrop.visible{opacity:1;pointer-events:auto}

    .modal-panel{
      background:#020617;
      border-radius:18px;
      width:100%;
      max-width:640px;
      border:1px solid rgba(56,189,248,.45);
      padding:18px;
      max-height:90vh;
      display:flex;
      flex-direction:column;
      box-shadow:0 24px 60px rgba(0,0,0,.6)
    }

    .modal-title{font-size:17px;font-weight:700;color:#e0faff}
    .modal-body{overflow-y:auto;font-size:14px;color:var(--muted)}
    .modal-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}

    .modal-close-btn{
      background:none;border:none;
      font-size:22px;color:#9fdcf0;
      cursor:pointer
    }

  </style>
</head>
<body>

<div class="wrap">

  <!-- FILTRO -->
  <div class="card">
    <h2>üìö Biblioteca de Recursos</h2>
    <p class="muted">Consulta materiales, documentos y gu√≠as.</p>

    <div class="row" style="margin-top:10px">
      <input id="qLibrary" placeholder="Buscar‚Ä¶" style="flex:1;min-width:220px">
      <select id="libCategory"><option value="">Todas las categor√≠as</option></select>
      <button class="subtle-btn" id="btnRefreshLibrary">Actualizar</button>
    </div>

    <div id="libStats" class="meta" style="margin-top:8px">Cargando‚Ä¶</div>
  </div>

  <!-- LISTA -->
  <div class="card">
    <h2>üìÇ Recursos disponibles</h2>
    <div id="libraryList"></div>
  </div>

  <!-- ADMIN -->
  <div id="adminBlock" class="card" style="display:none">
    <h2>üõ†Ô∏è Administrar Biblioteca</h2>

    <form id="adminForm" style="display:grid;gap:8px;max-width:640px;margin-top:10px">
      <label class="meta">T√≠tulo</label>
      <input id="aTitle">

      <label class="meta">Descripci√≥n</label>
      <textarea id="aDesc"></textarea>

      <label class="meta">URL</label>
      <input id="aUrl">

      <label class="meta">Categor√≠a</label>
      <input id="aCat">

      <label class="meta">Etiquetas (coma)</label>
      <input id="aTags">

      <label class="meta">Tipo</label>
      <select id="aType">
        <option value="pdf">PDF</option>
        <option value="video">Video</option>
        <option value="audio">Audio</option>
        <option value="link">Enlace</option>
        <option value="otro">Otro</option>
      </select>

      <div class="row">
        <button class="btn" type="submit">Guardar</button>
        <span class="meta" id="adminStatus"></span>
      </div>
    </form>
  </div>

</div>

<!-- MODAL -->
<div id="resourceModal" class="modal-backdrop">
  <div class="modal-panel">
    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
      <div>
        <div id="modalTitle" class="modal-title"></div>
        <div id="modalMeta" class="meta" style="margin-top:4px"></div>
      </div>
      <button id="modalCloseBtn" class="modal-close-btn">‚úï</button>
    </div>

    <div id="modalDesc" class="modal-body" style="white-space:pre-wrap"></div>
    <div id="modalTags" class="modal-tags"></div>

    <div style="text-align:right;margin-top:12px">
      <a id="modalOpenLink" href="#" class="btn" target="_blank" style="display:none">Abrir recurso</a>
    </div>
  </div>
</div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ========== CONFIG ========== */
const SUPABASE_URL = "https://axsncdwshdvsysrpikwj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5c...";
const LOGIN_URL = "login.html";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY,{auth:{persistSession:true,autoRefreshToken:true}});

let CURRENT_USER=null, IS_ADMIN=false, LIBRARY_CACHE=[];

const $=id=>document.getElementById(id);
const debounce=(fn,ms=200)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

document.addEventListener("DOMContentLoaded",initApp);

/* ========== INIT ========== */
async function initApp(){
  const {data:{session}} = await supabase.auth.getSession();
  if(!session){location.href=LOGIN_URL;return;}

  CURRENT_USER=session.user;
  IS_ADMIN=session.user.app_metadata?.role==="admin";
  if(IS_ADMIN) $("adminBlock").style.display="block";

  $("btnRefreshLibrary").onclick=()=>loadLibrary(true);
  $("qLibrary").oninput=debounce(()=>renderLibrary());
  $("libCategory").onchange=()=>renderLibrary();
  $("adminForm").onsubmit=onAdminSave;

  setupModal();
  loadLibrary(true);
}

/* ========== CARGAR BIBLIOTECA ========== */
async function loadLibrary(force=false){
  if(!force && LIBRARY_CACHE.length){renderLibrary();return;}

  $("libStats").textContent="Cargando‚Ä¶";

  let {data,error}=await supabase.from("library_items")
    .select("*").order("created_at",{ascending:false}).limit(200);

  if(error){$("libStats").textContent="Error al cargar.";return;}

  LIBRARY_CACHE=data;
  $("libStats").textContent=`${data.length} recursos disponibles`;
  populateCategories();
  renderLibrary();
}

function populateCategories(){
  const sel=$("libCategory");
  const cats=[...new Set(LIBRARY_CACHE.map(i=>i.category).filter(Boolean))].sort();
  sel.innerHTML='<option value="">Todas las categor√≠as</option>' + cats.map(c=>`<option>${c}</option>`).join("");
}

/* ========== RENDER ========== */
function renderLibrary(){
  const list=$("libraryList");
  list.innerHTML="";

  const q=$("qLibrary").value.toLowerCase();
  const selectedCat=$("libCategory").value;

  let items=LIBRARY_CACHE.filter(i=>
    (!selectedCat || i.category===selectedCat) &&
    (i.title?.toLowerCase().includes(q) ||
     i.description?.toLowerCase().includes(q) ||
     (i.tags+"")?.toLowerCase().includes(q))
  );

  items.sort((a,b)=>((a.category||"").localeCompare(b.category||""))||new Date(b.created_at)-new Date(a.created_at));

  let currentCat=null;

  for(const item of items){
    if(!selectedCat && item.category!==currentCat){
      currentCat=item.category;
      const head=document.createElement("div");
      head.className="lib-section-header";
      head.innerHTML=`üè∑Ô∏è ${currentCat||"Sin categor√≠a"}`;
      list.appendChild(head);
    }

    const card=document.createElement("div");
    card.className="resource-card";

    const tags = Array.isArray(item.tags) ? item.tags : (item.tags?item.tags.split(",") : []);

    card.innerHTML=`
      <div class="resource-header">
        <div style="font-size:26px">üìÑ</div>
        <div>
          <div class="resource-title">${escape(item.title)}</div>
          <div class="meta" style="margin-top:2px">üìÖ ${fmtDate(item.created_at)}</div>
          <p class="resource-description long">${escape(item.description||"")}</p>
          <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
            ${tags.map(t=>`<span class="pill">${escape(t)}</span>`).join("")}
          </div>
        </div>
      </div>
    `;

    card.onclick=()=>openModal(item);
    list.appendChild(card);
  }
}

/* ========== ADMIN SAVE ========== */
async function onAdminSave(e){
  e.preventDefault();
  if(!IS_ADMIN){$("adminStatus").textContent="No autorizado";return;}

  const title=$("aTitle").value.trim();
  const url=$("aUrl").value.trim();
  if(!title||!url){$("adminStatus").textContent="Falta t√≠tulo o URL";return;}

  const tags= $("aTags").value.split(",").map(t=>t.trim()).filter(Boolean);

  let {error}=await supabase.from("library_items").insert([{
    title,
    url,
    description:$("aDesc").value.trim(),
    category:$("aCat").value.trim(),
    tags,
    file_type:$("aType").value,
    created_by:CURRENT_USER.id
  }]);

  $("adminStatus").textContent= error?"Error":"Guardado ‚úî";
  if(!error) loadLibrary(true);
}

/* ========== MODAL ========== */
function setupModal(){
  $("modalCloseBtn").onclick=closeModal;
  $("resourceModal").onclick=e=>{if(e.target.id==="resourceModal") closeModal()};
}

function openModal(item){
  $("modalTitle").textContent=item.title;
  $("modalDesc").textContent=item.description||"Sin descripci√≥n";
  $("modalMeta").textContent=`üìÖ ${fmtDate(item.created_at)} ¬∑ üè∑Ô∏è ${item.category||"Sin categor√≠a"}`;

  const tags=Array.isArray(item.tags)?item.tags:(item.tags?item.tags.split(","):[]);
  $("modalTags").innerHTML=tags.map(t=>`<span class="pill">${escape(t)}</span>`).join("");

  if(item.url){
    $("modalOpenLink").href=item.url;
    $("modalOpenLink").style.display="inline-flex";
  }else{
    $("modalOpenLink").style.display="none";
  }

  $("resourceModal").classList.add("visible");
}

function closeModal(){
  $("resourceModal").classList.remove("visible");
}

/* ========== UTILS ========== */
function escape(str){return (str||"").replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
function fmtDate(d){try{return new Intl.DateTimeFormat("es-MX",{dateStyle:"medium"}).format(new Date(d))}catch{return d}}

</script>

</body>
</html>
