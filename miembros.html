<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unidad en Acci√≥n ‚Äî Mi perfil</title>
  <link rel="icon"
    href="https://github.com/ChronosBVRX/InnovacionSindical/blob/main/Logo%20Unidad%20en%20Accion.png?raw=true">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #0b1022;
      --panel: #101a33;
      --ring: rgba(91, 215, 242, .35);
      --txt: #e6fbff;
      --muted: #aee9f7;
      --primary: #5bd7f2;
      --sky: #60a5fa;
      --danger: #f97373;
      --success: #4ade80;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
    }

    body {
      background:
        radial-gradient(circle at top, rgba(96, 165, 250, .16), transparent 55%),
        linear-gradient(180deg, #050816, #020617);
      color: var(--txt);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
    }

    .topbar {
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      border-bottom: 1px solid rgba(148, 163, 184, .4);
      background: rgba(15, 23, 42, .9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      border: 1px solid var(--ring);
      background: rgba(15, 23, 42, .9);
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .logo-mark img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .topbar-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .topbar-title span {
      font-size: 14px;
      font-weight: 600;
    }

    .topbar-title small {
      font-size: 11px;
      color: #94a3b8;
    }

    .clock {
      font-size: 12px;
      color: #cbd5f5;
    }

    main {
      flex: 1;
      padding: 18px 16px 24px;
      max-width: 1080px;
      width: 100%;
      margin: 0 auto;
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    @media (min-width: 900px) {
      .layout {
        flex-direction: row;
        align-items: flex-start;
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(96, 165, 250, .06), transparent 55%),
        rgba(15, 23, 42, .98);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, .45);
      box-shadow: 0 20px 40px rgba(15, 23, 42, .9);
      padding: 16px 18px;
    }

    .perfil-main {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .perfil-header {
      display: flex;
      gap: 14px;
      align-items: center;
    }

    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 20px;
      border: 1px solid var(--ring);
      background: radial-gradient(circle at top, rgba(96, 165, 250, .4), rgba(15, 23, 42, 1));
      display: grid;
      place-items: center;
      font-size: 26px;
    }

    .perfil-header-text h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .perfil-header-text p {
      font-size: 13px;
      color: var(--muted);
    }

    .badge-role {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, .45);
      font-size: 11px;
      color: #e0f2fe;
      background: rgba(15, 23, 42, .95);
    }

    .perfil-data-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
      margin-top: 4px;
    }

    @media (min-width: 640px) {
      .perfil-data-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 12px;
    }

    .field label {
      color: #94a3b8;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .09em;
    }

    .field span {
      font-size: 13px;
      color: var(--txt);
    }

    .field span.empty {
      color: #facc15;
    }

    .perfil-form {
      margin-top: 8px;
      border-top: 1px dashed rgba(148, 163, 184, .45);
      padding-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .perfil-form-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
    }

    @media (min-width: 640px) {
      .perfil-form-row {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .perfil-form label {
      font-size: 11px;
      color: #cbd5f5;
      display: block;
      margin-bottom: 3px;
    }

    .perfil-form input,
    .perfil-form textarea {
      width: 100%;
      background: rgba(15, 23, 42, .95);
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, .7);
      color: var(--txt);
      font-size: 13px;
      padding: 6px 8px;
      outline: none;
    }

    .perfil-form textarea {
      resize: vertical;
      min-height: 60px;
    }

    .perfil-form input:focus,
    .perfil-form textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, .4);
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.9);
      background: linear-gradient(135deg, rgba(56, 189, 248, .25), rgba(59, 130, 246, .35));
      color: #e0f2fe;
      font-size: 13px;
      cursor: pointer;
      margin-top: 4px;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, rgba(56, 189, 248, .4), rgba(59, 130, 246, .5));
    }

    .msg {
      font-size: 12px;
      margin-top: 4px;
    }

    .msg.ok {
      color: var(--success);
    }

    .msg.err {
      color: var(--danger);
    }

    .perfil-extra {
      flex: 1.4;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .perfil-extra h3 {
      font-size: 15px;
      margin-bottom: 6px;
    }

    #perfil-quote-text {
      font-size: 14px;
      line-height: 1.5;
      color: var(--muted);
    }

    #perfil-quote-tag {
      display: block;
      margin-top: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(174, 233, 247, 0.85);
    }

    .btn-mini {
      margin-top: 8px;
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(91, 215, 242, 0.6);
      background: rgba(5, 14, 26, 0.9);
      color: #e6fbff;
      cursor: pointer;
    }

    .btn-mini:hover {
      background: rgba(56, 189, 248, .15);
    }

    .perfil-valor ul,
    .perfil-acciones ul {
      margin-left: 16px;
      font-size: 13px;
      color: var(--muted);
    }

    .perfil-valor li+li,
    .perfil-acciones li+li {
      margin-top: 4px;
    }

    .empty-actions {
      font-size: 13px;
      color: #bbf7d0;
    }

    .tag-pendiente {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(248, 250, 252, .1);
      background: rgba(120, 53, 15, .5);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 4px;
      color: #fed7aa;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-left">
      <div class="logo-mark">
        <img
          src="https://github.com/ChronosBVRX/InnovacionSindical/blob/main/Logo%20Unidad%20en%20Accion.png?raw=true"
          alt="Unidad en Acci√≥n">
      </div>
      <div class="topbar-title">
        <span>Unidad en Acci√≥n</span>
        <small>Miembros ¬∑ Perfil</small>
      </div>
    </div>
    <div class="clock" id="clock">--:--:--</div>
  </header>

  <main>
    <section class="layout">
      <!-- COLUMNA PRINCIPAL: PERFIL -->
      <section class="perfil-main card">
        <div class="perfil-header">
          <div class="avatar" id="avatar-iniciales">üë§</div>
          <div class="perfil-header-text">
            <h1 id="perfil-nombre">Miembro</h1>
            <p id="perfil-email">Cargando correo‚Ä¶</p>
            <span class="badge-role" id="perfil-rol">
              üß© Miembro de Unidad en Acci√≥n
            </span>
          </div>
        </div>

        <div class="perfil-data-grid">
          <div class="field">
            <label>Tel√©fono</label>
            <span id="perfil-telefono" class="empty">Sin registrar</span>
          </div>
          <div class="field">
            <label>Servicios / habilidades</label>
            <span id="perfil-servicios" class="empty">Describe en qu√© puedes apoyar</span>
          </div>
          <div class="field">
            <label>Cumplea√±os</label>
            <span id="perfil-cumple" class="empty">Captura tu fecha de cumplea√±os</span>
          </div>
          <div class="field">
            <label>Estado del perfil</label>
            <span id="perfil-estado">Revisando informaci√≥n‚Ä¶</span>
          </div>
        </div>

        <!-- Formulario -->
        <form id="perfil-form" class="perfil-form">
          <div class="perfil-form-row">
            <div>
              <label for="input-telefono">Tel√©fono de contacto</label>
              <input id="input-telefono" name="telefono" type="tel" placeholder="Ej. 55-1234-5678">
            </div>
            <div>
              <label for="input-cumple">Fecha de cumplea√±os</label>
              <input id="input-cumple" name="cumple" type="date">
            </div>
            <div>
              <label for="input-servicios">Servicios / habilidades</label>
              <input id="input-servicios" name="servicios" type="text"
                placeholder="Ej. Programaci√≥n, asesor√≠a, etc.">
            </div>
          </div>

          <div>
            <label for="input-notas">Notas internas (solo en este dispositivo)</label>
            <textarea id="input-notas" name="notas"
              placeholder="Breve descripci√≥n de tu rol o zona de influencia."></textarea>
          </div>

          <button type="submit" class="btn-primary">
            üíæ Guardar cambios
          </button>
          <div id="perfil-msg" class="msg" aria-live="polite"></div>
        </form>
      </section>

      <!-- COLUMNA DERECHA: FRASES, VALOR Y ACCIONES -->
      <section class="perfil-extra">
        <article class="card perfil-quote">
          <h3>üí¨ Frase para el equipo</h3>
          <p id="perfil-quote-text">Cargando frase‚Ä¶</p>
          <small id="perfil-quote-tag"></small>
          <button type="button" class="btn-mini" onclick="cambiarFrasePerfil()">
            Otra frase
          </button>
        </article>

        <article class="card perfil-valor">
          <h3>‚≠ê Valor para tu labor sindical</h3>
          <ul id="perfil-valor-list"></ul>
        </article>

        <article class="card perfil-acciones">
          <div class="tag-pendiente">Pr√≥ximas acciones</div>
          <h3>Lo que puedes completar de tu perfil</h3>
          <p style="font-size:13px;margin:4px 0 6px;color:#cbd5f5;">
            Solo ver√°s lo que hace falta. Cuando completes un dato, desaparecer√° de esta lista.
          </p>
          <ul id="perfil-acciones-list"></ul>
          <p id="perfil-acciones-empty" class="empty-actions" style="display:none;">
            ‚úÖ Tu perfil est√° completo. Gracias por mantener tus datos actualizados.
          </p>
        </article>
      </section>
    </section>
  </main>

  <script>
    // --- Reloj ---
    function tickClock() {
      const el = document.getElementById('clock');
      if (!el) return;
      el.textContent = new Date().toLocaleTimeString('es-MX', { hour12: false });
    }
    tickClock();
    setInterval(tickClock, 1000);

    // --- Supabase ---
    const SUPABASE_URL = "https://axsncdwshdvsysrpikwj.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c25jZHdzaGR2c3lzcnBpa3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjkwMjQsImV4cCI6MjA3NTgwNTAyNH0.oapcH219puVjaR2DcG7dX51uhwVn530L1hhz8ASv7qs";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentProfile = null;
    let currentPhone = "";

    async function loadUserAndProfile() {
      const msgEl = document.getElementById('perfil-msg');
      try {
        const { data: { user }, error } = await supabaseClient.auth.getUser();
        if (error || !user) {
          window.location.href = "login.html";
          return;
        }
        currentUser = user;

        const email = user.email || "";
        const nombre = user.user_metadata?.nombre || user.user_metadata?.full_name || email.split("@")[0];
        document.getElementById('perfil-nombre').textContent = nombre || "Miembro";
        document.getElementById('perfil-email').textContent = email || "Sin correo";

        const avatarEl = document.getElementById('avatar-iniciales');
        if (nombre) {
          const partes = nombre.trim().split(/\s+/);
          const iniciales = (partes[0]?.[0] || "") + (partes[1]?.[0] || "");
          avatarEl.textContent = iniciales.toUpperCase();
        }

        // Tel√©fono desde metadata
        currentPhone = user.user_metadata?.telefono || user.user_metadata?.phone || "";

        // Perfil desde tabla public.profiles (SOLO columnas existentes)
        const { data: profile, error: pError } = await supabaseClient
          .from('profiles')
          .select('servicios, cumple')
          .eq('user_id', user.id)
          .maybeSingle();

        if (pError) {
          console.error(pError);
          msgEl.textContent = "No se pudo cargar el perfil.";
          msgEl.className = "msg err";
        }

        currentProfile = profile || {};
        // Guardamos tambi√©n el tel√©fono en el objeto en memoria
        currentProfile.telefonoMeta = currentPhone;

        renderProfile(currentProfile);

        // Notas locales
        const notasLocal = localStorage.getItem('perfil:notas:' + user.id) || "";
        document.getElementById('input-notas').value = notasLocal;

        buildNextActions(currentProfile);
      } catch (err) {
        console.error(err);
        if (msgEl) {
          msgEl.textContent = "Error inesperado al cargar tu perfil.";
          msgEl.className = "msg err";
        }
      }
    }

    function renderProfile(profile) {
      const telSpan = document.getElementById('perfil-telefono');
      const servSpan = document.getElementById('perfil-servicios');
      const cumpleSpan = document.getElementById('perfil-cumple');
      const estadoSpan = document.getElementById('perfil-estado');

      const tel = profile.telefonoMeta || "";
      const servicios = profile?.servicios || "";
      const cumple = profile?.cumple || null;

      if (tel) {
        telSpan.textContent = tel;
        telSpan.classList.remove('empty');
      } else {
        telSpan.textContent = "Sin registrar";
        telSpan.classList.add('empty');
      }

      if (servicios) {
        servSpan.textContent = servicios;
        servSpan.classList.remove('empty');
      } else {
        servSpan.textContent = "Describe en qu√© puedes apoyar";
        servSpan.classList.add('empty');
      }

      if (cumple) {
        const d = new Date(cumple);
        if (!isNaN(d)) {
          cumpleSpan.textContent = d.toLocaleDateString('es-MX', {
            day: '2-digit', month: '2-digit', year: 'numeric'
          });
        } else {
          cumpleSpan.textContent = cumple;
        }
        cumpleSpan.classList.remove('empty');
      } else {
        cumpleSpan.textContent = "Captura tu fecha de cumplea√±os";
        cumpleSpan.classList.add('empty');
      }

      const faltantes = [];
      if (!tel) faltantes.push("tel√©fono");
      if (!servicios) faltantes.push("servicios/habilidades");
      if (!cumple) faltantes.push("cumplea√±os");

      if (faltantes.length === 0) {
        estadoSpan.textContent = "Perfil completo ‚úÖ";
      } else {
        estadoSpan.textContent = "Falta completar: " + faltantes.join(", ");
      }

      document.getElementById('input-telefono').value = tel || "";
      document.getElementById('input-servicios').value = servicios || "";
      document.getElementById('input-cumple').value = cumple || "";
    }

    // Guardar
    document.getElementById('perfil-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msgEl = document.getElementById('perfil-msg');
      msgEl.textContent = "Guardando‚Ä¶";
      msgEl.className = "msg";

      if (!currentUser) {
        msgEl.textContent = "Sesi√≥n no v√°lida. Vuelve a iniciar sesi√≥n.";
        msgEl.className = "msg err";
        return;
      }

      const telefono = document.getElementById('input-telefono').value.trim();
      const servicios = document.getElementById('input-servicios').value.trim();
      const cumple = document.getElementById('input-cumple').value || null;
      const notas = document.getElementById('input-notas').value.trim();

      // payload SOLO con columnas reales de profiles
      const payload = {
        user_id: currentUser.id,
        servicios: servicios || null,
        cumple: cumple
      };

      try {
        // upsert en profiles
        const { data, error } = await supabaseClient
          .from('profiles')
          .upsert(payload, { onConflict: 'user_id' })
          .select()
          .maybeSingle();

        if (error) {
          console.error(error);
          msgEl.textContent = "No se pudo guardar. Intenta m√°s tarde.";
          msgEl.className = "msg err";
          return;
        }

        // actualizar tel√©fono en metadata del usuario
        const { error: uError } = await supabaseClient.auth.updateUser({
          data: { telefono: telefono || null }
        });
        if (uError) console.error("Error actualizando tel√©fono:", uError);

        // notas solo en localStorage
        try {
          localStorage.setItem('perfil:notas:' + currentUser.id, notas);
        } catch { }

        currentPhone = telefono;
        currentProfile = data || payload;
        currentProfile.telefonoMeta = currentPhone;

        renderProfile(currentProfile);
        buildNextActions(currentProfile);

        msgEl.textContent = "Perfil actualizado correctamente.";
        msgEl.className = "msg ok";
      } catch (err) {
        console.error(err);
        msgEl.textContent = "Error inesperado al guardar.";
        msgEl.className = "msg err";
      }
    });

    // --- Frases & valor extra ---
    const FRASES_PERFIL = [
      {
        texto: "Un solo delegado puede marcar la diferencia, pero un equipo unido transforma la historia.",
        tag: "Trabajo en equipo"
      },
      {
        texto: "La juventud no es el futuro del sindicato, es el presente que lo est√° cambiando.",
        tag: "Juventud"
      },
      {
        texto: "El sindicalismo es la voz organizada de quienes no se rinden ante la injusticia.",
        tag: "Sindicalismo"
      },
      {
        texto: "Ning√∫n derecho se nos regal√≥; todos se conquistaron con organizaci√≥n y compa√±erismo.",
        tag: "Lucha sindical"
      },
      {
        texto: "Cuando un trabajador avanza, toda la organizaci√≥n avanza con √©l.",
        tag: "Trabajo en equipo"
      },
      {
        texto: "Ser joven en el sindicato es tener la oportunidad de convertir la inconformidad en propuesta.",
        tag: "Juventud"
      },
      {
        texto: "La fuerza de un sindicato est√° en la confianza entre sus miembros, no solo en sus documentos.",
        tag: "Confianza"
      },
      {
        texto: "Organizarse es el primer paso; mantenerse unidos es lo que cambia la realidad.",
        tag: "Unidad"
      }
    ];

    const VALOR_PERFIL = [
      "Comparte tu perfil con compa√±eros que puedan apoyarte en tu zona o servicio.",
      "Registra tus participaciones en asambleas o actividades para que tu liderazgo quede documentado.",
      "Revisa peri√≥dicamente la biblioteca sindical para conocer nuevos materiales de formaci√≥n.",
      "Mant√©n actualizado tu tel√©fono y habilidades para que puedan contactarte cuando m√°s se necesita.",
      "Agenda recordatorios para fechas clave: asambleas, informes, cursos de formaci√≥n y vencimiento de comisiones.",
      "Consulta los lineamientos y el estatuto antes de cada negociaci√≥n importante."
    ];

    function fraseAleatoria() {
      return FRASES_PERFIL[Math.floor(Math.random() * FRASES_PERFIL.length)];
    }

    function aplicarFrasePerfil() {
      const elTexto = document.getElementById('perfil-quote-text');
      const elTag = document.getElementById('perfil-quote-tag');
      if (!elTexto || !elTag) return;
      const f = fraseAleatoria();
      elTexto.textContent = `"${f.texto}"`;
      elTag.textContent = f.tag;
    }

    function aplicarValorPerfil() {
      const ul = document.getElementById('perfil-valor-list');
      if (!ul) return;
      ul.innerHTML = "";
      const usados = new Set();
      for (let i = 0; i < 3 && i < VALOR_PERFIL.length; i++) {
        let idx;
        do {
          idx = Math.floor(Math.random() * VALOR_PERFIL.length);
        } while (usados.has(idx));
        usados.add(idx);
        const li = document.createElement('li');
        li.textContent = VALOR_PERFIL[idx];
        ul.appendChild(li);
      }
    }

    function cambiarFrasePerfil() {
      aplicarFrasePerfil();
    }

    // --- Pr√≥ximas acciones ---
    function buildNextActions(profile) {
      const ul = document.getElementById('perfil-acciones-list');
      const emptyMsg = document.getElementById('perfil-acciones-empty');
      if (!ul || !emptyMsg) return;

      ul.innerHTML = "";
      emptyMsg.style.display = "none";

      const acciones = [];
      const tel = profile.telefonoMeta || "";
      const servicios = profile?.servicios || "";
      const cumple = profile?.cumple || null;

      if (!tel) {
        acciones.push("Agrega tu tel√©fono de contacto para que otros compa√±eros puedan localizarte cuando se necesite apoyo.");
      }
      if (!servicios) {
        acciones.push("Describe tus servicios o habilidades (por ejemplo: programaci√≥n, asesor√≠a de contrato colectivo, formaci√≥n, difusi√≥n, etc.).");
      }
      if (!cumple) {
        acciones.push("Captura tu fecha de cumplea√±os para poder considerar reconocimientos y detalles en tu d√≠a.");
      }

      if (acciones.length === 0) {
        emptyMsg.style.display = "block";
        return;
      }

      acciones.forEach(texto => {
        const li = document.createElement('li');
        li.textContent = texto;
        ul.appendChild(li);
      });
    }

    function initPerfilExtraObserver() {
      const card = document.querySelector('.perfil-quote');
      if (!card || !('IntersectionObserver' in window)) {
        aplicarFrasePerfil();
        aplicarValorPerfil();
        return;
      }

      const obs = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            aplicarFrasePerfil();
            aplicarValorPerfil();
          }
        });
      }, { threshold: 0.6 });

      obs.observe(card);
    }

    document.addEventListener('DOMContentLoaded', () => {
      initPerfilExtraObserver();
      loadUserAndProfile();
    });
  </script>
</body>

</html>
