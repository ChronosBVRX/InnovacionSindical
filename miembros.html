<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Unidad en Acci√≥n ‚Äî Miembros</title>
<link rel="icon" href="https://github.com/ChronosBVRX/InnovacionSindical/blob/main/Logo%20Unidad%20en%20Accion.png?raw=true">
<style>
  :root {
    --bg:#0b1022; --panel:#101a33; --ring:rgba(91,215,242,.35);
    --txt:#e6fbff; --muted:#aee9f7; --primary:#5bd7f2; --sky:#60a5fa;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  body{min-height:100vh;background:linear-gradient(180deg,#0b1220,#0b1022);color:var(--txt);display:flex;flex-direction:column}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#0e1730;box-shadow:0 2px 8px rgba(0,0,0,.4)}
  header img{height:40px;border-radius:50%}
  header button{background:#3a0d0d;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer}
  main{flex:1;display:flex}
  nav{width:220px;background:#0e1730;padding:10px;display:flex;flex-direction:column;gap:8px}
  nav button{background:#101a33;color:var(--txt);border:none;padding:10px;border-radius:8px;text-align:left;cursor:pointer;transition:.2s}
  nav button:hover,nav button.active{background:var(--sky);color:#fff}
  section{flex:1;padding:20px}
  .card{background:rgba(10,20,40,.7);padding:20px;border-radius:12px;border:1px solid var(--ring)}
  h2{margin-bottom:10px;color:var(--primary)}
  .meta{font-size:14px;color:var(--muted)}
  .qr-box img{margin-top:12px;width:150px;border:2px solid var(--sky);border-radius:8px}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:8px;">
    <img src="https://github.com/ChronosBVRX/InnovacionSindical/blob/main/Logo%20Unidad%20en%20Accion.png?raw=true">
    <b>Unidad en Acci√≥n ‚Äî Miembros</b>
  </div>
  <button onclick="logout()">Cerrar sesi√≥n</button>
</header>

<main>
  <nav>
    <button onclick="show('perfil')" class="active">üë§ Perfil</button>
    <button onclick="show('miembros')">üë• Miembros</button>
    <button onclick="show('calendario')">üìÖ Calendario</button>
    <button onclick="show('foro')">üí¨ Foro</button>
    <button onclick="show('verificacion')">‚úÖ Verificaci√≥n</button>
    <button onclick="show('perfilEditar')">‚öôÔ∏è Personaliza tu perfil</button>
  </nav>

  <section id="perfil" class="card">
    <h2>üëã Bienvenido</h2>
    <p>Esta es tu p√°gina de miembro dentro de Innovaci√≥n Sindical.</p>
    <div id="perfilInfo" class="meta" style="margin-top:12px;">
      <b>Nombre:</b> Cargando...<br>
      <b>Email:</b> ‚Äî<br>
      <b>Tel√©fono:</b> ‚Äî<br>
      <b>Cumplea√±os:</b> ‚Äî<br>
      <b>Categor√≠a:</b> ‚Äî<br>
      <b>Adscripci√≥n:</b> ‚Äî
    </div>
  </section>

  <section id="miembros" class="card" style="display:none;">
    <h2>üë• Miembros</h2>
    <div id="listaMiembros" class="meta">Cargando...</div>
  </section>

  <section id="calendario" class="card" style="display:none;">
    <h2>üìÖ Calendario</h2>
    <iframe src="https://calendar.google.com/calendar/embed?src=redunidadenaccion%40gmail.com&ctz=America%2FMexico_City" style="border:0;width:100%;height:500px;" frameborder="0" scrolling="no"></iframe>
  </section>

  <section id="foro" class="card" style="display:none;">
    <h2>üí¨ Foro</h2>
    <p>Muy pronto aqu√≠ podr√°s participar en las conversaciones de la comunidad.</p>
  </section>

  <section id="verificacion" class="card" style="display:none;">
    <h2>‚úÖ Verificaci√≥n de Asistencia</h2>
    <p>Confirma si asistir√°s al pr√≥ximo evento del calendario. Si confirmas, obtendr√°s un c√≥digo QR para registrar tu llegada.</p>
    <div id="eventBox" class="meta" style="margin-top:10px;">Cargando pr√≥ximo evento...</div>
  </section>

  <section id="perfilEditar" class="card" style="display:none;">
    <h2>‚öôÔ∏è Personaliza tu perfil</h2>
    <p>En construcci√≥n.</p>
  </section>
</main>

<script>
  // === CONFIGURACI√ìN ===
  const GCAL_API_KEY = "AIzaSyDdtYPPE-jTvw_Gypxrq2c5UePpbK9ZxZ0";
  const CALENDAR_ID = "redunidadenaccion@gmail.com";
  const TIMEZONE = "America/Mexico_City";

  // === NAVEGACI√ìN ===
  function show(id){
    document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll("section").forEach(s=>s.style.display="none");
    document.getElementById(id).style.display="block";
    event.target.classList.add("active");
  }

  // === SALIR ===
  function logout(){
    alert("Sesi√≥n cerrada (demo)");
  }

  // === ESCAPE HTML (fix) ===
  function escapeHtml(str){
    const map={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};
    return (str||"").replace(/[&<>"']/g,ch=>map[ch]);
  }

  // === CAPTURADOR DE ERRORES (debug visible) ===
  (function(){
    const box=document.createElement('div');
    box.id='debugError';
    box.style.cssText='position:fixed;left:12px;bottom:12px;right:12px;z-index:9999;background:#2b1a1a;color:#ffd7d7;border:1px solid #ff8f8f;padding:10px;border-radius:10px;font:12px/1.4 system-ui;display:none;white-space:pre-wrap;max-height:40vh;overflow:auto';
    document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(box));
    function showErr(msg){
      box.style.display='block';
      box.textContent='‚ö†Ô∏è Error de JavaScript:\n\n'+msg+'\n\nCopia este texto y m√°ndalo para revisi√≥n.';
    }
    window.addEventListener('error',e=>showErr(e.message));
    window.addEventListener('unhandledrejection',e=>showErr('Promise rejection: '+(e.reason?.message||e.reason)));
  })();

  // === CONSULTA DEL PR√ìXIMO EVENTO (Google Calendar API p√∫blica) ===
  async function fetchNextEvent(){
    try{
      const timeMin = new Date().toISOString();
      const url = new URL(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events`);
      url.searchParams.set("key", GCAL_API_KEY);
      url.searchParams.set("singleEvents", "true");
      url.searchParams.set("orderBy", "startTime");
      url.searchParams.set("timeMin", timeMin);
      url.searchParams.set("maxResults", "1");
      url.searchParams.set("timeZone", TIMEZONE);

      const res = await fetch(url);
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data = await res.json();

      const item = (data.items && data.items[0]) || null;
      if(!item) return null;

      const start = item.start?.dateTime || (item.start?.date ? `${item.start.date}T00:00:00` : null);
      const end   = item.end?.dateTime   || (item.end?.date   ? `${item.end.date}T23:59:59` : null);

      return {
        uid: item.id,
        title: item.summary || "Evento",
        start,
        end,
        location: item.location || "",
        description: item.description || "",
        htmlLink: item.htmlLink || ""
      };
    }catch(e){
      console.error("Calendar API error:", e);
      return null;
    }
  }

  // === MOSTRAR EVENTO EN VERIFICACI√ìN ===
  async function showNextEvent(){
    const eventBox=document.getElementById("eventBox");
    const ev=await fetchNextEvent();
    if(!ev){
      eventBox.innerHTML="No hay eventos pr√≥ximos o no fue posible consultarlos.";
      return;
    }

    const date = new Date(ev.start).toLocaleString("es-MX",{dateStyle:"full",timeStyle:"short"});
    eventBox.innerHTML=`
      <b>üìç ${escapeHtml(ev.title)}</b><br>
      üóìÔ∏è ${date}<br>
      ${ev.location?`üìå ${escapeHtml(ev.location)}<br>`:""}
      <button onclick="confirmarAsistencia('${ev.uid}','${ev.title}')">Asistir√©</button>
    `;
  }

  // === CONFIRMAR ASISTENCIA Y GENERAR QR ===
  async function confirmarAsistencia(uid,titulo){
    const qrBox=document.getElementById("eventBox");
    const qrData = `Evento: ${titulo}\nUsuario: demo\nUID: ${uid}`;
    const qrURL = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(qrData)}&size=150x150`;
    qrBox.innerHTML = `<b>¬°Asistencia confirmada!</b><br>Presenta este c√≥digo al llegar:<div class="qr-box"><img src="${qrURL}"></div>`;
  }

  // === INICIO ===
  document.addEventListener("DOMContentLoaded",()=>{
    showNextEvent();
  });
</script>
</body>
</html>
