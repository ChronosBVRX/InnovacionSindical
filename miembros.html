<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Unidad en Acci√≥n ‚Äî Miembros (todo en un archivo)</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{
    --bg:#0b1022; --panel:#0e1730; --panel2:#0b1429; --ring:rgba(91,215,242,.35);
    --txt:#e6fbff; --muted:#aee9f7; --accent:#5bd7f2; --sky:#60a5fa;
    --ok:#46d19e; --warn:#f5c56b; --err:#ff7b7b;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; color:var(--txt);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    background:
      radial-gradient(70vmax 70vmax at 50% 20%, rgba(96,165,250,.12), transparent 60%),
      radial-gradient(60vmax 60vmax at 80% 80%, rgba(91,215,242,.10), transparent 60%),
      linear-gradient(180deg,#0b1220,#0b1022);
  }
  a{color:#bff4ff}
  .page{max-width:1200px;margin:0 auto;padding:18px;display:grid;gap:14px}
  .head{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    background:linear-gradient(180deg,var(--panel2),#0b1328);
    border:1px solid rgba(91,215,242,.25);border-radius:16px;padding:12px;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:12px;border:1px solid rgba(91,215,242,.25);background:#061022;object-fit:contain}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:#aee9f7}
  .btn{
    appearance:none;border:1px solid rgba(91,215,242,.35);
    background:rgba(91,215,242,.14);color:#e6fbff;border-radius:12px;
    padding:8px 12px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px;
    transition:transform .12s ease;
  }
  .btn:hover{box-shadow:0 0 0 1px var(--ring) inset,0 10px 24px rgba(11,18,32,.55);transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--sky));border:none;color:#072133}

  .shell{display:grid;grid-template-columns:280px 1fr;gap:14px}
  @media (max-width:980px){ .shell{grid-template-columns:1fr} }

  .card{
    background:linear-gradient(180deg,var(--panel),#0b1328);
    border:1px solid rgba(91,215,242,.25);border-radius:16px;padding:16px;
    box-shadow:0 10px 40px rgba(0,0,0,.45);
  }

  /* Sidebar (submen√∫) */
  .menu{position:sticky;top:18px}
  .menu .section{margin-bottom:12px}
  .menu .section h3{margin:0 0 8px;font-size:12px;color:#9fdff0;text-transform:uppercase;letter-spacing:.4px}
  .tabbtn{width:100%;text-align:left}
  .tabbtn.active{background:linear-gradient(90deg,var(--accent),var(--sky));color:#072133;border:none}

  .sep{border:none;border-top:1px solid rgba(91,215,242,.25);margin:8px 0}

  /* Grids */
  .grid{display:grid;gap:12px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:2fr 1.2fr 1fr}
  @media (max-width:980px){ .cols-2,.cols-3{grid-template-columns:1fr} }

  /* Perfil tipo red social */
  .profileHeader{display:flex;gap:14px;align-items:center}
  .avatar{width:92px;height:92px;border-radius:18px;border:1px solid rgba(91,215,242,.35);background:#061022;object-fit:cover}
  .pname{margin:0;font-size:20px;color:#d6fbff}
  .ptag{display:inline-block;margin-top:4px;padding:4px 8px;border-radius:999px;font-size:12px;background:rgba(91,215,242,.12);border:1px solid rgba(91,215,242,.25)}

  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(91,215,242,.35);background:rgba(91,215,242,.12);color:#c7f7ff}

  /* Calendario liviano */
  .cal{--b:rgba(91,215,242,.18)}
  .cal .bar{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .cal .bar h2{margin:0}
  .cal .bar .nav button{padding:6px 10px;border-radius:10px;border:1px solid var(--b);background:rgba(91,215,242,.10);color:#d8fbff}
  .cal .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal .wday{font-size:12px;color:#aee9f7;text-align:center}
  .cal .day{height:78px;border:1px solid var(--b);border-radius:10px;padding:6px;font-size:12px;background:rgba(11,18,32,.55)}
  .cal .day .n{opacity:.9;color:#bff4ff}
  .cal .day.today{box-shadow:0 0 0 1px rgba(91,215,242,.42) inset}
  .cal .day.muted{opacity:.55}

  /* Formulario edici√≥n */
  label{display:block;font-size:12px;color:#bdefff;margin:6px 0 4px}
  input{
    width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(91,215,242,.28);
    background:#0a1329;color:#e6fbff;outline:none
  }
  .drop{
    border:1px dashed rgba(91,215,242,.35); background:rgba(91,215,242,.06);
    border-radius:12px; padding:10px; text-align:center; font-size:13px; color:#bfefff;
  }
  .drop.drag{background:rgba(91,215,242,.12)}
  progress{width:100%}

  /* Overlay de carga ‚Äî auto cierre con CSS a los 7s y tap para cerrar */
  .overlay{
    position:fixed; inset:0; display:grid; place-items:center; z-index:50;
    background:radial-gradient(60vmax 60vmax at 50% 40%, rgba(96,165,250,.16), transparent 60%),
               linear-gradient(180deg,#071122,#0a0f1d);
    transition:opacity .35s ease, visibility .35s ease;
    animation:ov-hide 7s forwards;
  }
  @keyframes ov-hide { to{ opacity:0; visibility:hidden; } }
  .overlay.hide{opacity:0; visibility:hidden}
  .loader{
    width:86px;height:86px;border-radius:22px;border:1px solid rgba(91,215,242,.38);
    background:linear-gradient(135deg,rgba(96,165,250,.18),rgba(91,215,242,.10));
    display:grid;place-items:center;box-shadow:0 0 18px rgba(91,215,242,.35) inset;
  }
  .spinner{width:44px;height:44px;border-radius:50%;
    border:3px solid rgba(91,215,242,.25); border-top:3px solid var(--accent); animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  #toast{position:fixed;right:14px;bottom:14px;background:#0b1429;border:1px solid rgba(91,215,242,.25);
    padding:8px 10px;border-radius:10px;font-size:12px;color:#bfefff;z-index:60;opacity:0;transform:translateY(8px);transition:.25s}
  #toast.show{opacity:1;transform:translateY(0)}

  /* Auth view */
  .auth-wrap{max-width:860px;margin:24px auto}
  .auth-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:900px){ .auth-grid{grid-template-columns:1fr} }
  .field{display:grid;gap:6px}
</style>
</head>
<body>

  <!-- ======== VISTA AUTH (login/registro) ======== -->
  <section id="authView" class="page" style="display:none">
    <header class="head">
      <div class="brand">
        <img class="logo" src="https://raw.githubusercontent.com/ChronosBVRX/InnovacionSindical/main/Logo%20Unidad%20en%20Accion.png" alt="Unidad en Acci√≥n">
        <div>
          <h1 style="margin:0;font-size:18px;color:#d6fbff">Unidad en Acci√≥n</h1>
          <div class="muted">Acceso a miembros</div>
        </div>
      </div>
      <div class="row">
        <a class="btn" href="https://chronosbvrx.github.io/InnovacionSindical/">üè† Inicio</a>
      </div>
    </header>

    <div class="auth-wrap">
      <div class="card">
        <div class="auth-grid">
          <!-- Login -->
          <div>
            <h2 style="margin-top:0">Iniciar sesi√≥n</h2>
            <div class="field">
              <label for="liEmail">Correo</label>
              <input id="liEmail" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="email">
            </div>
            <div class="field">
              <label for="liPass">Contrase√±a</label>
              <input id="liPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            </div>
            <div class="row" style="margin-top:8px">
              <button id="btnLogin" class="btn primary">Entrar</button>
            </div>
          </div>

          <!-- Registro -->
          <div>
            <h2 style="margin-top:0">Crear cuenta</h2>
            <div class="field">
              <label for="suEmail">Correo</label>
              <input id="suEmail" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="email">
            </div>
            <div class="field">
              <label for="suPass">Contrase√±a</label>
              <input id="suPass" type="password" placeholder="M√≠nimo 6 caracteres" autocomplete="new-password">
            </div>
            <div class="field">
              <label for="suName">Nombre para mostrar</label>
              <input id="suName" placeholder="Ej. Ana G√≥mez">
            </div>
            <div class="field">
              <label for="suPhone">Tel√©fono</label>
              <input id="suPhone" type="tel" inputmode="tel" placeholder="10 d√≠gitos">
            </div>
            <div class="field">
              <label for="suBirth">Fecha de cumplea√±os</label>
              <input id="suBirth" type="date">
            </div>
            <div class="field">
              <label for="suCategoria">Categor√≠a</label>
              <input id="suCategoria" placeholder="Ej. Enfermera General A">
            </div>
            <div class="field">
              <label for="suAds">Adscripci√≥n</label>
              <input id="suAds" placeholder="Ej. HGZ No. XX, Urgencias">
            </div>
            <div class="row" style="margin-top:8px">
              <button id="btnSignup" class="btn">Crear cuenta</button>
            </div>
          </div>
        </div>
        <div id="authMsg" class="muted" style="margin-top:8px"></div>
      </div>
    </div>
  </section>

  <!-- ======== VISTA APP (panel, perfil, etc.) ======== -->
  <section id="appView" class="page" style="display:none">
    <header class="head">
      <div class="brand">
        <img class="logo" src="https://raw.githubusercontent.com/ChronosBVRX/InnovacionSindical/main/Logo%20Unidad%20en%20Accion.png" alt="Unidad en Acci√≥n">
        <div>
          <h1 style="margin:0;font-size:18px;color:#d6fbff">Unidad en Acci√≥n</h1>
          <div class="muted">Panel de miembros</div>
        </div>
      </div>
      <div class="row">
        <a class="btn" href="https://chronosbvrx.github.io/InnovacionSindical/">üè† Inicio</a>
        <button id="btnLogoutTop" class="btn primary">‚éã Cerrar sesi√≥n</button>
      </div>
    </header>

    <section class="shell">
      <!-- SUBMEN√ö -->
      <aside class="card menu">
        <div class="section">
          <h3>Men√∫</h3>
          <button class="btn tabbtn active" data-tab="panel">üìä Panel</button>
          <button class="btn tabbtn" data-tab="perfil">üìá Perfil</button>
          <button class="btn tabbtn" data-tab="editar">‚úèÔ∏è Editar perfil</button>
          <button class="btn tabbtn" data-tab="seguridad">üîê Seguridad</button>
        </div>
        <hr class="sep">
        <div class="section">
          <div class="muted" style="font-size:12px">S√≥lo se muestra informaci√≥n esencial en el perfil.</div>
        </div>
      </aside>

      <!-- CONTENIDO -->
      <main id="tabs" class="grid">
        <!-- ============ TAB: PANEL (Dashboard) ============ -->
        <section id="tab-panel" class="grid cols-3">
          <!-- Calendario -->
          <article class="card cal">
            <div class="bar">
              <h2>Calendario de actividades</h2>
              <div class="nav">
                <button id="calPrev" type="button">‚óÄ</button>
                <button id="calToday" type="button">Hoy</button>
                <button id="calNext" type="button">‚ñ∂</button>
              </div>
            </div>
            <div class="grid" id="calWeek"></div>
            <div class="grid" id="calDays"></div>
          </article>

          <!-- Accesos r√°pidos -->
          <article class="card">
            <h2>Accesos r√°pidos</h2>
            <div class="grid">
              <a class="btn" href="https://chronosbvrx.github.io/InnovacionSindical/denuncias" target="_blank" rel="noopener">üìù Denuncias y reportes (con IA)</a>
              <a class="btn" href="https://trascendencia-sindical-7t85.onrender.com/" target="_blank" rel="noopener">ü§ñ TrascendencIA Sindical</a>
              <a class="btn" href="https://chronosbvrx.github.io/InnovacionSindical/directorio" target="_blank" rel="noopener">üìû Directorio</a>
            </div>
          </article>

          <!-- En espera -->
          <article class="card">
            <h2>En espera‚Ä¶</h2>
            <p class="muted">Pr√≥ximamente m√°s m√≥dulos del panel.</p>
            <div class="grid">
              <button class="btn">üìà M√©tricas</button>
              <button class="btn">ü§ù Vinculaci√≥n</button>
              <button class="btn">üìÅ Documentos</button>
            </div>
          </article>
        </section>

        <!-- ============ TAB: PERFIL (social) ============ -->
        <section id="tab-perfil" class="card" style="display:none">
          <div class="profileHeader">
            <img id="pfAvatar" class="avatar" alt="Avatar" src="">
            <div>
              <h2 id="pfName" class="pname">‚Äî</h2>
              <div class="ptag" id="pfCategory">‚Äî</div>
              <div style="margin-top:6px" class="muted" id="pfAdscripcion">‚Äî</div>
            </div>
          </div>

          <hr class="sep">

          <div class="grid cols-2">
            <div>
              <h3 style="margin:0 0 6px">Tarjetas</h3>
              <div class="pill">üë• Miembro activo</div>
              <div class="pill" id="pfSince" style="margin-left:6px">Desde ‚Äî</div>
            </div>
            <div>
              <h3 style="margin:0 0 6px">Contacto (privado)</h3>
              <div class="muted" style="font-size:14px">S√≥lo administradores ven los datos completos.</div>
            </div>
          </div>

          <details style="margin-top:10px">
            <summary>M√°s detalles (s√≥lo t√∫)</summary>
            <div class="grid cols-2" style="margin-top:8px">
              <div><b>Email:</b> <span id="pfEmailMask">‚Äî</span></div>
              <div><b>Tel√©fono:</b> <span id="pfPhoneMask">‚Äî</span></div>
              <div><b>Cumplea√±os:</b> <span id="pfBirthNice">‚Äî</span></div>
              <div><b>ID usuario:</b> <span id="pfUid">‚Äî</span></div>
            </div>
          </details>
        </section>

        <!-- ============ TAB: EDITAR PERFIL ============ -->
        <section id="tab-editar" class="card" style="display:none">
          <h2 style="margin-top:0">Editar perfil</h2>
          <p class="muted">Actualiza tus datos. El avatar se guarda en Supabase Storage.</p>

          <!-- Avatar -->
          <div class="grid" style="grid-template-columns:120px 1fr;gap:14px;align-items:center">
            <img id="edAvatar" class="avatar" alt="Avatar" src="" style="width:92px;height:92px">
            <div>
              <div class="drop" id="dropZone">
                Arrastra tu imagen aqu√≠ o <label for="avatarFile" style="text-decoration:underline;cursor:pointer">selecci√≥nala</label> (JPG/PNG/WebP, m√°x. 2MB).
                <input id="avatarFile" type="file" accept="image/png,image/jpeg,image/webp" style="display:none">
              </div>
              <progress id="upProgress" max="100" value="0" style="display:none;margin-top:8px"></progress>
            </div>
          </div>

          <hr class="sep">

          <form id="fEdit" class="grid cols-2">
            <div>
              <label for="iName">Nombre para mostrar</label>
              <input id="iName" placeholder="Ej. Ana G√≥mez">
            </div>
            <div>
              <label for="iPhone">Tel√©fono</label>
              <input id="iPhone" type="tel" inputmode="tel" placeholder="10 d√≠gitos" pattern="^[0-9+\\-\\s()]{7,20}$">
            </div>
            <div>
              <label for="iBirth">Fecha de cumplea√±os</label>
              <input id="iBirth" type="date">
            </div>
            <div>
              <label for="iCategoria">Categor√≠a</label>
              <input id="iCategoria" placeholder="Ej. Enfermera General A">
            </div>
            <div class="grid" style="grid-template-columns:1fr">
              <label for="iAds">Adscripci√≥n</label>
              <input id="iAds" placeholder="Ej. HGZ No. XX, Urgencias">
            </div>
            <div class="grid" style="grid-template-columns:1fr">
              <label for="iAvatarUrl">URL de avatar (opcional)</label>
              <input id="iAvatarUrl" placeholder="https://...png">
            </div>

            <div class="grid" style="grid-template-columns:auto auto;gap:10px">
              <button class="btn primary" type="submit">üíæ Guardar cambios</button>
              <span id="saveMsg" class="muted"></span>
            </div>
          </form>
        </section>

        <!-- ============ TAB: SEGURIDAD ============ -->
        <section id="tab-seguridad" class="card" style="display:none">
          <h2 style="margin-top:0">Seguridad de la cuenta</h2>
          <div class="grid">
            <div class="pill">üîê Datos cifrados</div>
            <div class="pill" id="stState">Verificando‚Ä¶</div>
          </div>
          <div class="grid cols-2" style="margin-top:10px">
            <div><b>Correo:</b> <span id="stEmail">‚Äî</span></div>
            <div><b>√öltimo acceso:</b> <span id="stLast">‚Äî</span></div>
            <div><b>Expira:</b> <span id="stExp">‚Äî</span></div>
            <div><b>UID:</b> <span id="stUid">‚Äî</span></div>
          </div>
          <hr class="sep">
          <button id="btnLogout" class="btn">‚éã Cerrar sesi√≥n</button>
        </section>
      </main>
    </section>
  </section>

  <!-- Overlay (tap para cerrar) -->
  <div id="overlay" class="overlay" onclick="this.classList.add('hide')">
    <div class="loader"><div class="spinner"></div></div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (async () => {
    /* ===== CONFIG ===== */
    const SUPABASE_URL = "https://axsncdwshdvsysrpikwj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c25jZHdzaGR2c3lzcnBpa3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjkwMjQsImV4cCI6MjA3NTgwNTAyNH0.oapcH219puVjaR2DcG7dX51uhwVn530L1hhz8ASv7qs";
    const AVATAR_BUCKET = "avatars"; // aseg√∫rate que el bucket exista y sea p√∫blico

    /* ===== Helpers UI ===== */
    const $ = s => document.querySelector(s);
    const toast = (t) => { const el = $('#toast'); el.textContent = t||''; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 2800); };
    const overlay = $('#overlay'); const hideOverlay = ()=> overlay.classList.add('hide');

    const authView = $('#authView');
    const appView  = $('#appView');

    function showAuth(){ authView.style.display='block'; appView.style.display='none'; hideOverlay(); }
    function showApp(){ authView.style.display='none'; appView.style.display='block'; hideOverlay(); }

    /* ===== Supabase client ===== */
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    /* ===== TABS ===== */
    const tabBtns = document.querySelectorAll('.tabbtn');
    function showTab(id){
      ['panel','perfil','editar','seguridad'].forEach(t => {
        const el = document.getElementById('tab-'+t);
        if (el) el.style.display = (t===id ? (t==='panel'?'grid':'block') : 'none');
      });
      tabBtns.forEach(b => b.classList.toggle('active', b.dataset.tab===id));
    }
    tabBtns.forEach(btn=> btn.addEventListener('click', ()=> showTab(btn.dataset.tab)));
    showTab('panel');

    /* ===== Calendario simple ===== */
    const weekNames = ['L','M','X','J','V','S','D'];
    const monthNames = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
    const calWeek = document.getElementById('calWeek'), calDays = document.getElementById('calDays'); let cur = new Date();

    function renderCalendar(date=new Date()){
      if(!calWeek || !calDays) return;
      calWeek.innerHTML = ''; calDays.innerHTML = '';
      weekNames.forEach(w=>{ const d=document.createElement('div'); d.className='wday'; d.textContent=w; calWeek.appendChild(d); });
      const y = date.getFullYear(), m = date.getMonth();
      const first = new Date(y,m,1);
      const start = new Date(first); start.setDate(1 - ((first.getDay()+6)%7)); // lunes
      const total = 42;
      document.getElementById('calToday').textContent = `${monthNames[m]} ${y}`;
      for(let i=0;i<total;i++){
        const d = new Date(start); d.setDate(start.getDate()+i);
        const cell = document.createElement('div'); cell.className='day';
        const inMonth = d.getMonth()===m;
        if(!inMonth) cell.classList.add('muted');
        const today = (new Date()).toDateString()===d.toDateString();
        if(today) cell.classList.add('today');
        cell.innerHTML = `<div class="n">${d.getDate()}</div>`;
        calDays.appendChild(cell);
      }
    }
    renderCalendar(cur);
    const calPrev = document.getElementById('calPrev');
    const calNext = document.getElementById('calNext');
    const calTodayBtn = document.getElementById('calToday');
    if (calPrev) calPrev.onclick = ()=>{ cur.setMonth(cur.getMonth()-1); renderCalendar(cur); };
    if (calNext) calNext.onclick = ()=>{ cur.setMonth(cur.getMonth()+1); renderCalendar(cur); };
    if (calTodayBtn) calTodayBtn.onclick = ()=>{ cur = new Date(); renderCalendar(cur); };

    /* ===== AUTH: login y registro ===== */
    const authMsg = $('#authMsg');
    function setAuthMsg(s){ authMsg.textContent=s||''; }

    // Login
    $('#btnLogin').addEventListener('click', async ()=>{
      setAuthMsg('Iniciando sesi√≥n‚Ä¶');
      const email = $('#liEmail').value.trim();
      const password = $('#liPass').value.trim();
      if(!email || !password){ setAuthMsg('Faltan correo y contrase√±a.'); return; }
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error){ setAuthMsg('Error: '+error.message); return; }
      setAuthMsg('Listo. Redirigiendo‚Ä¶');
      // la UI cambiar√° por evento de sesi√≥n
    });

    // Registro
    $('#btnSignup').addEventListener('click', async ()=>{
      setAuthMsg('Creando cuenta‚Ä¶');
      const email = $('#suEmail').value.trim();
      const password = $('#suPass').value.trim();
      const display_name = $('#suName').value.trim();
      const phone = $('#suPhone').value.trim();
      const birthdate = $('#suBirth').value || null;
      const categoria = $('#suCategoria').value.trim();
      const adscripcion = $('#suAds').value.trim();

      if(!email || !password){ setAuthMsg('Correo y contrase√±a son obligatorios.'); return; }

      const { error } = await supabase.auth.signUp({
        email, password,
        options: { data: { display_name, phone, birthdate, categoria, adscripcion } }
      });
      if(error){ setAuthMsg('Error: '+error.message); return; }
      setAuthMsg('¬°Cuenta creada! Revisa tu correo para confirmar el registro.');
    });

    // Logout
    const goLogout = async ()=>{ await supabase.auth.signOut(); showAuth(); };
    $('#btnLogout')?.addEventListener('click', goLogout);
    $('#btnLogoutTop')?.addEventListener('click', goLogout);

    /* ===== Pintar perfil (social) y edici√≥n ===== */
    const pfAvatar=$('#pfAvatar'), pfName=$('#pfName'), pfCategory=$('#pfCategory'), pfAds=$('#pfAdscripcion');
    const pfEmailMask=$('#pfEmailMask'), pfPhoneMask=$('#pfPhoneMask'), pfBirthNice=$('#pfBirthNice'), pfUid=$('#pfUid'), pfSince=$('#pfSince');

    const edAvatar=$('#edAvatar'), iName=$('#iName'), iPhone=$('#iPhone'), iBirth=$('#iBirth'), iCategoria=$('#iCategoria'), iAds=$('#iAds'), iAvatarUrl=$('#iAvatarUrl'), saveMsg=$('#saveMsg');

    const maskEmail = (e) => e?.replace(/(.{2}).+(@.+)/, (m,a,b)=> a+'***'+b) || '‚Äî';
    const maskPhone = (p) => p ? p.replace(/\d(?=\d{2})/g,'‚Ä¢') : '‚Äî';
    const fdate = (iso) => iso ? new Date(iso).toLocaleDateString('es-MX', { day:'2-digit', month:'long', year:'numeric' }) : '‚Äî';

    function paintAll(session){
      const u = session.user;
      const m = u.user_metadata || {};
      const avatar = m.avatar_url || "https://avatars.githubusercontent.com/u/9919?v=4";

      // PERFIL (social)
      pfAvatar.src = avatar; edAvatar.src = avatar;
      pfName.textContent = m.display_name || '(Sin nombre)';
      pfCategory.textContent = m.categoria || 'Sin categor√≠a';
      pfAds.textContent = m.adscripcion || 'Sin adscripci√≥n';

      pfEmailMask.textContent = maskEmail(u.email);
      pfPhoneMask.textContent = maskPhone(m.phone||'');
      pfBirthNice.textContent = fdate(m.birthdate);
      pfUid.textContent = u.id;
      pfSince.textContent = "Desde " + fdate(u.created_at);

      // EDITAR (form)
      iName.value = m.display_name || '';
      iPhone.value = m.phone || '';
      iBirth.value = (m.birthdate||'').slice(0,10);
      iCategoria.value = m.categoria || '';
      iAds.value = m.adscripcion || '';
      iAvatarUrl.value = m.avatar_url || '';

      showApp();
    }

    // Guardar metadatos
    $('#fEdit').addEventListener('submit', async (e)=>{
      e.preventDefault();
      saveMsg.textContent = 'Guardando‚Ä¶';
      const display_name = iName.value.trim();
      const phone = iPhone.value.trim();
      const birthdate = iBirth.value || null;
      const categoria = iCategoria.value.trim();
      const adscripcion = iAds.value.trim();
      const avatar_url = iAvatarUrl.value.trim();

      const { error } = await supabase.auth.updateUser({ data: { display_name, phone, birthdate, categoria, adscripcion, avatar_url } });
      if (error){ saveMsg.textContent = 'Error: ' + error.message; return; }
      saveMsg.textContent = 'Cambios guardados.';
      if (avatar_url){ pfAvatar.src = avatar_url + '#'+Date.now(); edAvatar.src = pfAvatar.src; }
      toast('Perfil guardado');
    });

    /* ===== Subida de avatar a Supabase Storage ===== */
    const dropZone = document.getElementById('dropZone');
    const upProgress = document.getElementById('upProgress');
    const fileInput = document.getElementById('avatarFile');

    function extFromType(t){ return t==='image/png'?'png':t==='image/jpeg'?'jpg':t==='image/webp'?'webp':'bin'; }

    async function handleFile(file){
      if(!file) return;
      if(!['image/png','image/jpeg','image/webp'].includes(file.type)){ toast('Formato no soportado'); return; }
      if(file.size > 2*1024*1024){ toast('M√°ximo 2MB'); return; }

      const { data:{ session } } = await supabase.auth.getSession();
      if(!session){ toast('Sin sesi√≥n'); return; }
      const uid = session.user.id;
      const path = `${uid}/${Date.now()}.${extFromType(file.type)}`;

      upProgress.style.display='block'; upProgress.value=25;
      const { error:upErr } = await supabase.storage.from(AVATAR_BUCKET).upload(path, file, { cacheControl:'3600', upsert:false, contentType:file.type });
      if(upErr){ upProgress.style.display='none'; toast('Error al subir: '+upErr.message); return; }
      upProgress.value=70;

      const { data:pub } = supabase.storage.from(AVATAR_BUCKET).getPublicUrl(path);
      const url = pub?.publicUrl; if(!url){ upProgress.style.display='none'; toast('No se pudo obtener URL p√∫blica'); return; }

      const { error:uuErr } = await supabase.auth.updateUser({ data:{ avatar_url:url, avatar_path:path } });
      upProgress.value=100; setTimeout(()=> upProgress.style.display='none', 600);
      if(uuErr){ toast('Subido, pero no se pudo actualizar el perfil'); return; }

      iAvatarUrl.value = url;
      pfAvatar.src = url + '#'+Date.now();
      edAvatar.src = pfAvatar.src;
      toast('Avatar actualizado');
    }

    fileInput.addEventListener('change', e=> handleFile(e.target.files?.[0]));
    ;['dragenter','dragover'].forEach(ev=> dropZone.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag'); }));
    ;['dragleave','drop'].forEach(ev=> dropZone.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag'); }));
    dropZone.addEventListener('drop', e=> handleFile(e.dataTransfer.files?.[0]));
    dropZone.addEventListener('click', ()=> fileInput.click());

    /* ===== Sesi√≥n inicial y cambios ===== */
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'INITIAL_SESSION'){ if(session){ paintAll(session); } else { showAuth(); } }
      else if (event === 'SIGNED_IN'){ paintAll(session); toast('Sesi√≥n iniciada.'); }
      else if (event === 'SIGNED_OUT'){ showAuth(); }
      else if (event === 'USER_UPDATED'){ supabase.auth.getSession().then(({data})=> data?.session && paintAll(data.session)); }
    });

    // Disparar inicial
    const { data:{ session } } = await supabase.auth.getSession();
    if(session){ paintAll(session); } else { showAuth(); }

  })();
  </script>
</body>
</html>