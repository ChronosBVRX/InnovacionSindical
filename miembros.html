<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unidad en AcciÃ³n â€” Miembros</title>
  <link rel="icon"
    href="https://github.com/ChronosBVRX/InnovacionSindical/blob/main/Logo%20Unidad%20en%20Accion.png?raw=true" />
  <link rel="stylesheet" href="theme.css?v=2" />
</head>

<body>
  <header class="glass-panel flex-between" style="padding:10px 20px; position:sticky; top:0; z-index:100;">
    <div style="display:flex; align-items:center; gap:12px;">
      <img src="https://github.com/ChronosBVRX/InnovacionSindical/blob/main/Logo%20Unidad%20en%20Accion.png?raw=true"
        alt="Logo" style="height:40px; width:auto;" />
      <h1 style="font-size:1.25rem; margin:0;">Unidad en AcciÃ³n â€” Miembros</h1>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button id="btnBack" class="subtle-btn" style="font-size:16px" title="AtrÃ¡s">â¬…</button>
      <button id="btnHome" class="subtle-btn" style="font-size:16px" title="Inicio">ğŸ </button>
      <button id="btnLogout" class="subtle-btn" style="font-size:0.9rem;">Cerrar sesiÃ³n</button>
    </div>
  </header>
  <main>
    <nav>
      <button class="tab active" data-tab="perfil">ğŸ‘¤ Perfil</button>
      <button class="tab" data-tab="miembros">ğŸ‘¥ Miembros</button>
      <button class="tab" data-tab="calendario">ğŸ“… Calendario</button>
      <button class="tab" data-tab="foro">ğŸ—£ï¸ Foro</button>
      <button class="tab" data-tab="verificacion">âœ… VerificaciÃ³n</button>
      <button class="tab" data-tab="scanner" id="tabScanner" style="display:none">ğŸ” Scanner</button>
      <button class="tab" data-tab="personaliza">âš™ï¸ Personaliza tu perfil</button>
    </nav>
    <!-- PERFIL -->
    <section id="perfil" class="content active">
      <div class="card">
        <h2>ğŸ‘‹ Bienvenido</h2>
        <p class="muted">Esta es tu pÃ¡gina de miembro dentro de Unidad en AcciÃ³n</p>
        <div class="profile-info">
          <div class="avatar" id="userAvatar">ğŸ§‘</div>
          <div class="profile-data">
            <p><strong>Nombre:</strong> <span id="pfName">Cargandoâ€¦</span></p>
            <p><strong>Email:</strong> <span id="pfEmail">â€”</span></p>
            <p><strong>TelÃ©fono:</strong> <span id="pfTelefono">â€”</span></p>
            <p><strong>CumpleaÃ±os:</strong> <span id="pfCumple">â€”</span></p>
            <p><strong>CategorÃ­a:</strong> <span id="pfCategoria">â€”</span></p>
            <p><strong>AdscripciÃ³n:</strong> <span id="pfAdscripcion">â€”</span></p>
          </div>
        </div>
        <!-- ASISTENCIA -->
        <div class="card" id="asistenciaResumen" style="margin-top:20px; animation:fadeInSmall .2s ease">
          <h3>ğŸ“Š Asistencia y recompensas</h3>
          <div id="asistData" class="meta" style="margin-bottom:8px">Cargando tus datos...</div>
          <div class="row" style="flex-wrap:wrap;gap:20px">
            <div>
              <div class="meta">Eventos asistidos (temporada)</div>
              <div id="asistTotal" style="font-size:26px;font-weight:700">0</div>
            </div>
            <div>
              <div class="meta">Racha actual (dÃ­as)</div>
              <div id="asistRacha" style="font-size:26px;font-weight:700">0</div>
            </div>
            <div>
              <div class="meta">Puntos</div>
              <div id="asistPuntos" style="font-size:26px;font-weight:700">0</div>
            </div>
            <div>
              <div class="meta">PosiciÃ³n en ranking</div>
              <div id="asistTop" style="font-size:26px;font-weight:700">â€”</div>
            </div>
          </div>
        </div>
        <!-- MINI TOP -->
        <div class="card" id="miniTop" style="margin-top:12px; animation:fadeInSmall .2s ease">
          <h3>ğŸ† Top de asistencia </h3>
          <div id="miniTopMeta" class="meta" style="margin-top:6px">Cargandoâ€¦</div>
          <div id="miniTopList" style="margin-top:10px;display:grid;gap:8px"></div>
        </div>
      </div>
    </section>
    <!-- MIEMBROS -->
    <section id="miembros" class="content">
      <div class="card">
        <h2>ğŸ‘¥ Directorio de Miembros</h2>
        <div class="row" style="margin-top:6px">
          <input id="qMembers" placeholder="Buscar por nombre o adscripciÃ³n" style="min-width:260px" />
          <button class="subtle-btn" id="btnRefreshMembers">Actualizar</button>
          <label class="row" style="gap:8px;align-items:center;margin-left:auto">
            <input type="checkbox" id="chkOnlineOnly" />
            <span>ğŸ‘ï¸ Solo online</span>
          </label>
        </div>
        <div id="membersList" style="margin-top:14px;display:grid;gap:12px"></div>
      </div>
    </section>
    <!-- CALENDARIO -->
    <section id="calendario" class="content">
      <div class="card">
        <h2>ğŸ“… Calendario de Actividades</h2>
        <iframe
          src="https://calendar.google.com/calendar/embed?src=redunidadenaccion%40gmail.com&ctz=America%2FMexico_City&showTitle=0&showPrint=0&showTz=0&showCalendars=0"></iframe>
      </div>
    </section>
    <!-- FORO -->
    <section id="foro" class="content">
      <div class="card">
        <h2>ğŸ—£ï¸ Foro de Miembros</h2>
        <div id="postsList" class="" style="display:grid;gap:12px"></div>
        <details class="forum-toggle" id="newPostToggle">
          <summary><span class="rotate">â–¸</span><span>Crear una publicaciÃ³n</span></summary>
          <form id="forumForm" style="margin-top:12px">
            <label>Escribe una publicaciÃ³n (mÃ¡x. 500 caracteres)</label>
            <textarea id="forumInput" maxlength="500" placeholder="Â¿QuÃ© quieres compartir con la comunidad?"></textarea>
            <div class="row">
              <label style="font-size:13px">CategorÃ­a</label>
              <select id="forumCategory">
                <option>Avisos</option>
                <option selected>Asuntos Generales</option>
                <option>Convivencia</option>
              </select>
            </div>
            <button class="btn" type="submit">â• Publicar</button>
            <div class="status meta" id="forumStatus"></div>
          </form>
        </details>
      </div>
    </section>
    <!-- VERIFICACIÃ“N -->
    <section id="verificacion" class="content">
      <div class="card">
        <h2>âœ… VerificaciÃ³n de Asistencia</h2>
        <p class="muted">Confirma si asistirÃ¡s al prÃ³ximo evento. Si confirmas, obtendrÃ¡s un QR para registrar tu
          llegada.</p>
        <div id="eventBox" class="meta">Buscando el prÃ³ximo eventoâ€¦</div>
        <div id="rsvpBox" style="margin-top:12px; display:none">
          <div class="row">
            <button class="btn" id="btnYes">âœ”ï¸ AsistirÃ©</button>
            <button class="subtle-btn" id="btnNo">âœ–ï¸ No asistirÃ©</button>
            <span class="meta" id="rsvpStatus"></span>
          </div>
          <div id="qrWrap" style="margin-top:12px; display:none">
            <div class="qr-card"><canvas id="qrCanvas" aria-label="CÃ³digo QR"></canvas></div>
            <div class="meta" style="margin-top:6px">Muestra este QR al llegar.</div>
          </div>
        </div>
      </div>
    </section>
    <!-- PERSONALIZA -->
    <section id="personaliza" class="content">
      <div class="card">
        <h2>âš™ï¸ Edita tu informaciÃ³n</h2>
        <div class="row" style="margin-top:10px">
          <div class="avatar" id="avatarPreview">ğŸ§‘</div>
          <div>
            <label>Foto de perfil (PNG/JPG/WebP, mÃ¡x 2MB)</label>
            <input type="file" id="fAvatar" accept="image/png,image/jpeg,image/webp" />
            <div class="meta">Se previsualiza al seleccionar; se sube al guardar.</div>
          </div>
        </div>
        <form id="editForm">
          <label>Nombre completo</label><input id="fNombre" placeholder="Tu nombre completo" />
          <label>TelÃ©fono</label><input id="fTelefono" placeholder="Ej. 5532120000" />
          <label>Fecha de cumpleaÃ±os</label><input id="fCumple" type="date" />
          <label>CategorÃ­a</label><input id="fCategoria" placeholder="Ej. Enfermera General A" />
          <label>AdscripciÃ³n</label><input id="fAdscripcion" placeholder="Ej. HGR 1, Urgencias" />
          <label>BiografÃ­a corta</label><textarea id="fBio" placeholder="CuÃ©ntanos algo breve"></textarea>
          <button class="btn" type="submit">ğŸ’¾ Guardar cambios</button>
          <div class="status meta" id="status"></div>
        </form>
      </div>
    </section>
  </main>
  <!-- LibrerÃ­as -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    /* ====== Config ====== */
    const SUPABASE_URL = "https://axsncdwshdvsysrpikwj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c25jZHdzaGR2c3lzcnBpa3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjkwMjQsImV4cCI6MjA3NTgwNTAyNH0.oapcH219puVjaR2DcG7dX51uhwVn530L1hhz8ASv7qs";
    const LOGIN_URL = "login.html";
    const SCANNER_REDIRECT_URL = "https://chronosbvrx.github.io/InnovacionSindical/scanner";
    const GOOGLE_API_KEY = "AIzaSyDdtYPPE-jTvw_Gypxrq2c5UePpbK9ZxZ0";
    const CALENDAR_ID = "redunidadenaccion@gmail.com";
    /* ====== Cliente ====== */
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true } });
    const $ = (id) => document.getElementById(id);
    let CURRENT_USER = null, IS_ADMIN = false, MEMBERS_CACHE = [], ONLINE_SET = new Set();
    const debounce = (fn, ms = 200) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
    let POSTS_TOKEN = 0;
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.tab').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const id = btn.dataset.tab;
          if (id === 'scanner') {
            if (!IS_ADMIN) { alert('Necesitas rol admin para acceder al Scanner.'); return; }
            window.location.assign(SCANNER_REDIRECT_URL);
            return;
          }
          document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          $(id).classList.add('active');
          location.hash = id;
          if (id === 'miembros') renderMembers();
          if (id === 'verificacion') initVerification();
          if (id === 'foro') loadPostsDeb();
        });
      });
      $('#btnLogout').addEventListener('click', async () => { await supabase.auth.signOut(); location.href = LOGIN_URL; });
    });
    // Additional JS functions (renderMembers, initVerification, loadPostsDeb, etc.) should be defined elsewhere or imported.
  </script>
</body>

</html>