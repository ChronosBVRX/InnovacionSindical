<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unidad en Acci√≥n ‚Äî Miembros</title>
  <link rel="icon"
    href="https://github.com/ChronosBVRX/InnovacionSindical/blob/main/Logo%20Unidad%20en%20Accion.png?raw=true">
  <style>
    :root {
      --bg: #0b1022;
      --panel: #101a33;
      --ring: rgba(91, 215, 242, .35);
      --txt: #e6fbff;
      --muted: #aee9f7;
      --primary: #5bd7f2;
      --sky: #60a5fa;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto
    }

    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #0b1220, #0b1022);
      color: var(--txt);
      display: flex;
      flex-direction: column
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: rgba(9, 14, 26, .55);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(91, 215, 242, .25)
    }

    header img {
      height: 40px
    }

    header h1 {
      font-size: 18px;
      color: #bff4ff;
      display: flex;
      align-items: center;
      gap: 10px
    }

    #btnLogout {
      background: rgba(255, 70, 70, .15);
      color: #ffaaaa;
      border: 1px solid rgba(255, 100, 100, .35);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer
    }

    #btnLogout:hover {
      background: #ff5555;
      color: #fff
    }

    main {
      flex: 1;
      display: flex;
      min-height: 0
    }

    nav {
      width: 240px;
      background: rgba(11, 18, 32, .75);
      border-right: 1px solid rgba(91, 215, 242, .25);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    nav button {
      appearance: none;
      border: none;
      background: rgba(91, 215, 242, .12);
      color: var(--txt);
      padding: 10px;
      border-radius: 10px;
      text-align: left;
      cursor: pointer;
      transition: .2s
    }

    nav button:hover,
    nav button.active {
      background: linear-gradient(90deg, var(--primary), var(--sky));
      color: #072133;
      font-weight: 600
    }

    section.content {
      flex: 1;
      padding: 20px;
      display: none;
      min-width: 0
    }

    section.content.active {
      display: block
    }

    .card {
      background: var(--panel);
      border: 1px solid rgba(91, 215, 242, .25);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, .25);
      animation: fade .4s ease
    }

    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(10px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    h2 {
      margin-bottom: 10px;
      color: #bff4ff
    }

    p.muted {
      color: var(--muted)
    }

    .profile-info {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 10px;
      flex-wrap: wrap
    }

    .avatar {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: #0a1329;
      border: 1px solid var(--ring);
      display: grid;
      place-items: center;
      font-size: 28px;
      overflow: hidden
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover
    }

    .profile-data p {
      margin: 2px 0
    }

    form {
      display: grid;
      gap: 10px;
      max-width: 560px;
      margin-top: 10px
    }

    label {
      font-size: 13px;
      color: #bdefff
    }

    input,
    textarea,
    select {
      background: #0a1329;
      border: 1px solid rgba(91, 215, 242, .3);
      color: #e6fbff;
      padding: 9px 11px;
      border-radius: 10px
    }

    textarea {
      min-height: 90px;
      resize: vertical
    }

    .btn {
      appearance: none;
      border: none;
      cursor: pointer;
      background: linear-gradient(90deg, var(--primary), var(--sky));
      color: #072133;
      font-weight: 600;
      padding: 10px 16px;
      border-radius: 12px;
      margin-top: 6px;
      transition: .2s
    }

    .btn:hover {
      filter: brightness(1.12)
    }

    .subtle-btn {
      appearance: none;
      border: 1px solid rgba(91, 215, 242, .28);
      background: rgba(91, 215, 242, .08);
      color: #fff;
      padding: 6px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px
    }

    .subtle-btn:hover {
      background: rgba(91, 215, 242, .18)
    }

    .meta {
      font-size: 12px;
      color: #9fdcf0
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(96, 165, 250, .12);
      border: 1px solid rgba(96, 165, 250, .35);
      font-size: 12px;
      color: #cfefff
    }

    iframe {
      width: 100%;
      min-height: 600px;
      border: 0;
      border-radius: 12px
    }

    details.forum-toggle {
      margin-top: 16px
    }

    details.forum-toggle>summary {
      list-style: none;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(91, 215, 242, .10);
      border: 1px solid rgba(91, 215, 242, .28);
      font-weight: 600;
      color: #bff4ff
    }

    details.forum-toggle[open]>summary {
      background: rgba(91, 215, 242, .18)
    }

    details.forum-toggle>summary::-webkit-details-marker {
      display: none
    }

    .rotate {
      transition: transform .2s ease
    }

    details[open] .rotate {
      transform: rotate(90deg)
    }

    .qr-card {
      display: grid;
      place-items: center;
      background: rgba(96, 165, 250, .08);
      border: 1px solid rgba(96, 165, 250, .25);
      border-radius: 12px;
      padding: 12px;
      width: 220px
    }

    .qr-card canvas {
      width: 196px !important;
      height: 196px !important
    }

    @keyframes fadeInSmall {
      from {
        opacity: .6;
        transform: translateY(4px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    @media (max-width:980px) {
      nav {
        width: 100%;
        flex-direction: row;
        position: sticky;
        top: 52px;
        z-index: 9;
        overflow: auto;
      }

      main {
        flex-direction: column
      }
    }

    /* === Layout y extras del PERFIL === */
    .perfil-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .perfil-main {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .perfil-extra {
      flex: 1.3;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .perfil-extra-card {
      background: #0a1329;
      border: 1px solid rgba(91, 215, 242, .35);
      border-radius: 12px;
      padding: 10px 12px;
    }

    .perfil-extra-card h3 {
      margin: 0 0 6px;
      font-size: 14px;
      color: #bff4ff;
    }

    #perfilQuoteText {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }

    #perfilQuoteTag {
      display: block;
      margin-top: 4px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: rgba(174, 233, 247, .85);
    }

    .btn-mini {
      margin-top: 8px;
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(91, 215, 242, .6);
      background: rgba(5, 14, 26, .9);
      color: #e6fbff;
      cursor: pointer;
    }

    .btn-mini:hover {
      background: rgba(91, 215, 242, .18);
    }

    #perfilValorList,
    #perfilAccionesList {
      margin-left: 16px;
      font-size: 13px;
      color: var(--muted);
    }

    #perfilValorList li+li,
    #perfilAccionesList li+li {
      margin-top: 4px;
    }

    .perfil-empty-actions {
      font-size: 13px;
      color: #bbf7d0;
      margin-top: 4px;
    }

    .perfil-tag-acciones {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(248, 250, 252, .1);
      background: rgba(120, 53, 15, .5);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: #fed7aa;
      margin-bottom: 4px;
    }

    @media (min-width:980px) {
      .perfil-layout {
        flex-direction: row;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>
      <img src="https://github.com/ChronosBVRX/InnovacionSindical/blob/main/Logo%20Unidad%20en%20Accion.png?raw=true"
        alt="Logo">
      Unidad en Acci√≥n ‚Äî Miembros
    </h1>
    <button id="btnLogout">Cerrar sesi√≥n</button>
  </header>

  <main>
    <nav>
      <button class="tab active" data-tab="perfil">üë§ Perfil</button>
      <button class="tab" data-tab="miembros">üë• Miembros</button>
      <button class="tab" data-tab="calendario">üìÖ Calendario</button>
      <button class="tab" data-tab="foro">üó£Ô∏è Foro</button>
      <!-- NUEVA PESTA√ëA -->
      <button class="tab" data-tab="videollamadas">üìû Videollamadas</button>
      <!-- ------------- -->
      <button class="tab" data-tab="biblioteca">üìö Biblioteca</button>
      <button class="tab" data-tab="verificacion">‚úÖ Verificaci√≥n</button>
      <button class="tab" data-tab="scanner" id="tabScanner" style="display:none">üîé Scanner</button>
      <button class="tab" data-tab="personaliza">‚öôÔ∏è Personaliza tu perfil</button>
    </nav>

    <!-- PERFIL -->
    <section id="perfil" class="content active">
      <div class="card">
        <div class="perfil-layout">
          <!-- Columna izquierda -->
          <div class="perfil-main">
            <div>
              <h2>üëã Bienvenido</h2>
              <p class="muted">Esta es tu p√°gina de miembro dentro de Unidad en Acci√≥n</p>
              <div class="profile-info">
                <div class="avatar" id="userAvatar">üßë</div>
                <div class="profile-data">
                  <p><strong>Nombre:</strong> <span id="pfName">Cargando‚Ä¶</span></p>
                  <p><strong>Email:</strong> <span id="pfEmail">‚Äî</span></p>
                  <p><strong>Tel√©fono:</strong> <span id="pfTelefono">‚Äî</span></p>
                  <p class="meta" id="pfTelefonoVis" style="margin-top:4px"></p>
                  <p><strong>Cumplea√±os:</strong> <span id="pfCumple">‚Äî</span></p>
                  <p><strong>Categor√≠a:</strong> <span id="pfCategoria">‚Äî</span></p>
                  <p><strong>Adscripci√≥n:</strong> <span id="pfAdscripcion">‚Äî</span></p>
                  <p style="margin-top:8px"><strong>Servicios / habilidades:</strong></p>
                  <p id="pfServicios" class="muted">‚Äî</p>
                </div>
              </div>
            </div>

            <!-- ASISTENCIA -->
            <div class="card" id="asistenciaResumen" style="margin-top:20px; animation:fadeInSmall .2s ease">
              <h3>üìä Asistencia y recompensas</h3>
              <div id="asistData" class="meta" style="margin-bottom:8px">Cargando tus datos...</div>
              <div class="row" style="flex-wrap:wrap;gap:20px">
                <div>
                  <div class="meta">Eventos asistidos (temporada)</div>
                  <div id="asistTotal" style="font-size:26px;font-weight:700">0</div>
                </div>
                <div>
                  <div class="meta">Racha actual (d√≠as)</div>
                  <div id="asistRacha" style="font-size:26px;font-weight:700">0</div>
                </div>
                <div>
                  <div class="meta">Puntos</div>
                  <div id="asistPuntos" style="font-size:26px;font-weight:700">0</div>
                </div>
                <div>
                  <div class="meta">Posici√≥n en ranking</div>
                  <div id="asistTop" style="font-size:26px;font-weight:700">‚Äî</div>
                </div>
              </div>
            </div>

            <!-- MINI TOP -->
            <div class="card" id="miniTop" style="margin-top:12px; animation:fadeInSmall .2s ease">
              <h3>üèÜ Top de asistencia </h3>
              <div id="miniTopMeta" class="meta" style="margin-top:6px">Cargando‚Ä¶</div>
              <div id="miniTopList" style="margin-top:10px;display:grid;gap:8px"></div>
            </div>
          </div>

          <!-- Columna derecha: frases, valor y pr√≥ximas acciones -->
          <aside class="perfil-extra">
            <div class="perfil-extra-card">
              <h3>üí¨ Frase para el equipo</h3>
              <p id="perfilQuoteText">Cargando frase‚Ä¶</p>
              <small id="perfilQuoteTag"></small>
              <button type="button" class="btn-mini" onclick="cambiarFrasePerfil()">Otra frase</button>
            </div>

            <div class="perfil-extra-card">
              <h3>‚≠ê Valor para tu labor sindical</h3>
              <ul id="perfilValorList"></ul>
            </div>

            <div class="perfil-extra-card">
              <span class="perfil-tag-acciones">Pr√≥ximas acciones</span>
              <h3>Lo que puedes completar de tu perfil</h3>
              <p class="meta" style="margin:4px 0 6px;">
                Solo ver√°s lo que hace falta. Cuando completes un dato, desaparecer√° de esta lista.
              </p>
              <ul id="perfilAccionesList"></ul>
              <p id="perfilAccionesEmpty" class="perfil-empty-actions" style="display:none;">
                ‚úÖ Tu perfil est√° completo. Gracias por mantener tus datos actualizados.
              </p>
            </div>
          </aside>
        </div>
      </div>
    </section>

    <!-- MIEMBROS -->
    <section id="miembros" class="content">
      <div class="card">
        <h2>üë• Directorio de Miembros</h2>
        <div class="row" style="margin-top:6px">
          <input id="qMembers" placeholder="Buscar por nombre, adscripci√≥n o servicios" style="min-width:260px">
          <button class="subtle-btn" id="btnRefreshMembers">Actualizar</button>
          <label class="row" style="gap:8px;align-items:center;margin-left:auto">
            <input type="checkbox" id="chkOnlineOnly"><span>üëÅÔ∏è Solo online</span>
          </label>
        </div>
        <div id="membersList" style="margin-top:14px;display:grid;gap:12px"></div>
      </div>
    </section>

    <!-- CALENDARIO -->
    <section id="calendario" class="content">
      <div class="card">
        <h2>üìÖ Calendario de Actividades</h2>
        <iframe
          src="https://calendar.google.com/calendar/embed?src=redunidadenaccion%40gmail.com&ctz=America%2FMexico_City&showTitle=0&showPrint=0&showTz=0&showCalendars=0"></iframe>
      </div>
    </section>

    <!-- FORO -->
    <section id="foro" class="content">
      <div class="card">
        <h2>üó£Ô∏è Foro de Miembros</h2>
        <div id="postsList" class="" style="display:grid;gap:12px"></div>
        <details class="forum-toggle" id="newPostToggle">
          <summary><span class="rotate">‚ñ∏</span><span>Crear una publicaci√≥n</span></summary>
          <form id="forumForm" style="margin-top:12px">
            <label>Escribe una publicaci√≥n (m√°x. 500 caracteres)</label>
            <textarea id="forumInput" maxlength="500" placeholder="¬øQu√© quieres compartir con la comunidad?"></textarea>
            <div class="row">
              <label style="font-size:13px">Categor√≠a</label>
              <select id="forumCategory">
                <option>Avisos</option>
                <option selected>Asuntos Generales</option>
                <option>Convivencia</option>
              </select>
            </div>
            <button class="btn" type="submit">‚ûï Publicar</button>
            <div class="status meta" id="forumStatus"></div>
          </form>
        </details>
      </div>
    </section>

    <!-- üîî NUEVA SECCI√ìN: VIDEOLLAMADAS -->
    <section id="videollamadas" class="content">
      <div class="card">
        <h2>üìû Videollamadas</h2>
        <p class="muted">
          Realiza videollamadas 1 a 1 con otros miembros desde esta misma plataforma.
        </p>
        <iframe src="videollamadas.html"
          style="width:100%;min-height:650px;border:0;border-radius:12px;margin-top:12px" loading="lazy"></iframe>
      </div>
    </section>
    <!-- FIN VIDEOLLAMADAS -->

    <!-- BIBLIOTECA (iframe a biblioteca.html) -->
    <section id="biblioteca" class="content">
      <div class="card">
        <h2>üìö Biblioteca de Recursos</h2>
        <p class="muted">Consulta y explora materiales digitales de la Red Unidad en Acci√≥n.</p>
        <iframe src="biblioteca.html"
          style="width:100%;min-height:650px;border:0;border-radius:12px;margin-top:12px" loading="lazy"></iframe>
      </div>
    </section>

    <!-- VERIFICACI√ìN -->
    <section id="verificacion" class="content">
      <div class="card">
        <h2>‚úÖ Verificaci√≥n de Asistencia</h2>
        <p class="muted">Confirma si asistir√°s al pr√≥ximo evento. Si confirmas, obtendr√°s un QR para registrar tu
          llegada.</p>
        <div id="eventBox" class="meta">Buscando el pr√≥ximo evento‚Ä¶</div>
        <div id="rsvpBox" style="margin-top:12px; display:none">
          <div class="row">
            <button class="btn" id="btnYes">‚úîÔ∏è Asistir√©</button>
            <button class="subtle-btn" id="btnNo">‚úñÔ∏è No asistir√©</button>
            <span class="meta" id="rsvpStatus"></span>
          </div>
          <div id="qrWrap" style="margin-top:12px; display:none">
            <div class="qr-card"><canvas id="qrCanvas" aria-label="C√≥digo QR"></canvas></div>
            <div class="meta" style="margin-top:6px">Muestra este QR al llegar.</div>
          </div>
        </div>

        <!-- Panel solo para admins: resumen de confirmaciones -->
        <div id="adminRSVPPanel" class="perfil-extra-card" style="margin-top:16px; display:none;">
          <h3>üìä Confirmaciones de asistencia (solo admins)</h3>
          <p class="meta" id="adminRSVPText">Cargando‚Ä¶</p>

          <div id="adminRSVPListWrap" style="margin-top:8px; display:none;">
            <p class="meta" style="margin-bottom:4px;">Personas que confirmaron:</p>
            <ul id="adminRSVPList"
              style="margin:0 0 4px 18px; padding:0; font-size:13px; color:var(--muted); list-style:disc;"></ul>
            <p class="meta" id="adminRSVPMore" style="display:none;"></p>
          </div>
        </div>
      </div>
    </section>

    <!-- PERSONALIZA -->
    <section id="personaliza" class="content">
      <div class="card">
        <h2>‚öôÔ∏è Edita tu informaci√≥n</h2>
        <div class="row" style="margin-top:10px">
          <div class="avatar" id="avatarPreview">üßë</div>
          <div>
            <label>Foto de perfil (PNG/JPG/WebP, m√°x 2MB)</label>
            <input type="file" id="fAvatar" accept="image/png,image/jpeg,image/webp">
            <div class="meta">Se previsualiza al seleccionar; se sube al guardar.</div>
          </div>
        </div>
        <form id="editForm">
          <label>Nombre completo</label><input id="fNombre" placeholder="Tu nombre completo">
          <label>Tel√©fono</label><input id="fTelefono" placeholder="Ej. 5532120000">
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="fTelefonoPublico">
            <span>Mostrar mi n√∫mero de tel√©fono a otros miembros</span>
          </label>
          <label>Fecha de cumplea√±os</label><input id="fCumple" type="date">
          <label>Categor√≠a</label><input id="fCategoria" placeholder="Ej. Enfermera General A">
          <label>Adscripci√≥n</label><input id="fAdscripcion" placeholder="Ej. HGR 1, Urgencias">
          <label>Biograf√≠a corta</label><textarea id="fBio" placeholder="Cu√©ntanos algo breve"></textarea>
          <label>Servicios / habilidades que ofreces</label>
          <textarea id="fServicios"
            placeholder="Ej. Asesor√≠a jur√≠dica, apoyo en organizaci√≥n de eventos, dise√±o gr√°fico, etc."></textarea>
          <button class="btn" type="submit">üíæ Guardar cambios</button>
          <div class="status meta" id="status"></div>
        </form>
      </div>
    </section>
  </main>

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <script>
    /* ====== Config ====== */
    const SUPABASE_URL = "https://axsncdwshdvsysrpikwj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c25jZHdzaGR2c3lzcnBpa3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjkwMjQsImV4cCI6MjA3NTgwNTAyNH0.oapcH219puVjaR2DcG7dX51uhwVn530L1hhz8ASv7qs";
    const LOGIN_URL = "login.html";
    const SCANNER_REDIRECT_URL = "https://chronosbvrx.github.io/InnovacionSindical/scanner";
    const GOOGLE_API_KEY = "AIzaSyDdtYPPE-jTvw_Gypxrq2c5UePpbK9ZxZ0";
    const CALENDAR_ID = "redunidadenaccion@gmail.com";

    /* ====== Cliente ====== */
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true } });
    const $ = (id) => document.getElementById(id);

    let CURRENT_USER = null, IS_ADMIN = false, MEMBERS_CACHE = [], ONLINE_SET = new Set();

    /* ====== Debounce / Tokens ====== */
    const debounce = (fn, ms = 200) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
    let POSTS_TOKEN = 0;

    /* ====== Tabs ====== */
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll(".tab").forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const id = btn.dataset.tab;
          if (id === 'scanner') {
            if (!IS_ADMIN) { alert('Necesitas rol admin para acceder al Scanner.'); return; }
            window.location.assign(SCANNER_REDIRECT_URL);
            return;
          }
          document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          $(id).classList.add('active');
          location.hash = id;
          if (id === 'miembros') renderMembers();
          if (id === 'verificacion') initVerification();
          if (id === 'foro') loadPostsDeb();
        });
      });

      $("btnLogout").addEventListener('click', async () => { await supabase.auth.signOut(); location.href = LOGIN_URL; });
      $("btnRefreshMembers")?.addEventListener('click', () => loadMembers(true));
      $("qMembers")?.addEventListener('input', () => renderMembers());
      $("chkOnlineOnly")?.addEventListener('change', () => renderMembers());
      $("editForm")?.addEventListener('submit', onSaveProfile);
      $("fAvatar")?.addEventListener('change', (e) => { const f = e.target.files?.[0]; if (f) { const u = URL.createObjectURL(f); $("avatarPreview").innerHTML = `<img src="${u}">`; } });

      initApp();
    });

    /* ====== App init ====== */
    async function initApp() {
      await supabase.auth.refreshSession();
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { location.href = LOGIN_URL; return; }
      CURRENT_USER = session.user;
      IS_ADMIN = (CURRENT_USER.app_metadata?.role === 'admin');
      if (IS_ADMIN) $("tabScanner").style.removeProperty('display');

      await loadProfile();
      initPerfilExtras();
      await loadMembers(true);
      initPresence();
      initForum();

      const wanted = (location.hash || '#perfil').slice(1);
      if (wanted === 'scanner') { if (IS_ADMIN) window.location.replace(SCANNER_REDIRECT_URL); else (document.querySelector('.tab[data-tab="perfil"]'))?.click(); }
      else { (document.querySelector(`.tab[data-tab="${wanted}"]`) || document.querySelector('.tab[data-tab="perfil"]'))?.click(); }
    }

    /* ====== Helpers ====== */
    function maskPhone(t) { const s = (t || "").replace(/\D+/g, ""); if (s.length < 8) return t || "‚Äî"; return `‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢${s.slice(-4)}`; }
    function formatDateISOtoMX(iso) { if (!iso) return "‚Äî"; try { const d = new Date(iso.length <= 10 ? iso + "T00:00:00" : iso); return new Intl.DateTimeFormat('es-MX', { day: '2-digit', month: 'long', year: 'numeric' }).format(d); } catch { return iso; } }
    const nz = (v) => { if (v == null) return null; const t = String(v).trim(); return t === "" ? null : t; };

    /* ====== Upload avatar ====== */
    async function uploadAvatar(file) {
      if (!file) return null;
      if (!['image/png', 'image/jpeg', 'image/webp'].includes(file.type)) { alert("Formato no soportado"); return null; }
      if (file.size > 2 * 1024 * 1024) { alert("M√°x 2MB"); return null; }
      const uid = CURRENT_USER.id;
      const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
      const path = `${uid}/${Date.now()}.${ext}`;
      const { error } = await supabase.storage.from("avatars").upload(path, file, { cacheControl: "3600", upsert: false, contentType: file.type });
      if (error) { alert("No se pudo subir la imagen"); return null; }
      const { data } = supabase.storage.from("avatars").getPublicUrl(path);
      return data?.publicUrl || null;
    }

    /* ====== Perfil ====== */
    async function loadProfile() {
      const { data: prof } = await supabase
        .from('profiles')
        .select('display_name, avatar_url, categoria, adscripcion, bio, cumple, telefono, telefono_publico, servicios')
        .eq('user_id', CURRENT_USER.id)
        .maybeSingle();

      const telRaw = prof?.telefono || CURRENT_USER.user_metadata?.telefono;
      const telPublicFlag = (prof?.telefono_publico ?? CURRENT_USER.user_metadata?.telefono_publico) === true;
      const serviciosRaw = (prof?.servicios ?? CURRENT_USER.user_metadata?.servicios) || "";

      $("pfName").textContent = prof?.display_name || CURRENT_USER.user_metadata?.display_name || "Sin nombre";
      $("pfEmail").textContent = CURRENT_USER.email || "‚Äî";
      $("pfTelefono").textContent = telRaw || "‚Äî";
      if (!telRaw) {
        $("pfTelefonoVis").textContent = "No has capturado un n√∫mero de tel√©fono.";
      } else {
        $("pfTelefonoVis").textContent = telPublicFlag
          ? "Tu tel√©fono es visible para otros miembros."
          : "Tu tel√©fono NO es visible para otros miembros.";
      }

      $("pfCumple").textContent = formatDateISOtoMX(prof?.cumple || CURRENT_USER.user_metadata?.cumple);
      $("pfCategoria").textContent = (prof?.categoria ?? CURRENT_USER.user_metadata?.categoria) || "‚Äî";
      $("pfAdscripcion").textContent = (prof?.adscripcion ?? CURRENT_USER.user_metadata?.adscripcion) || "‚Äî";
      $("pfServicios").textContent = serviciosRaw.trim() || "‚Äî";

      const avatar = prof?.avatar_url || CURRENT_USER.user_metadata?.avatar_url;
      if (avatar) {
        $("userAvatar").innerHTML = `<img src="${avatar}" alt="avatar">`;
        $("avatarPreview").innerHTML = `<img src="${avatar}" alt="avatar">`;
      } else {
        const ini = (prof?.display_name || CURRENT_USER.email || "?")[0].toUpperCase();
        $("userAvatar").textContent = ini;
        $("avatarPreview").textContent = ini;
      }

      // Prefill form
      $("fNombre").value = prof?.display_name || CURRENT_USER.user_metadata?.display_name || "";
      $("fTelefono").value = telRaw || "";
      $("fTelefonoPublico").checked = !!telPublicFlag;
      try {
        const c = (prof?.cumple || CURRENT_USER.user_metadata?.cumple);
        if (c) {
          const d = new Date(c.length <= 10 ? c + "T00:00:00" : c);
          $("fCumple").value = d.toISOString().slice(0, 10);
        }
      } catch { }
      $("fCategoria").value = prof?.categoria || CURRENT_USER.user_metadata?.categoria || "";
      $("fAdscripcion").value = prof?.adscripcion || CURRENT_USER.user_metadata?.adscripcion || "";
      $("fBio").value = prof?.bio || CURRENT_USER.user_metadata?.bio || "";
      $("fServicios").value = serviciosRaw || "";

      // Pr√≥ximas acciones
      buildNextActionsFromProfile(telRaw, serviciosRaw.trim(), prof?.cumple || CURRENT_USER.user_metadata?.cumple);

      await loadAsistenciaPerfil();
      await loadMiniTopPerfil();
    }

    /* ====== Guardar perfil ====== */
    async function onSaveProfile(e) {
      e.preventDefault();
      $("status").textContent = "Guardando‚Ä¶";
      try {
        const file = $("fAvatar").files?.[0];
        let avatar_url = null;
        if (file) { avatar_url = await uploadAvatar(file); }

        const rawCumple = $("fCumple").value;
        const cumple = nz(rawCumple) ? new Date(rawCumple).toISOString().slice(0, 10) : null;
        const telefono_publico = $("fTelefonoPublico").checked;
        const servicios = nz($("fServicios").value);

        const updates = {
          display_name: nz($("fNombre").value),
          telefono: nz($("fTelefono").value),
          telefono_publico,
          cumple,
          categoria: nz($("fCategoria").value),
          adscripcion: nz($("fAdscripcion").value),
          bio: nz($("fBio").value),
          servicios
        };
        if (avatar_url) updates.avatar_url = avatar_url;

        const { error: authErr } = await supabase.auth.updateUser({ data: updates });
        if (authErr) throw authErr;

        const { error: upErr } = await supabase.from('profiles').upsert({
          user_id: CURRENT_USER.id,
          display_name: updates.display_name,
          avatar_url: updates.avatar_url || CURRENT_USER.user_metadata?.avatar_url || null,
          telefono: updates.telefono,
          telefono_publico: updates.telefono_publico,
          cumple: updates.cumple,
          categoria: updates.categoria,
          adscripcion: updates.adscripcion,
          bio: updates.bio,
          servicios: updates.servicios,
          last_seen: new Date().toISOString()
        }, { onConflict: 'user_id' });

        if (upErr) {
          console.error(upErr);
          $("status").textContent = "‚ùå Error al guardar en profiles. Revisa consola.";
          return;
        }

        $("status").textContent = "‚úÖ Cambios guardados.";
        await loadProfile();
      } catch (e) {
        console.error(e);
        $("status").textContent = "‚ùå Ocurri√≥ un error guardando tu perfil.";
      }
    }

    /* ====== Miembros ====== */
    async function loadMembers(force = false) {
      if (!force && MEMBERS_CACHE.length) return;

      const wrap = $("membersList");
      if (wrap) {
        wrap.innerHTML = '<div class="meta">Cargando miembros‚Ä¶</div>';
      }

      const { data, error } = await supabase
        .from('profiles')
        .select('user_id, display_name, avatar_url, categoria, adscripcion, last_seen, telefono, telefono_publico, servicios')
        .order('last_seen', { ascending: false })
        .limit(1000);

      if (error) {
        console.error("Error cargando members:", error);
        if (wrap) {
          wrap.innerHTML = '<div class="meta">‚ùå No se pudieron cargar los miembros. Revisa consola.</div>';
        }
        return;
      }

      MEMBERS_CACHE = data || [];
      renderMembers();
    }

    function escapeHtml(str) {
      return (str || '').replace(/[&<>\"']/g, s => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[s]));
    }

    // ==== HELPERS PARA AGRUPAR ADSCRIPCIONES SIMILARES ====
    function normalizeText(str) {
      return (str || '')
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")   // quita acentos
        .replace(/[^a-z0-9]+/g, " ")       // todo lo que no sea letra o n√∫mero ‚Üí espacio
        .trim();
    }

    function titleCase(str) {
      return (str || '')
        .split(' ')
        .filter(Boolean)
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(' ');
    }

    // Canonicaliza nombres de adscripciones SIN n√∫mero
    // Solo dejamos como grupos propios: Almac√©n, Delegaci√≥n, Subdelegaci√≥n, Jefatura, Coordinaci√≥n
    function canonicalAdscripcion(norm) {
      if (!norm) return '';

      if (norm.startsWith('almacen')) return 'almacen delegacional';
      if (norm.startsWith('delegacion')) return 'delegacion';
      if (norm.startsWith('subdelegacion')) return 'subdelegacion';
      if (norm.startsWith('jefatura')) return 'jefatura';
      if (norm.startsWith('coordinacion')) return 'coordinacion';

      // Lo dem√°s NO es un grupo propio
      return '';
    }

    // Mapa oficial de adscripciones por prefijo y n√∫mero
    const ADS_OFICIALES = {
      HGR: {
        1: 'HGR No. 1 Charo (Morelia)'
      },
      HGZ: {
        83: 'HGZ No. 83 Morelia (Camelinas)',
        8: 'HGZ No. 8 Uruapan',
        4: 'HGZ No. 4 Zamora',
        12: 'HGZ No. 12 L√°zaro C√°rdenas',
        2: 'HGZ No. 2 Zacapu'
      },
      HGSZ: {
        7: 'HGSZ No. 7 La Piedad',
        9: 'HGSZ No. 9 Apatzing√°n',
        17: 'HGSZ No. 17 Los Reyes',
        24: 'HGSZ No. 24 Pedernales'
      },
      UMF: {
        3: 'UMF No. 3 Quiroga',
        6: 'UMF No. 6 Jiquilpan',
        10: 'UMF No. 10 Jungapeo',
        11: 'UMF No. 11 Nueva Italia',
        13: 'UMF No. 13 Cotija',
        18: 'UMF No. 18 Zit√°cuaro',
        19: 'UMF No. 19 Ciudad Hidalgo',
        20: 'UMF No. 20 P√°tzcuaro',
        21: 'UMF No. 21 Jacona',
        23: 'UMF No. 23 Infiernillo',
        25: 'UMF No. 25 Puruar√°n',
        26: 'UMF No. 26 Taretan',
        28: 'UMF No. 28 Santa Clara',
        37: 'UMF No. 37 Mineral de Angangueo',
        40: 'UMF No. 40 Coalcom√°n',
        42: 'UMF No. 42 Cuitzeo',
        43: 'UMF No. 43 Churumuco',
        46: 'UMF No. 46 La Huacana',
        48: 'UMF No. 48 Huetamo',
        52: 'UMF No. 52 Nuevo Urecho',
        54: 'UMF No. 54 Pur√©pero',
        64: 'UMF No. 64 Puru√°ndiro',
        65: 'UMF No. 65 Villa Madero',
        66: 'UMF No. 66 Villamar',
        70: 'UMF No. 70 Zinap√©cuaro',
        71: 'UMF No. 71 Morelia',
        74: 'UMF No. 74 Tac√°mbaro',
        75: 'UMF No. 75 Morelia (Camelinas)',
        76: 'UMF No. 76 Uruapan',
        77: 'UMF No. 77 La Piedad',
        78: 'UMF No. 78 L√°zaro C√°rdenas',
        80: 'UMF No. 80 Morelia (Centro)',
        81: 'UMF No. 81 Uruapan',
        82: 'UMF No. 82 Zamora',
        84: 'UMF No. 84 Morelia (Tac√≠cuaro)',
        85: 'UMF No. 85 Tar√≠mbaro'
      },
      HR: {
        30: 'HR No. 30 Ario de Rosales',
        31: 'HR No. 31 Huetamo',
        33: 'HR No. 33 Paracho',
        35: 'HR No. 35 Buenavista Tomatl√°n',
        50: 'HR No. 50 Tuxpan',
        51: 'HR No. 51 Villamar',
        59: 'HR No. 59 Coalcom√°n'
      }
    };

    function canonicalPrefixFromToken(token) {
      if (!token) return '';
      const t = token.toLowerCase();
      if (t === 'hgr') return 'HGR';
      if (t === 'hgz') return 'HGZ';
      if (t === 'hgsz') return 'HGSZ';
      if (t === 'umf') return 'UMF';
      if (t === 'hr') return 'HR';
      return t.toUpperCase();
    }

    /**
     * Devuelve { key, label } para agrupar miembros:
     * - Si hay n√∫mero y prefijo (HGR 1, HGZ #86, UMF 12) ‚Üí key "NUM:HGR-001", label desde ADS_OFICIALES o "HGR 1"
     * - Si NO hay n√∫mero:
     *      - si es almac√©n/delegaci√≥n/subdelegaci√≥n/jefatura/coordinaci√≥n ‚Üí grupo propio
     *      - si no, va a "Otras adscripciones"
     */
    function getUnidadGroup(profile) {
      const rawAds = profile.adscripcion || '';
      const normAds = normalizeText(rawAds);

      if (!normAds) {
        return {
          key: 'TXT:SIN_ADSCRIPCION',
          label: 'Sin adscripci√≥n registrada'
        };
      }

      // Buscar un n√∫mero (1-3 d√≠gitos) dentro de la adscripci√≥n
      const numMatch = normAds.match(/(\d{1,3})/);
      if (numMatch) {
        const num = parseInt(numMatch[1], 10);
        if (Number.isFinite(num)) {
          const before = normAds.slice(0, numMatch.index).trim();
          const parts = before.split(' ').filter(Boolean);

          // Buscar prefijo hacia atr√°s (hgr, hgz, hgsz, umf, hr)
          let prefixToken = null;
          for (let i = parts.length - 1; i >= 0; i--) {
            const p = parts[i];
            if (['hgr', 'hgz', 'hgsz', 'umf', 'hr'].includes(p)) {
              prefixToken = p;
              break;
            }
          }
          if (!prefixToken && parts.length) {
            // Si no encontramos prefijo claro, usamos la √∫ltima palabra por compatibilidad
            prefixToken = parts[parts.length - 1];
          }

          let prefix = canonicalPrefixFromToken(prefixToken);
          if (!prefix) prefix = 'Unidad';

          const numKey = num.toString().padStart(3, '0');

          // Buscar nombre oficial en el mapa
          let label = `${prefix} ${num}`;
          if (ADS_OFICIALES[prefix] && ADS_OFICIALES[prefix][num]) {
            label = ADS_OFICIALES[prefix][num];
          }

          return {
            key: `NUM:${prefix}-${numKey}`,
            label
          };
        }
      }

      // SIN n√∫mero ‚Üí solo damos grupo propio a ciertos textos (almac√©n, delegaci√≥n, subdelegaci√≥n, etc.)
      const canon = canonicalAdscripcion(normAds);
      if (canon) {
        return {
          key: 'TXT:' + canon,
          label: titleCase(canon)
        };
      }

      // Todo lo dem√°s va a un grupo gen√©rico
      return {
        key: 'TXT:OTRAS',
        label: 'Otras adscripciones'
      };
    }

    function renderMembers() {
      const wrap = $("membersList");
      if (!wrap) return;

      const q = ($("qMembers")?.value || "").trim().toLowerCase();
      const onlyOnline = $("chkOnlineOnly")?.checked;
      let list = MEMBERS_CACHE.slice();

      // Filtro de b√∫squeda
      if (q) {
        list = list.filter(p =>
          (p.display_name || '').toLowerCase().includes(q) ||
          (p.adscripcion || '').toLowerCase().includes(q) ||
          (p.categoria || '').toLowerCase().includes(q) ||
          (p.servicios || '').toLowerCase().includes(q)
        );
      }

      // Solo online
      if (onlyOnline) {
        list = list.filter(p => ONLINE_SET.has(p.user_id));
      }

      // Online primero
      const online = [];
      const offline = [];
      list.forEach(p => (ONLINE_SET.has(p.user_id) ? online : offline).push(p));
      list = [...online, ...offline];

      wrap.innerHTML = '';
      if (!list.length) {
        wrap.innerHTML = '<div class="meta">No se encontraron miembros.</div>';
        return;
      }

      // AGRUPAR POR UNIDAD
      const grupos = new Map(); // key -> { label, miembros: [] }

      list.forEach(p => {
        const grp = getUnidadGroup(p);
        if (!grupos.has(grp.key)) {
          grupos.set(grp.key, { label: grp.label, miembros: [] });
        }
        grupos.get(grp.key).miembros.push(p);
      });

      // Ordenar grupos:
      // 1) Num√©ricos por prefijo y n√∫mero
      // 2) Luego los de texto por orden alfab√©tico
      const keys = Array.from(grupos.keys());
      keys.sort((a, b) => {
        const isNumA = a.startsWith('NUM:');
        const isNumB = b.startsWith('NUM:');

        if (isNumA && !isNumB) return -1;
        if (!isNumA && isNumB) return 1;

        if (isNumA && isNumB) {
          const [pa, na] = a.slice(4).split('-');
          const [pb, nb] = b.slice(4).split('-');
          if (pa < pb) return -1;
          if (pa > pb) return 1;
          return parseInt(na, 10) - parseInt(nb, 10);
        }

        const la = grupos.get(a).label.toLowerCase();
        const lb = grupos.get(b).label.toLowerCase();
        return la.localeCompare(lb, 'es');
      });

      // Pintar grupos
      keys.forEach(key => {
        const grp = grupos.get(key);
        const miembros = grp.miembros;
        if (!miembros || !miembros.length) return;

        const header = document.createElement('h3');
        header.className = 'meta';
        header.style.margin = '18px 0 6px';
        header.textContent = grp.label;
        wrap.appendChild(header);

        miembros.forEach(p => {
          const card = document.createElement('div');
          card.className = 'card';

          const dot = ONLINE_SET.has(p.user_id) ? 'üü¢ Online' : '‚ö™ Offline';

          const tel = (p.telefono || '').toString().trim();
          const telPublic = !!p.telefono_publico;
          let telDisplay;
          if (!tel) {
            telDisplay = 'Sin tel√©fono';
          } else if (telPublic) {
            telDisplay = tel;
          } else {
            telDisplay = 'No visible';
          }

          const serviciosText = (p.servicios || '').trim();
          const serviciosShort = serviciosText
            ? (serviciosText.length > 100 ? serviciosText.slice(0, 97) + '‚Ä¶' : serviciosText)
            : '';

          card.innerHTML = `
        <div class="row" style="align-items:flex-start">
          <div class="avatar" style="width:64px;height:64px">
            ${p.avatar_url ? `<img src="${p.avatar_url}">` : (p.display_name || '?')[0]?.toUpperCase()}
          </div>
          <div style="flex:1;min-width:200px">
            <div style="font-weight:700">${escapeHtml(p.display_name || '‚Äî')}</div>
            <div class="meta">
              ${escapeHtml(p.categoria || '‚Äî')} ‚Ä¢ ${escapeHtml(p.adscripcion || '‚Äî')}
            </div>
            <div class="meta" style="margin-top:4px">
              üì± ${escapeHtml(telDisplay)}
            </div>
            ${serviciosShort
              ? `<div class="meta" style="margin-top:4px">ü§ù ${escapeHtml(serviciosShort)}</div>`
              : ''}
          </div>
          <span class="pill">${dot}</span>
        </div>
      `;
          wrap.appendChild(card);
        });
      });
    }

    /* ====== Presencia ====== */
    function initPresence() {
      const ch = supabase.channel('presence:members', { config: { presence: { key: CURRENT_USER.id } } });
      ch.on('presence', { event: 'sync' }, () => {
        ONLINE_SET = new Set(Object.keys(ch.presenceState()));
        try { renderMembers(); } catch { }
      });
      ch.subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
          ch.track({ last_active: Date.now() });
          await supabase.from('profiles').update({ last_seen: new Date().toISOString() }).eq('user_id', CURRENT_USER.id);
        }
      });
    }

    /* ====== Foro (likes + comentarios + edici√≥n + eliminaci√≥n) ====== */
    const loadPostsDeb = debounce(loadPosts, 200);

    function initForum() {
      loadPostsDeb();

      supabase
        .channel('realtime-foro')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, loadPostsDeb)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'likes' }, loadPostsDeb)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'comments' }, loadPostsDeb)
        .subscribe();

      $("forumForm")?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = ($("forumInput").value || '').trim(); if (!text) return;
        $("forumStatus").textContent = "Publicando‚Ä¶";
        const cat = $("forumCategory").value || "Asuntos Generales";
        const { error } = await supabase.from('posts').insert({ content: text, user_id: CURRENT_USER.id, category: cat });
        $("forumStatus").textContent = error ? "‚ùå No se pudo publicar: " + (error.message || '') : "‚úÖ Publicado";
        if (!error) { $("forumInput").value = ""; loadPostsDeb(); }
      });
    }

    function fmtDate(iso) {
      try { return new Intl.DateTimeFormat('es-MX', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date(iso)); }
      catch { return iso; }
    }
    function canEditPost(postUserId) { return IS_ADMIN || (postUserId === CURRENT_USER.id); }
    function canDeletePost(postUserId) { return IS_ADMIN || (postUserId === CURRENT_USER.id); }
    function canDeleteComment(commentUserId) { return IS_ADMIN || (commentUserId === CURRENT_USER.id); }

    async function loadPosts() {
      const myToken = ++POSTS_TOKEN;

      const wrap = $("postsList");
      let loading = document.getElementById('postsLoadingMsg');
      if (!loading) {
        loading = document.createElement('div');
        loading.id = 'postsLoadingMsg';
        loading.className = 'meta';
        loading.textContent = 'Cargando publicaciones‚Ä¶';
        wrap.prepend(loading);
      }

      const { data: posts, error } = await supabase
        .from('posts')
        .select('id, content, category, created_at, user_id')
        .order('created_at', { ascending: false })
        .limit(50);

      if (myToken !== POSTS_TOKEN) return;

      wrap.innerHTML = "";

      if (error) { wrap.innerHTML = `<div class="meta">‚ùå Error cargando posts.</div>`; return; }
      if (!posts?.length) { wrap.innerHTML = `<div class="meta">A√∫n no hay publicaciones.</div>`; return; }

      const ids = posts.map(p => p.id);
      const [{ data: allLikes }, { data: myLikes }, { data: comments }] = await Promise.all([
        supabase.from('likes').select('post_id, user_id').in('post_id', ids),
        supabase.from('likes').select('post_id').in('post_id', ids).eq('user_id', CURRENT_USER.id),
        supabase.from('comments').select('id, post_id, user_id, content, created_at').in('post_id', ids).order('created_at', { ascending: true })
      ]);

      if (myToken !== POSTS_TOKEN) return;

      const likeCount = new Map(); (allLikes || []).forEach(l => likeCount.set(l.post_id, (likeCount.get(l.post_id) || 0) + 1));
      const myLiked = new Set((myLikes || []).map(l => l.post_id));
      const commentsByPost = new Map();
      (comments || []).forEach(c => { if (!commentsByPost.has(c.post_id)) commentsByPost.set(c.post_id, []); commentsByPost.get(c.post_id).push(c); });

      posts.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.postId = p.id;
        const liked = myLiked.has(p.id);
        const count = likeCount.get(p.id) || 0;
        const postComments = commentsByPost.get(p.id) || [];

        card.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:center">
        <div class="meta">${p.user_id === CURRENT_USER.id ? 'T√∫' : 'Miembro'} ‚Ä¢ ${fmtDate(p.created_at)}</div>
        <div class="pill">üè∑Ô∏è ${escapeHtml(p.category || 'Asuntos Generales')}</div>
      </div>

      <div class="post-content" style="margin-top:8px;white-space:pre-wrap;line-height:1.45">${escapeHtml(p.content)}</div>

      <div class="row" style="margin-top:10px;gap:10px">
        <button class="subtle-btn btn-like" data-id="${p.id}" aria-pressed="${liked}">
          ${liked ? '‚ù§Ô∏è' : 'ü§ç'} Me gusta <span class="meta">(${count})</span>
        </button>
        <details class="forum-toggle" style="margin:0">
          <summary><span class="rotate">‚ñ∏</span><span>Comentarios (${postComments.length})</span></summary>
          <div class="comments" style="margin-top:10px; display:grid; gap:10px">
            ${postComments.map(c => `
              <div class="card" style="padding:12px">
                <div class="meta">${c.user_id === CURRENT_USER.id ? 'T√∫' : 'Miembro'} ‚Ä¢ ${fmtDate(c.created_at)}</div>
                <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(c.content)}</div>
                ${canDeleteComment(c.user_id) ? `<button class="subtle-btn btn-del-comment" data-cid="${c.id}" data-pid="${p.id}">üóëÔ∏è Borrar comentario</button>` : ``}
              </div>
            `).join('')}
            <form class="comment-form" data-id="${p.id}">
              <label class="meta">A√±adir comentario</label>
              <textarea rows="2" class="comment-input" placeholder="Escribe algo..."></textarea>
              <button class="btn" type="submit">Comentar</button>
              <div class="meta comment-status"></div>
            </form>
          </div>
        </details>
        ${canEditPost(p.user_id) ? `<button class="subtle-btn btn-edit" data-id="${p.id}">‚úèÔ∏è Editar</button>` : ``}
        ${canDeletePost(p.user_id) ? `<button class="subtle-btn btn-del-post" data-id="${p.id}">üóëÔ∏è Borrar</button>` : ``}
      </div>
    `;

        wrap.appendChild(card);
      });

      wrap.querySelectorAll('.btn-like').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault(); e.stopPropagation();
          const postId = btn.dataset.id;
          const isLiked = btn.getAttribute('aria-pressed') === 'true';
          const meta = btn.querySelector('.meta');
          const numMatch = (meta?.textContent.match(/\d+/) || [0])[0];
          let count = parseInt(numMatch, 10) || 0;
          btn.disabled = true;

          if (isLiked) {
            const { error } = await supabase.from('likes').delete().match({ post_id: postId, user_id: CURRENT_USER.id });
            if (!error) {
              btn.setAttribute('aria-pressed', 'false');
              btn.innerHTML = btn.innerHTML.replace('‚ù§Ô∏è', 'ü§ç');
              if (meta) meta.textContent = `(${Math.max(0, count - 1)})`;
            } else alert('‚ùå No se pudo quitar el like: ' + (error.message || ''));
          } else {
            const { error } = await supabase.from('likes').upsert({ post_id: postId, user_id: CURRENT_USER.id }, { onConflict: 'post_id,user_id' });
            if (!error) {
              btn.setAttribute('aria-pressed', 'true');
              btn.innerHTML = btn.innerHTML.replace('ü§ç', '‚ù§Ô∏è');
              if (meta) meta.textContent = `(${count + 1})`;
            } else alert('‚ùå No se pudo dar like: ' + (error.message || ''));
          }
          btn.disabled = false;
        });
      });

      wrap.querySelectorAll('.comment-form').forEach(form => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault(); e.stopPropagation();
          const postId = form.dataset.id;
          const ta = form.querySelector('.comment-input');
          const status = form.querySelector('.comment-status');
          const text = (ta.value || '').trim();
          if (!text) return;
          status.textContent = 'Enviando‚Ä¶';
          const { error } = await supabase.from('comments').insert({ post_id: postId, user_id: CURRENT_USER.id, content: text });
          status.textContent = error ? '‚ùå No se pudo comentar: ' + (error.message || '') : '‚úÖ Comentado';
          if (!error) ta.value = '';
          loadPostsDeb();
        });
      });

      wrap.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault(); e.stopPropagation();
          const postId = btn.dataset.id;
          const card = btn.closest('.card');
          const contentEl = card.querySelector('.post-content');
          const original = contentEl.textContent;

          contentEl.outerHTML = `
        <div class="edit-wrap" style="margin-top:8px;display:grid;gap:8px">
          <textarea class="edit-textarea" style="min-height:120px;background:#0a1329;border:1px solid rgba(91,215,242,.3);color:#e6fbff;padding:9px 11px;border-radius:10px">${escapeHtml(original)}</textarea>
          <div class="row">
            <button class="btn btn-save-edit" data-id="${postId}">üíæ Guardar</button>
            <button class="subtle-btn btn-cancel-edit">Cancelar</button>
            <span class="meta edit-status"></span>
          </div>
        </div>
      `;

          const ta = card.querySelector('.edit-textarea');
          const saveBtn = card.querySelector('.btn-save-edit');
          const cancelBtn = card.querySelector('.btn-cancel-edit');
          const status = card.querySelector('.edit-status');

          cancelBtn.addEventListener('click', (e) => {
            e.preventDefault(); loadPostsDeb();
          });

          saveBtn.addEventListener('click', async () => {
            const newText = (ta.value || '').trim();
            if (!newText) { status.textContent = 'El contenido no puede estar vac√≠o.'; return; }
            status.textContent = 'Guardando‚Ä¶';
            const { error } = await supabase.from('posts').update({ content: newText }).eq('id', postId);
            status.textContent = error ? '‚ùå No se pudo guardar: ' + (error.message || '') : '‚úÖ Guardado';
            if (!error) loadPostsDeb();
          });
        });
      });

      wrap.querySelectorAll('.btn-del-post').forEach(btn => {
        btn.addEventListener('click', async () => {
          const postId = btn.dataset.id;
          if (!confirm('¬øSeguro que deseas borrar esta publicaci√≥n? Esta acci√≥n no se puede deshacer.')) return;
          try { await supabase.from('comments').delete().eq('post_id', postId); } catch (_) { }
          try { await supabase.from('likes').delete().eq('post_id', postId); } catch (_) { }
          const { error } = await supabase.from('posts').delete().eq('id', postId);
          if (error) { alert('‚ùå No se pudo borrar: ' + (error.message || '')); return; }
          loadPostsDeb();
        });
      });

      wrap.querySelectorAll('.btn-del-comment').forEach(btn => {
        btn.addEventListener('click', async () => {
          const commentId = btn.dataset.cid;
          if (!confirm('¬øBorrar este comentario?')) return;
          const { error } = await supabase.from('comments').delete().eq('id', commentId);
          if (error) { alert('‚ùå No se pudo borrar: ' + (error.message || '')); return; }
          loadPostsDeb();
        });
      });
    }

    /* ====== Verificaci√≥n (QR) ====== */
    function formatDateFancy(d) { try { return new Intl.DateTimeFormat('es-MX', { dateStyle: 'full', timeStyle: 'short' }).format(new Date(d)); } catch { return d; } }

    async function fetchNextEvent() {
      if (!GOOGLE_API_KEY) return null;
      const timeMin = new Date().toISOString();
      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events?singleEvents=true&orderBy=startTime&timeMin=${encodeURIComponent(timeMin)}&maxResults=1&key=${encodeURIComponent(GOOGLE_API_KEY)}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        const evt = (json.items || [])[0]; if (!evt) return null;
        return { uid: evt.id, title: evt.summary || 'Evento', start: evt.start?.dateTime || evt.start?.date, location: evt.location || '', description: (evt.description || '').replace(/<[^>]*>/g, '') };
      } catch (e) { console.error(e); return null; }
    }

    async function initVerification() {
      $("rsvpBox").style.display = CURRENT_USER ? 'block' : 'none';
      $("rsvpStatus").textContent = '';
      $("qrWrap").style.display = 'none';

      const adminPanel = $("adminRSVPPanel");
      if (adminPanel && !IS_ADMIN) {
        adminPanel.style.display = "none";
      }

      const evt = await fetchNextEvent();
      if (!evt) {
        $("eventBox").textContent = "No hay eventos pr√≥ximos o no fue posible consultarlos.";
        $("rsvpBox").style.display = 'none';
        if (adminPanel) adminPanel.style.display = "none";
        return;
      }

      $("eventBox").innerHTML = `<div><strong>${escapeHtml(evt.title)}</strong></div><div class="meta">üóìÔ∏è ${formatDateFancy(evt.start)} ${evt.location ? ' ‚Ä¢ üìç ' + escapeHtml(evt.location) : ''}</div>${evt.description ? `<div class="muted" style="white-space:pre-wrap;margin-top:6px">${escapeHtml(evt.description)}</div>` : ''}`;
      window.__NEXT_EVENT__ = evt;

      if (IS_ADMIN) {
        loadAdminRSVPStats(evt.uid);
      }

      const { data } = await supabase.from('rsvps')
        .select('status, qr_payload')
        .eq('user_id', CURRENT_USER.id)
        .eq('event_uid', evt.uid)
        .maybeSingle();

      updateRSVPUI(data?.status || null, data?.qr_payload || null);

      $("btnYes").onclick = () => setRSVP('yes');
      $("btnNo").onclick = () => setRSVP('no');
    }

    function buildQRPayload(evtUid) { return JSON.stringify({ v: 1, event: evtUid, user: CURRENT_USER.id, ts: Date.now() }); }

    async function setRSVP(status) {
      const evt = window.__NEXT_EVENT__; if (!evt) return;
      let qrPayload = null;
      if (status === 'yes') {
        qrPayload = buildQRPayload(evt.uid);
        $("qrWrap").style.display = 'block';
        try { await QRCode.toCanvas($("qrCanvas"), qrPayload, { errorCorrectionLevel: 'M' }); } catch { }
      } else {
        $("qrWrap").style.display = 'none';
      }
      const { error } = await supabase.from('rsvps').upsert({
        user_id: CURRENT_USER.id,
        event_uid: evt.uid,
        status,
        qr_payload: qrPayload,
        updated_at: new Date().toISOString()
      }, { onConflict: 'user_id,event_uid' });
      $("rsvpStatus").textContent = error ? 'No se pudo guardar tu respuesta.' : (status === 'yes' ? 'Confirmado ‚úîÔ∏è' : 'Registrado como no asistente.');
      updateRSVPUI(status, qrPayload);

      if (IS_ADMIN && window.__NEXT_EVENT__) {
        loadAdminRSVPStats(window.__NEXT_EVENT__.uid);
      }
    }

    function updateRSVPUI(status, qrPayload) {
      const yesBtn = $("btnYes"), noBtn = $("btnNo");
      if (status === 'yes') {
        yesBtn.disabled = true; noBtn.disabled = false;
        $("qrWrap").style.display = 'block';
        if (qrPayload) {
          QRCode.toCanvas($("qrCanvas"), qrPayload, { errorCorrectionLevel: 'M' }).catch(() => { });
        }
      } else if (status === 'no') {
        yesBtn.disabled = false; noBtn.disabled = true; $("qrWrap").style.display = 'none';
      } else {
        yesBtn.disabled = false; noBtn.disabled = false; $("qrWrap").style.display = 'none'; $("rsvpStatus").textContent = '';
      }
    }

    /* ====== Resumen de RSVPs solo para admins (con lista de nombres) ====== */
    async function loadAdminRSVPStats(evtUid) {
      if (!IS_ADMIN || !evtUid) return;

      const panel = $("adminRSVPPanel");
      const txt = $("adminRSVPText");
      const listWrap = $("adminRSVPListWrap");
      const listEl = $("adminRSVPList");
      const moreEl = $("adminRSVPMore");

      if (!panel || !txt || !listWrap || !listEl || !moreEl) return;

      panel.style.display = "block";
      listWrap.style.display = "none";
      listEl.innerHTML = "";
      moreEl.style.display = "none";
      txt.textContent = "Cargando‚Ä¶";

      const { data, error } = await supabase
        .from('rsvps')
        .select('status, user_id')
        .eq('event_uid', evtUid);

      if (error) {
        console.error(error);
        txt.textContent = "‚ùå No se pudieron cargar las confirmaciones.";
        return;
      }

      const total = data.length;
      const siReg = data.filter(r => r.status === 'yes');
      const noReg = data.filter(r => r.status === 'no');
      const si = siReg.length;
      const no = noReg.length;
      const otros = total - si - no;

      txt.textContent =
        `Confirmados: ${si} ‚úîÔ∏è ‚Ä¢ No asistir√°n: ${no} ‚úñÔ∏è ‚Ä¢ Registros totales: ${total}` +
        (otros > 0 ? ` ‚Ä¢ Otros estados: ${otros}` : '');

      if (!si) {
        listWrap.style.display = "none";
        return;
      }

      const yesIds = siReg.map(r => r.user_id).filter(Boolean);
      if (!yesIds.length) {
        listWrap.style.display = "none";
        return;
      }

      const { data: perfiles, error: perfErr } = await supabase
        .from('profiles')
        .select('user_id, display_name, categoria, adscripcion')
        .in('user_id', yesIds);

      if (perfErr) {
        console.error(perfErr);
        listWrap.style.display = "none";
        return;
      }

      const MAX_SHOW = 15;
      const ordenados = [...(perfiles || [])].sort((a, b) => {
        const an = (a.display_name || '').toLowerCase();
        const bn = (b.display_name || '').toLowerCase();
        if (an < bn) return -1;
        if (an > bn) return 1;
        return 0;
      });

      listEl.innerHTML = "";
      ordenados.slice(0, MAX_SHOW).forEach(p => {
        const li = document.createElement('li');
        const nombre = p.display_name || 'Miembro sin nombre';
        const cat = p.categoria || '';
        const ads = p.adscripcion || '';
        let extra = '';
        if (cat && ads) extra = ` ‚Äî ${cat} ‚Ä¢ ${ads}`;
        else if (cat) extra = ` ‚Äî ${cat}`;
        else if (ads) extra = ` ‚Äî ${ads}`;
        li.textContent = `${nombre}${extra}`;
        listEl.appendChild(li);
      });

      if (ordenados.length > MAX_SHOW) {
        const restantes = ordenados.length - MAX_SHOW;
        moreEl.textContent = `‚Ä¶y ${restantes} m√°s confirmados.`;
        moreEl.style.display = "block";
      } else {
        moreEl.style.display = "none";
      }

      listWrap.style.display = "block";
    }

    /* ====== Utilidades de asistencia / ranking ====== */
    function seasonOf(dateLike) {
      const d = new Date(dateLike);
      const year = d.toLocaleString('en-CA', { timeZone: 'America/Mexico_City', year: 'numeric' });
      const m = +d.toLocaleString('en-CA', { timeZone: 'America/Mexico_City', month: 'numeric' });
      const q = Math.ceil(m / 3);
      return `${year}-Q${q}`;
    }
    function fmtMX(iso) {
      try { return new Intl.DateTimeFormat('es-MX', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date(iso)); }
      catch { return iso; }
    }

    /* ====== Asistencia dentro del perfil ====== */
    async function loadAsistenciaPerfil() {
      if (!CURRENT_USER) return;
      const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = String(v); };

      const { data: scans, error } = await supabase
        .from('attendance_scans')
        .select('event_uid, scanned_at')
        .eq('attendee_id', CURRENT_USER.id)
        .order('scanned_at', { ascending: false })
        .limit(200);

      const info = document.getElementById('asistData');

      if (error) { info.textContent = "No se pudieron cargar tus datos."; return; }
      if (!scans || scans.length === 0) { info.textContent = "A√∫n no has registrado asistencias."; return; }

      info.textContent = `√öltimo check-in: ${fmtMX(scans[0].scanned_at)}`;

      const currentSeason = seasonOf(new Date());
      const seasonScans = scans.filter(s => seasonOf(s.scanned_at) === currentSeason);

      const seasonDays = [...new Set(seasonScans.map(s => s.scanned_at.slice(0, 10)))];
      const totalTemporada = seasonDays.length;

      const allDays = [...new Set(scans.map(s => s.scanned_at.slice(0, 10)))].sort();
      let racha = 0;
      if (allDays.length) {
        let cur = new Date(); cur.setHours(0, 0, 0, 0);
        if (!allDays.includes(cur.toISOString().slice(0, 10))) cur.setDate(cur.getDate() - 1);
        while (allDays.includes(cur.toISOString().slice(0, 10))) { racha++; cur.setDate(cur.getDate() - 1); }
      }

      let puntos = totalTemporada * 10;
      try {
        const { data: pts } = await supabase
          .from('attendance_points')
          .select('points')
          .eq('user_id', CURRENT_USER.id)
          .eq('season', currentSeason)
          .maybeSingle();
        if (pts?.points != null) puntos = pts.points;
      } catch { }

      let puesto = '‚Äî';
      try {
        const { data: lb } = await supabase
          .from('attendance_leaderboard')
          .select('user_id, display_name, avatar_url, points, total_scans, season')
          .eq('season', currentSeason)
          .order('points', { ascending: false })
          .limit(100);
        const pos = (lb || []).findIndex(row => row.user_id === CURRENT_USER.id);
        if (pos >= 0) puesto = `#${pos + 1}`;
      } catch { }

      set('asistTotal', totalTemporada);
      set('asistRacha', racha);
      set('asistPuntos', puntos);
      set('asistTop', puesto);
    }

    /* ====== Mini TOP en el perfil ====== */
    async function loadMiniTopPerfil() {
      const meta = document.getElementById('miniTopMeta');
      const box = document.getElementById('miniTopList');
      meta.textContent = 'Cargando‚Ä¶'; box.innerHTML = '';

      const currentSeason = seasonOf(new Date());
      try {
        const { data } = await supabase
          .from('attendance_leaderboard')
          .select('user_id, display_name, avatar_url, points, total_scans, season')
          .eq('season', currentSeason)
          .order('points', { ascending: false })
          .limit(5);

        if (!data || !data.length) { meta.textContent = 'A√∫n no hay datos en esta temporada.'; return; }
        meta.textContent = `Temporada: ${currentSeason}`;

        data.forEach((r, idx) => {
          const el = document.createElement('div');
          el.className = 'row';
          el.innerHTML = `
        <div style="width:28px;text-align:right;font-weight:800">${idx + 1}</div>
        <div class="avatar" style="width:36px;height:36px;margin-left:8px">${r.avatar_url ? `<img src="${r.avatar_url}">` : (r.display_name || '?')[0]?.toUpperCase()}</div>
        <div style="flex:1;min-width:160px;margin-left:8px">
          <div style="font-weight:700">${escapeHtml(r.display_name || 'Miembro')}${r.user_id === CURRENT_USER.id ? ' <span class="pill">T√∫</span>' : ''}</div>
          <div class="meta">Asistencias: ${r.total_scans} ‚Ä¢ Puntos: ${r.points}</div>
        </div>`;
          box.appendChild(el);
        });
      } catch (e) {
        meta.textContent = 'No fue posible cargar el ranking.';
      }
    }

    /* ====== Frases, valor extra y pr√≥ximas acciones ====== */
    const FRASES_PERFIL = [
      { texto: "Un solo delegado puede marcar la diferencia, pero un equipo unido transforma la historia.", tag: "Trabajo en equipo" },
      { texto: "La juventud no es el futuro del sindicato, es el presente que lo est√° cambiando.", tag: "Juventud" },
      { texto: "El sindicalismo es la voz organizada de quienes no se rinden ante la injusticia.", tag: "Sindicalismo" },
      { texto: "Ning√∫n derecho se nos regal√≥; todos se conquistaron con organizaci√≥n y compa√±erismo.", tag: "Lucha sindical" },
      { texto: "Cuando un trabajador avanza, toda la organizaci√≥n avanza con √©l.", tag: "Trabajo en equipo" },
      { texto: "Ser joven en el sindicato es tener la oportunidad de convertir la inconformidad en propuesta.", tag: "Juventud" },
      { texto: "La fuerza de un sindicato est√° en la confianza entre sus miembros, no solo en sus documentos.", tag: "Confianza" },
      { texto: "Organizarse es el primer paso; mantenerse unidos es lo que cambia la realidad.", tag: "Unidad" }
    ];

    const VALOR_PERFIL = [
      "Comparte tu perfil con compa√±eros que puedan apoyarte en tu zona o servicio.",
      "Registra tus participaciones en asambleas o actividades para que tu liderazgo quede documentado.",
      "Revisa peri√≥dicamente la biblioteca sindical para conocer nuevos materiales de formaci√≥n.",
      "Mant√©n actualizado tu tel√©fono y habilidades para que puedan contactarte cuando m√°s se necesita.",
      "Agenda recordatorios para fechas clave: asambleas, informes, cursos de formaci√≥n y vencimiento de comisiones.",
      "Consulta los lineamientos y el estatuto antes de cada negociaci√≥n importante."
    ];

    function aplicarFrasePerfil() {
      const t = document.getElementById('perfilQuoteText');
      const tag = document.getElementById('perfilQuoteTag');
      if (!t || !tag) return;
      const f = FRASES_PERFIL[Math.floor(Math.random() * FRASES_PERFIL.length)];
      t.textContent = `"${f.texto}"`;
      tag.textContent = f.tag;
    }

    function aplicarValorPerfil() {
      const ul = document.getElementById('perfilValorList');
      if (!ul) return;
      ul.innerHTML = "";
      const usados = new Set();
      for (let i = 0; i < 3 && i < VALOR_PERFIL.length; i++) {
        let idx;
        do { idx = Math.floor(Math.random() * VALOR_PERFIL.length); } while (usados.has(idx));
        usados.add(idx);
        const li = document.createElement('li');
        li.textContent = VALOR_PERFIL[idx];
        ul.appendChild(li);
      }
    }

    function cambiarFrasePerfil() {
      aplicarFrasePerfil();
    }

    function buildNextActionsFromProfile(tel, servicios, cumple) {
      const ul = document.getElementById('perfilAccionesList');
      const empty = document.getElementById('perfilAccionesEmpty');
      if (!ul || !empty) return;
      ul.innerHTML = "";
      empty.style.display = "none";

      const acciones = [];
      if (!tel) {
        acciones.push("Agrega tu tel√©fono de contacto para que otros compa√±eros puedan localizarte cuando se necesite apoyo.");
      }
      if (!servicios) {
        acciones.push("Describe tus servicios o habilidades (por ejemplo: programaci√≥n, asesor√≠a de contrato colectivo, formaci√≥n, difusi√≥n, etc.).");
      }
      if (!cumple) {
        acciones.push("Captura tu fecha de cumplea√±os para poder considerar reconocimientos y detalles en tu d√≠a.");
      }

      if (acciones.length === 0) {
        empty.style.display = "block";
        return;
      }

      acciones.forEach(txt => {
        const li = document.createElement('li');
        li.textContent = txt;
        ul.appendChild(li);
      });
    }

    function initPerfilExtras() {
      aplicarFrasePerfil();
      aplicarValorPerfil();
    }
  </script>
</body>

</html>
