<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Asistente Generador de Escritos ‚Äî Plataforma Sindical CG</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg-dark: #0f172a;
    --bg-gradient: radial-gradient(circle at top center, #1e293b, #0f172a);
    --panel-bg: rgba(30, 41, 59, 0.7);
    --panel-border: rgba(148, 163, 184, 0.1);
    --primary: #38bdf8;
    --primary-hover: #0ea5e9;
    --accent: #7dd3fc;
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    --input-bg: rgba(15, 23, 42, 0.6);
    --input-border: rgba(148, 163, 184, 0.2);
    --focus-ring: rgba(56, 189, 248, 0.5);
    --radius: 12px;
  }

  * { box-sizing: border-box; }

  html, body {
    height: 100%; margin: 0;
    background: var(--bg-dark);
    background-image: var(--bg-gradient);
    color: var(--text-main);
    font-family: 'Inter', system-ui, sans-serif;
    -webkit-font-smoothing: antialiased;
  }

  .wrap { max-width: 900px; margin: 0 auto; padding: 40px 20px; }

  .header-group { margin-bottom: 30px; text-align: center; }
  h1 {
    margin: 10px 0; font-size: 28px; font-weight: 700;
    background: linear-gradient(90deg, #fff, var(--primary));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  p.muted { color: var(--text-muted); font-size: 15px; margin-top: 5px; line-height: 1.5; }

  .card {
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
    border-radius: 24px;
    padding: 32px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(16px);
  }

  form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

  label { display: block; font-size: 13px; font-weight: 600; color: var(--accent); margin-bottom: 8px; }

  input, select, textarea {
    width: 100%; padding: 12px 16px; border-radius: var(--radius);
    border: 1px solid var(--input-border); background: var(--input-bg);
    color: #fff; font-size: 15px; font-family: inherit; transition: all 0.2s ease;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--primary); outline: none; background: rgba(30, 41, 59, 0.9);
  }

  textarea { min-height: 140px; resize: vertical; grid-column: 1/-1; line-height: 1.6; }
  .grid-full { grid-column: 1/-1; }

  .highlight-section {
    grid-column: 1/-1; background: rgba(56, 189, 248, 0.05);
    border: 1px solid rgba(56, 189, 248, 0.15); padding: 20px; border-radius: 16px;
  }

  .btn {
    appearance: none; border: 1px solid var(--panel-border);
    background: rgba(255, 255, 255, 0.05); color: var(--text-main);
    border-radius: 50px; padding: 12px 24px; font-size: 14px;
    cursor: pointer; font-weight: 600; transition: all 0.2s ease;
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    text-decoration: none;
  }

  .btn.primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-hover));
    border: none; color: #0f172a; box-shadow: 0 4px 15px rgba(56, 189, 248, 0.4);
  }

  /* MODAL Y PREVIEW */
  .modal {
    position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98);
    display: none; align-items: center; justify-content: center; z-index: 1000;
  }
  .modal.show { display: flex; }

  .modal-card {
    width: 95vw; height: 95vh; background: #1e293b; border-radius: 20px;
    display: flex; flex-direction: column; overflow: hidden;
  }

  .modal-h {
    padding: 16px; background: #0f172a; display: flex; 
    justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;
  }

  .modal-b {
    flex: 1; overflow: auto; padding: 40px 20px;
    display: flex; justify-content: center; align-items: flex-start;
    background: #334155;
  }

  .page.carta {
    width: 816px; height: 1056px; background: #fff; color: #111;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5); flex-shrink: 0;
    transform-origin: top center;
  }

  .sheet {
    padding: 72px 64px; font-family: "Times New Roman", Times, serif;
    font-size: 12pt; line-height: 1.5; position: relative; height: 100%;
    color: #000;
  }

  .sheet header { text-align: right; font-weight: bold; margin-bottom: 30px; }
  .sheet .dest { font-weight: bold; text-transform: uppercase; }
  .sheet .cuerpo { text-align: justify; white-space: pre-wrap; margin-top: 20px; }
  .sheet .pie {
    position: absolute; bottom: 80px; left: 64px; right: 64px;
    text-align: center; font-weight: bold;
  }

  #status {
    position: fixed; bottom: 20px; right: 20px; background: #1e293b;
    border-left: 4px solid var(--primary); color: #fff; padding: 12px 20px;
    border-radius: 8px; transform: translateY(100px); transition: 0.3s; z-index: 2000;
  }
  #status.visible { transform: translateY(0); }

  @media (max-width: 768px) {
    form { grid-template-columns: 1fr; }
    .page.carta { transform: scale(0.4); } /* JS lo ajustar√° din√°micamente */
    .modal-h .btn { flex: 1; padding: 8px; font-size: 11px; }
  }
</style>
</head>

<body>
  <div class="wrap">
    <div style="margin-bottom: 20px;">
      <a class="btn" href="https://chronosbvrx.github.io/InnovacionSindical/">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        Regresar al men√∫
      </a>
    </div>

    <div class="header-group">
      <h1>Asistente Generador de Escritos</h1>
      <p class="muted">Redacta oficios profesionales con IA. Universal para PC y M√≥vil.</p>
    </div>

    <div class="card">
      <form id="fDenuncia">
        <div class="highlight-section">
          <label for="puestoCatalogo">1. ¬øA qui√©n va dirigido el escrito?</label>
          <select id="puestoCatalogo" required>
            <option value="">‚Äî Selecciona la Secretar√≠a o Comisi√≥n ‚Äî</option>
            <optgroup label="Secretar√≠as">
              <option value="Secretar√≠a General|Dr. Juan Gerardo Garc√≠a Gonz√°lez">Secretar√≠a General</option>
              <option value="Secretar√≠a del Interior y Propaganda|M.N.F. Amin Uriel Morales S√°nchez">Secretar√≠a del Interior y Propaganda</option>
              <option value="Secretar√≠a de Conflictos|C.E. Arturo Ochoa Huacuz">Secretar√≠a de Conflictos</option>
              <option value="Secretar√≠a del Trabajo|M.N.F. Carlos Alberto Guerrero Rasc√≥n">Secretar√≠a del Trabajo</option>
              <option value="Secretar√≠a de Asuntos al Exterior|M.N.F. Ignacio Agust√≠n Orozco P√©rez">Secretar√≠a de Asuntos al Exterior</option>
              <option value="Tesorer√≠a|EST. Azucena Herrera Mart√≠nez">Tesorer√≠a</option>
              <option value="Secretar√≠a de Previsi√≥n Social|O.T. Laura Ram√≠rez Huitzacua">Secretar√≠a de Previsi√≥n Social</option>
              <option value="Secretar√≠a de Igualdad Sustantiva|M.F. Gabriela Dur√°n Negrete">Secretar√≠a de Igualdad Sustantiva</option>
              <option value="Secretar√≠a de Asuntos T√©cnicos|M.N.F. Horacio Pe√±a Alfaro">Secretar√≠a de Asuntos T√©cnicos</option>
              <option value="Secretar√≠a de Actas y Acuerdos|M.A. C√©sar Augusto Contreras Flores">Secretar√≠a de Actas y Acuerdos</option>
              <option value="Secretar√≠a de Prensa|A.M. Yolanda Morelos Palomares">Secretar√≠a de Prensa</option>
              <option value="Secretar√≠a de Puestos Perif√©ricos|M.G. Luz Nayelly Esquivel Mart√≠nez">Secretar√≠a de Puestos Perif√©ricos</option>
              <option value="Secretar√≠a de Admisi√≥n y Cambios|J.G.E. Cecilio Vanegas Villalobos">Secretar√≠a de Admisi√≥n y Cambios</option>
              <option value="Secretar√≠a de Capacitaci√≥n y Adiestramiento|O.P. Am√©rica Hilda Reyes Reyes">Secretar√≠a de Capacitaci√≥n y Adiestramiento</option>
              <option value="Secretar√≠a de Calidad y Modernizaci√≥n|M.N.F. Carlos Mojica Rodr√≠guez">Secretar√≠a de Calidad y Modernizaci√≥n</option>
            </optgroup>
            <optgroup label="Comisiones">
              <option value="Comisi√≥n de Honor y Justicia ‚Äî Presidencia|C.S.T. Jos√© Francisco Ruiz Dom√≠nguez">Honor y Justicia ‚Äî Presidencia</option>
              <option value="Comisi√≥n de Hacienda ‚Äî Presidencia|A.M. Fabiola Far√≠as Ambriz">Hacienda ‚Äî Presidencia</option>
              <option value="Comisi√≥n de Vigilancia ‚Äî Presidencia|A.M. Imelda Reyes L√≥pez">Vigilancia ‚Äî Presidencia</option>
            </optgroup>
            <optgroup label="Subcomisiones Mixtas">
              <option value="Subcomisi√≥n Mixta de Becas ‚Äî Representaci√≥n Sindical|M.F. Jorge H√©ctor Zaragoza Palacios">Becas</option>
              <option value="Subcomisi√≥n Mixta de Bolsa de Trabajo ‚Äî Representaci√≥n Sindical|COORD. CONT. Uriel Tapia P√©rez">Bolsa de Trabajo</option>
              <option value="Subcomisi√≥n Mixta Disciplinaria ‚Äî Representaci√≥n Sindical|Cont. Juan Carlos Serv√≠n Ju√°rez">Disciplinaria</option>
              <option value="Subcomisi√≥n Mixta de Escalaf√≥n ‚Äî Representaci√≥n Sindical|E.G. Hilda Ontiveros Cuellar">Escalaf√≥n</option>
              <option value="Subcomisi√≥n Mixta de Jubilaciones y Pensiones ‚Äî Representaci√≥n Sindical|E.G.C. Maricela Navarrete Mora">Jubilaciones y Pensiones</option>
            </optgroup>
          </select>
        </div>

        <input type="hidden" id="cargo">
        <div>
          <label>Nombre del titular (Autom√°tico)</label>
          <input id="destinatario" readonly placeholder="Se llena al elegir puesto...">
        </div>
        <div>
          <label>Fecha del escrito</label>
          <input id="fecha" type="date">
        </div>

        <div class="grid-full"><hr style="border:0; border-top:1px solid var(--panel-border);"></div>

        <div>
          <label>Nombre del trabajador</label>
          <input id="nombre" required placeholder="Nombre completo">
        </div>
        <div>
          <label>Matr√≠cula</label>
          <input id="matricula" required placeholder="Ej. 123456" inputmode="numeric">
        </div>
        <div>
          <label>Categor√≠a</label>
          <input id="categoria" required placeholder="Ej. Enfermera General A">
        </div>
        <div>
          <label>Adscripci√≥n</label>
          <input id="lugar" placeholder="Ej. HGZ No. XX">
        </div>
        <div class="grid-full">
          <label>Ciudad / Municipio</label>
          <input id="ciudad" placeholder="Ej. L√°zaro C√°rdenas, Michoac√°n" required>
        </div>

        <div class="grid-full">
          <label>Descripci√≥n de los hechos (La IA redactar√° formalmente)</label>
          <textarea id="problematica" required placeholder="Explica qu√© sucedi√≥ y qu√© solicitas..."></textarea>
        </div>

        <div class="grid-full" style="display: flex; gap: 12px; justify-content: flex-end; align-items: center; flex-wrap: wrap;">
          <span style="font-size: 12px; color: var(--text-muted);">Formato Carta garantizado.</span>
          <button type="button" class="btn" id="btnPreview">üëÅÔ∏è Vista Previa</button>
          <button type="submit" class="btn primary">üöÄ Generar Documento</button>
        </div>
      </form>
    </div>
  </div>

  <div id="status"></div>

  <div id="modal" class="modal">
    <div class="modal-card">
      <div class="modal-h">
        <span style="color:white; font-weight:bold;">Vista Previa del Oficio</span>
        <div style="display:flex; gap:8px;">
          <button class="btn" id="btnCopy">üìã Copiar</button>
          <button class="btn" id="btnDownload">‚¨áÔ∏è PDF</button>
          <button class="btn primary" id="btnPrint">üñ®Ô∏è Imprimir</button>
          <button class="btn" id="btnClose" style="color:#ef4444; border-color:rgba(239,68,68,0.3);">‚úñ</button>
        </div>
      </div>
      <div class="modal-b" id="modalBody">
        <div id="page" class="page carta">
          <div id="sheet" class="sheet"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const API_BASE = "https://sinos-api.onrender.com";
      const FORM_KEY = 'sinos_denuncias_v1';
      const $ = s => document.querySelector(s);

      const showStatus = (t) => {
        const s = $('#status');
        s.textContent = t;
        s.classList.add('visible');
        setTimeout(() => s.classList.remove('visible'), 4000);
      };

      // Ajuste de escala din√°mico para m√≥viles
      const ajustarEscala = () => {
        const modalB = $('#modalBody');
        if (!modalB) return;
        const availableWidth = modalB.clientWidth - 40;
        const sheetWidth = 816;
        const scale = availableWidth < sheetWidth ? availableWidth / sheetWidth : 1;
        const page = $('#page');
        page.style.transform = `scale(${scale})`;
        page.style.marginBottom = availableWidth < sheetWidth ? `-${1056 * (1 - scale)}px` : "0";
      };

      window.addEventListener('resize', ajustarEscala);

      // Cargar/Guardar datos locales
      const saveLocal = () => {
        const d = {
          puesto: $('#puestoCatalogo').value,
          dest: $('#destinatario').value,
          cargo: $('#cargo').value,
          fecha: $('#fecha').value,
          nombre: $('#nombre').value,
          mat: $('#matricula').value,
          cat: $('#categoria').value,
          lug: $('#lugar').value,
          ciu: $('#ciudad').value,
          prob: $('#problematica').value
        };
        localStorage.setItem(FORM_KEY, JSON.stringify(d));
      };

      const loadLocal = () => {
        const raw = localStorage.getItem(FORM_KEY);
        if (!raw) return;
        const d = JSON.parse(raw);
        $('#puestoCatalogo').value = d.puesto || '';
        $('#destinatario').value = d.dest || '';
        $('#cargo').value = d.cargo || '';
        $('#fecha').value = d.fecha || new Date().toISOString().slice(0,10);
        $('#nombre').value = d.nombre || '';
        $('#matricula').value = d.mat || '';
        $('#categoria').value = d.cat || '';
        $('#lugar').value = d.lug || '';
        $('#ciudad').value = d.ciu || '';
        $('#problematica').value = d.prob || '';
      };

      $('#puestoCatalogo').addEventListener('change', (e) => {
        const [cargo, nombre] = e.target.value.split('|');
        $('#cargo').value = cargo || '';
        $('#destinatario').value = nombre || '';
        saveLocal();
      });

      $('form').addEventListener('input', saveLocal);

      async function redactarIA(prob) {
        showStatus("üß† Redactando escrito formal...");
        try {
          const res = await fetch(`${API_BASE}/escritor`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              tema: "Oficio sindical de hechos o denuncia",
              hechos: [prob],
              extras: "Tono formal, profesional, m√°ximo 3 p√°rrafos, incluye una despedida de respeto.",
              incluirDespedida: true
            })
          });
          const data = await res.json();
          return data.cuerpo || "No se pudo generar el texto.";
        } catch (e) {
          return "Por medio de la presente, expongo ante usted los siguientes hechos: \n\n" + prob;
        }
      }

      const generarContenido = (d, cuerpo) => {
        const fLarga = new Date(d.fecha + 'T12:00:00').toLocaleDateString('es-MX', {day:'2-digit', month:'long', year:'numeric'});
        return `
          <header>${d.ciudad}, a ${fLarga}</header>
          <div class="dest">${d.destinatario}</div>
          <div style="font-weight:bold; margin-bottom:5px;">${d.cargo}</div>
          <div>Presente.</div>
          <div class="cuerpo">${cuerpo}</div>
          <div class="pie">
            ATENTAMENTE<br><br><br><br>
            ${d.nombre}<br>
            Matr√≠cula: ${d.matricula}<br>
            ${d.categoria}<br>
            ${d.lugar}
          </div>
        `;
      };

      $('#btnPreview').addEventListener('click', async () => {
        if (!$('form').checkValidity()) return alert("Por favor completa los campos obligatorios.");
        const d = {
          ciudad: $('#ciudad').value,
          fecha: $('#fecha').value,
          destinatario: $('#destinatario').value,
          cargo: $('#cargo').value,
          nombre: $('#nombre').value,
          matricula: $('#matricula').value,
          categoria: $('#categoria').value,
          lugar: $('#lugar').value
        };
        const cuerpoIA = await redactarIA($('#problematica').value);
        $('#sheet').innerHTML = generarContenido(d, cuerpoIA);
        $('#modal').classList.add('show');
        ajustarEscala();
      });

      $('#btnClose').addEventListener('click', () => $('#modal').classList.remove('show'));

      async function crearPDF() {
        showStatus("üìÑ Generando PDF...");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'letter' });
        
        // Clon para renderizado limpio
        const clone = $('#sheet').cloneNode(true);
        clone.style.width = "816px";
        clone.style.padding = "72px 64px";
        clone.style.background = "white";
        clone.style.position = "absolute";
        clone.style.left = "-9999px";
        document.body.appendChild(clone);

        await doc.html(clone, {
          x: 0, y: 0, width: 612, windowWidth: 816
        });

        doc.save(`Oficio_${$('#matricula').value}.pdf`);
        document.body.removeChild(clone);
        showStatus("‚úÖ Descargado.");
      }

      $('#btnDownload').addEventListener('click', crearPDF);
      $('#fDenuncia').addEventListener('submit', (e) => { e.preventDefault(); crearPDF(); });

      $('#btnPrint').addEventListener('click', () => {
        const originalTitle = document.title;
        document.title = "Oficio_Sindical";
        window.print();
        document.title = originalTitle;
      });

      $('#btnCopy').addEventListener('click', () => {
        navigator.clipboard.writeText($('#sheet').innerText);
        showStatus("üìã Copiado al portapapeles.");
      });

      loadLocal();
      if (!$('#fecha').value) $('#fecha').value = new Date().toISOString().slice(0,10);
    });
  </script>
</body>
</html>
