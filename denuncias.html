<!DOCTYPE html>
<html lang="es">

<head>
  <!DOCTYPE html>
  <html lang="es">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Denuncias y Reportes ‚Äî SInOS</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="stylesheet" href="theme.css">
    <div class="top-actions" style="gap:10px">
      <button id="btnBack" class="subtle-btn" style="font-size:16px" title="Atr√°s">‚¨Ö</button>
      <a class="subtle-btn" href="index.html" style="font-size:16px; text-decoration:none" title="Inicio">üè†</a>
    </div>

    <h1>Denuncias y Reportes</h1>
    <p class="muted">Previsualiza el documento y luego imprime o descarga. Tus datos se guardan localmente en este
      navegador.</p>

    <div class="card">
      <form id="fDenuncia" autocomplete="on" novalidate>
        <!-- ‚ñ∫ Cat√°logo de puestos (carga titular + cargo oculto) -->
        <div class="grid-1">
          <label for="puestoCatalogo">Selecciona puesto (secretar√≠a / presidencia / subcomisi√≥n)</label>
          <select id="puestoCatalogo">
            <option value="">‚Äî Elegir ‚Äî</option>

            <!-- Secretar√≠as -->
            <optgroup label="Secretar√≠as">
              <option value="Secretar√≠a General|Dr. Juan Gerardo Garc√≠a Gonz√°lez">Secretar√≠a General</option>
              <option value="Secretar√≠a del Interior y Propaganda|M.N.F. Amin Uriel Morales S√°nchez">Secretar√≠a del
                Interior y Propaganda</option>
              <option value="Secretar√≠a de Conflictos|C.E. Arturo Ochoa Huacuz">Secretar√≠a de Conflictos</option>
              <option value="Secretar√≠a del Trabajo|M.N.F. Carlos Alberto Guerrero Rasc√≥n">Secretar√≠a del Trabajo
              </option>
              <option value="Secretar√≠a de Asuntos al Exterior|M.N.F. Ignacio Agust√≠n Orozco P√©rez">Secretar√≠a de
                Asuntos al Exterior</option>
              <option value="Tesorer√≠a|EST. Azucena Herrera Mart√≠nez">Tesorer√≠a</option>
              <option value="Secretar√≠a de Previsi√≥n Social|O.T. Laura Ram√≠rez Huitzacua">Secretar√≠a de Previsi√≥n Social
              </option>
              <option value="Secretar√≠a de Igualdad Sustantiva|M.F. Gabriela Dur√°n Negrete">Secretar√≠a de Igualdad
                Sustantiva</option>
              <option value="Secretar√≠a de Asuntos T√©cnicos|M.N.F. Horacio Pe√±a Alfaro">Secretar√≠a de Asuntos T√©cnicos
              </option>
              <option value="Secretar√≠a de Actas y Acuerdos|M.A. C√©sar Augusto Contreras Flores">Secretar√≠a de Actas y
                Acuerdos</option>
              <option value="Secretar√≠a de Prensa|A.M. Yolanda Morelos Palomares">Secretar√≠a de Prensa</option>
              <option value="Secretar√≠a de Puestos Perif√©ricos|M.G. Luz Nayelly Esquivel Mart√≠nez">Secretar√≠a de Puestos
                Perif√©ricos</option>
              <option value="Secretar√≠a de Admisi√≥n y Cambios|J.G.E. Cecilio Vanegas Villalobos">Secretar√≠a de Admisi√≥n
                y Cambios</option>
              <option value="Secretar√≠a de Capacitaci√≥n y Adiestramiento|O.P. Am√©rica Hilda Reyes Reyes">Secretar√≠a de
                Capacitaci√≥n y Adiestramiento</option>
              <option value="Secretar√≠a de Calidad y Modernizaci√≥n|M.N.F. Carlos Mojica Rodr√≠guez">Secretar√≠a de Calidad
                y Modernizaci√≥n</option>
            </optgroup>

            <!-- Comisiones (s√≥lo Presidencias) -->
            <optgroup label="Comisiones ‚Äî Presidencias">
              <option value="Comisi√≥n de Honor y Justicia ‚Äî Presidencia|C.S.T. Jos√© Francisco Ruiz Dom√≠nguez">Honor y
                Justicia ‚Äî Presidencia</option>
              <option value="Comisi√≥n de Hacienda ‚Äî Presidencia|A.M. Fabiola Far√≠as Ambriz">Hacienda ‚Äî Presidencia
              </option>
              <option value="Comisi√≥n de Vigilancia ‚Äî Presidencia|A.M. Imelda Reyes L√≥pez">Vigilancia ‚Äî Presidencia
              </option>
              <option value="Comisi√≥n de Deportes ‚Äî Presidencia|J.G.P. Roberto Carlos Reyes Ortiz">Deportes ‚Äî
                Presidencia</option>
              <option value="Comisi√≥n de Fomento a la Seguridad Social ‚Äî Presidencia|Q.C. Gerardo Ordaz Salazar">Fomento
                a la Seguridad Social ‚Äî Presidencia</option>
              <option value="Comisi√≥n de Acci√≥n Pol√≠tica ‚Äî Presidencia|Lab. Irving Cruz Guerrero Castro">Acci√≥n Pol√≠tica
                ‚Äî Presidencia</option>
            </optgroup>

            <!-- Subcomisiones mixtas (representaci√≥n sindical) -->
            <optgroup label="Subcomisiones mixtas ‚Äî Representaci√≥n sindical">
              <option value="Subcomisi√≥n Mixta de Becas ‚Äî Representaci√≥n Sindical|M.F. Jorge H√©ctor Zaragoza Palacios">
                Becas</option>
              <option
                value="Subcomisi√≥n Mixta de Bolsa de Trabajo ‚Äî Representaci√≥n Sindical|COORD. CONT. Uriel Tapia P√©rez">
                Bolsa de Trabajo</option>
              <option
                value="Subcomisi√≥n Mixta de Puestos de Confianza ‚ÄúB‚Äù ‚Äî Representaci√≥n Sindical|E.G. C√°ndido Mora Alcauter">
                Puestos de Confianza ‚ÄúB‚Äù</option>
              <option
                value="Subcomisi√≥n Mixta de Capacitaci√≥n y Adiestramiento ‚Äî Representaci√≥n Sindical|A.E.G. Juan Onofre Baez">
                Capacitaci√≥n y Adiestramiento</option>
              <option
                value="Subcomisi√≥n Mixta Aux. de Capacitaci√≥n y Adiestramiento ‚Äî Representaci√≥n Sindical|A.M. Araceli Barajas Flores">
                Aux. Capacitaci√≥n y Adiestramiento</option>
              <option
                value="Subcomisi√≥n Mixta de Seguridad e Higiene ‚Äî Representaci√≥n Sindical|A.U.O. Betsabe Hern√°ndez Flores">
                Seguridad e Higiene</option>
              <option
                value="Subcomisi√≥n Mixta Aux. de Seguridad e Higiene ‚Äî Representaci√≥n Sindical|A.U.O. Carmen Lizeth Ruiz Aguilar">
                Aux. Seguridad e Higiene (1)</option>
              <option
                value="Subcomisi√≥n Mixta Aux. de Seguridad e Higiene ‚Äî Representaci√≥n Sindical|A.S.G. Sergio Ortiz Mart√≠nez">
                Aux. Seguridad e Higiene (2)</option>
              <option value="Subcomisi√≥n Mixta Disciplinaria ‚Äî Representaci√≥n Sindical|Cont. Juan Carlos Serv√≠n Ju√°rez">
                Disciplinaria</option>
              <option value="Subcomisi√≥n Mixta de Escalaf√≥n ‚Äî Representaci√≥n Sindical|E.G. Hilda Ontiveros Cuellar">
                Escalaf√≥n</option>
              <option
                value="Subcomisi√≥n Mixta Paritaria de Protecci√≥n al Salario ‚Äî Representaci√≥n Sindical|M.N.F. J. Guadalupe Hern√°ndez Alcal√°">
                Paritaria de Protecci√≥n al Salario</option>
              <option
                value="Subcomisi√≥n Mixta de Pasajes ‚Äî Representaci√≥n Sindical|O.A. Jos√© Antonio Carrillo Bejarano">
                Pasajes</option>
              <option
                value="Subcomisi√≥n Mixta de Ropa de Trabajo y Uniformes ‚Äî Representaci√≥n Sindical|A.A. Julio Cesar Garc√≠a Salgado">
                Ropa de Trabajo y Uniformes</option>
              <option
                value="Subcomisi√≥n Mixta de Selecci√≥n de Recursos Humanos para Cambios de Rama ‚Äî Representaci√≥n Sindical|J.G.E. Gilberto Herrej√≥n Gonz√°lez">
                Selecci√≥n RH (Cambios de Rama)</option>
              <option value="Subcomisi√≥n Mixta de Tiendas ‚Äî Representaci√≥n Sindical|P.E.F.B. Humberto Guerrero Linares">
                Tiendas</option>
              <option
                value="Subcomisi√≥n Mixta de Jubilaciones y Pensiones ‚Äî Representaci√≥n Sindical|E.G.C. Maricela Navarrete Mora">
                Jubilaciones y Pensiones</option>
              <option
                value="Subcomisi√≥n Mixta de Revisi√≥n de Plantillas ‚Äî Representaci√≥n Sindical|E.G. Luis Fernando Garc√≠a Cervantes">
                Revisi√≥n de Plantillas</option>
            </optgroup>
          </select>
        </div>

        <div>
          <label for="ciudad">Ciudad / Municipio</label>
          <input id="ciudad" name="ciudad" placeholder="Ej. L√°zaro C√°rdenas, Michoac√°n" required>
        </div>
        <div>
          <label for="fecha">Fecha (si la de hoy no aplica)</label>
          <input id="fecha" name="fecha" type="date">
        </div>

        <div>
          <label for="destinatario">Nombre del destinatario</label>
          <input id="destinatario" name="destinatario" placeholder="Selecciona un puesto‚Ä¶" readonly aria-readonly="true"
            required>
        </div>
        <!-- Cargo oculto (no visible, pero se usa en el documento) -->
        <input id="cargo" name="cargo" type="hidden">

        <div>
          <label for="nombre">Nombre del trabajador</label>
          <input id="nombre" name="nombre" required placeholder="Nombre(s) y apellidos">
        </div>
        <div>
          <label for="matricula">Matr√≠cula</label>
          <input id="matricula" name="matricula" required placeholder="Ej. 123456" inputmode="numeric" pattern="\\d+">
        </div>
        <div>
          <label for="categoria">Categor√≠a</label>
          <input id="categoria" name="categoria" required placeholder="Ej. Enfermera General A">
        </div>
        <div>
          <label for="lugar">Centro/√Årea</label>
          <input id="lugar" name="lugar" placeholder="Ej. HGZ No. XX, Urgencias">
        </div>

        <div class="grid-1">
          <label for="problematica">Describe la problem√°tica (hechos, fechas, lugares, involucrados, impacto)</label>
          <textarea id="problematica" name="problematica" required></textarea>
        </div>

        <div class="row">
          <button type="button" class="btn" id="btnPreview">üëÅÔ∏è Vista previa</button>
          <button type="submit" class="btn primary" id="btnGenerar">üñ®Ô∏è Generar PDF e imprimir</button>
          <span class="small">Formato: Carta / m√°rgenes normales.</span>
        </div>
      </form>
    </div>
    </div>

    <div id="status" aria-live="polite"></div>

    <!-- Modal de vista previa -->
    <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-card" tabindex="-1">
        <div class="modal-h">
          <div class="modal-t" id="modal-title">Vista previa del escrito</div>
          <div class="modal-a">
            <button class="btn" id="btnCopy" type="button">üìã Copiar texto</button>
            <button class="btn" id="btnDownload" type="button">‚¨áÔ∏è Descargar PDF</button>
            <button class="btn primary" id="btnPrint" type="button">üñ®Ô∏è Imprimir</button>
            <button class="btn" id="btnClose" type="button">‚úñ Cerrar</button>
          </div>
        </div>
        <div class="modal-b">
          <div id="page" class="page carta">
            <div id="sheet" class="sheet"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- html2canvas (requerido por doc.html) -->
    <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- jsPDF -->
    <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // === CONFIG ===
        const API_BASE = "https://sinos-api.onrender.com"; // tu API p√∫blica en Render
        const FORM_KEY = 'sinos_denuncias_v1';

        const $ = s => document.querySelector(s);
        const N = s => (s || '').toString().trim();
        const setStatus = (t = '') => $('#status').textContent = t;

        // ‚úî FIX jsPDF + html2canvas: espera a que ambos est√©n listos
        const ensureJsPDF = () => new Promise((resolve, reject) => {
          let tries = 0;
          const t = setInterval(() => {
            tries++;
            if (window.jspdf && window.jspdf.jsPDF && window.html2canvas) {
              clearInterval(t);
              resolve(window.jspdf); // { jsPDF, ... }
            }
            if (tries > 200) { // ~10s
              clearInterval(t);
              reject(new Error('jsPDF/html2canvas no cargaron'));
            }
          }, 50);
        });

        const hoyISO = () => new Date().toISOString().slice(0, 10);
        const fechaLarga = (iso) => {
          const d = iso ? new Date(iso) : new Date();
          return d.toLocaleDateString('es-MX', { day: '2-digit', month: 'long', year: 'numeric' });
        };

        // ===== Utils de seguridad: escapar HTML =====
        function escapeHTML(s) {
          return (s || '').replace(/[&<>"']/g, m => (
            { "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[m]
          ));
        }

        // ===== IA: redacta usando SOLO problematica con timeout =====
        async function redactarIA(d) {
          const ctrl = new AbortController();
          const timeout = setTimeout(() => ctrl.abort(), 12000); // 12 s
          try {
            setStatus("Redactando texto con IA‚Ä¶");

            const hechos = [];
            if (N(d.problematica)) hechos.push(N(d.problematica));

            const payload = {
              tema: "Escrito de denuncia o reporte",
              tono: "formal",
              hechos,
              extras: "Analiza la problem√°tica y redacta un cuerpo claro y profesional en p√°rrafos; sin encabezado ni firma. A√±ade una despedida breve.",
              incluirDespedida: true,
              longitud: "media"
            };

            const res = await fetch(`${API_BASE}/escritor`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
              signal: ctrl.signal
            });

            if (!res.ok) {
              const txt = await res.text().catch(() => '');
              throw new Error(`API /escritor ${res.status}: ${txt || res.statusText}`);
            }

            const json = await res.json();
            if (json.error) {
              throw new Error(json.detail || json.error);
            }

            const cuerpo = json.cuerpo || "";
            const despedida = json.despedida ? "\n\n" + json.despedida : "";
            setStatus("Texto generado por IA.");
            return `${cuerpo}${despedida}`;
          } catch (e) {
            console.error(e);
            setStatus("Error al redactar.");
            alert("No se pudo redactar con la IA.\n" + (e.name === 'AbortError' ? 'Tiempo de espera agotado.' : e.message));
            return "";
          } finally {
            clearTimeout(timeout);
            setTimeout(() => setStatus(""), 4000);
          }
        }

        async function armarOficio(d) {
          const encabezadoTop = `${d.ciudad}, a ${fechaLarga(d.fecha || hoyISO())}`;
          const dest = `${d.destinatario}${N(d.cargo) ? `\n${d.cargo}` : ''}`;
          const cuerpo = await redactarIA(d);
          const pie =
            `\nATENTAMENTE

${d.nombre}
Matr√≠cula: ${d.matricula}
Categor√≠a: ${d.categoria}${N(d.lugar) ? `\n${d.lugar}` : ''}`;
          return { encabezadoTop, dest, cuerpo, pie };
        }

        function datos() {
          return {
            ciudad: N($('#ciudad').value),
            fecha: N($('#fecha').value),
            destinatario: N($('#destinatario').value),
            cargo: N($('#cargo').value),
            nombre: N($('#nombre').value),
            matricula: N($('#matricula').value),
            categoria: N($('#categoria').value),
            lugar: N($('#lugar').value),
            problematica: N($('#problematica').value)
          };
        }

        function setDatos(d) {
          if (!d) return;
          const ids = ['ciudad', 'fecha', 'destinatario', 'cargo', 'nombre', 'matricula', 'categoria', 'lugar', 'problematica'];
          ids.forEach(id => {
            const el = document.getElementById(id);
            if (el && d[id] !== undefined) el.value = d[id] || '';
          });
        }

        function buildPreviewHTML(encabezadoTop, dest, cuerpo, pie) {
          const toParas = (txt) => (txt || "").split(/\n{2,}/).map(p => p.trim()).filter(Boolean);
          const esc = (s) => escapeHTML(s).replace(/\n/g, '<br>');
          let html = `
        <header>${esc(encabezadoTop)}</header>
        <div class="dest">${esc(dest)}</div>
        <p class="pres">Presente.</p>
      `;
          toParas(cuerpo).forEach(p => {
            if (/^[A-Z√Å√â√ç√ì√ö√ë\s\/]+:$/.test(p)) { html += `<h6>${esc(p)}</h6>`; }
            else { html += `<p>${esc(p)}</p>`; }
          });
          html += `<div class="pie">${esc(pie)}</div>`;
          return html;
        }

        async function abrirPreview() {
          try {
            const d = datos();
            const required = ['ciudad', 'destinatario', 'nombre', 'matricula', 'categoria', 'problematica'];
            for (const k of required) { if (!d[k]) { alert('Faltan campos obligatorios.'); return; } }

            const sheet = $('#sheet');
            sheet.style.padding = `72px 64px`;

            const { encabezadoTop, dest, cuerpo, pie } = await armarOficio(d);
            if (!cuerpo) { return; }

            sheet.innerHTML = buildPreviewHTML(encabezadoTop, dest, cuerpo, pie);
            openModal();
          } catch (e) {
            console.error(e);
            alert('Ocurri√≥ un error generando la vista previa.');
          }
        }
        function cerrarPreview() { closeModal(); }

        // ===== Opci√≥n B: PDF calcado a la vista previa con doc.html (justificado real) =====
        async function generarPDF(d, { action = 'print' } = {}) {
          setStatus('Generando PDF‚Ä¶');
          try {
            const { jsPDF } = await ensureJsPDF();
            const doc = new jsPDF({ unit: 'pt', format: 'letter' }); // Carta

            const dims = { W: 612, H: 792 };
            const M = 64;        // m√°rgenes laterales
            const topBase = 72;  // margen superior

            const { encabezadoTop, dest, cuerpo, pie } = await armarOficio(d);
            if (!cuerpo) { throw new Error('No se gener√≥ cuerpo del escrito.'); }

            // 1) Construir el mismo HTML que la vista previa
            const html = buildPreviewHTML(encabezadoTop, dest, cuerpo, pie);

            // 2) Montar un nodo temporal con clases .page/.sheet para respetar estilos
            const wrapper = document.createElement('div');
            wrapper.style.position = 'fixed';
            wrapper.style.left = '-10000px';
            wrapper.innerHTML = `
          <div class="page carta">
            <div class="sheet" style="padding:0">
              ${html}
            </div>
          </div>
        `;
            document.body.appendChild(wrapper);

            // 3) Ajustes inline por si acaso
            wrapper.querySelector('.sheet header')?.style.setProperty('font-weight', '700');
            wrapper.querySelectorAll('.sheet p')?.forEach(p => p.style.textAlign = 'justify');

            // 4) Render directo del HTML al PDF dentro de m√°rgenes
            await doc.html(wrapper.querySelector('.sheet'), {
              x: M,
              y: topBase - 24,          // peque√±o ajuste visual
              width: dims.W - M * 2,      // respeta m√°rgenes
              windowWidth: 816,         // coincide con tu carta en px (vista previa)
              html2canvas: { scale: 1 } // n√≠tido sin inflar tama√±o
            });

            // 5) Limpieza y salida
            document.body.removeChild(wrapper);

            if (action === 'download') {
              doc.save('Escrito.pdf');
              setStatus('PDF descargado.');
            } else {
              const blob = doc.output('blob');
              const url = URL.createObjectURL(blob);
              let iframe = document.getElementById('print-iframe');
              if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'print-iframe';
                iframe.style.position = 'fixed'; iframe.style.right = '0'; iframe.style.bottom = '0';
                iframe.style.width = '0'; iframe.style.height = '0'; iframe.style.border = '0'; iframe.style.visibility = 'hidden';
                document.body.appendChild(iframe);
              }
              await new Promise(res => {
                iframe.onload = () => {
                  try {
                    iframe.contentWindow.focus();
                    setTimeout(() => {
                      iframe.contentWindow.print();
                      setTimeout(() => URL.revokeObjectURL(url), 5000);
                      res();
                    }, 120);
                  } catch (e) { res(); }
                };
                iframe.src = url;
              });
              setStatus('Listo para imprimir. Si no aparece, usa Ctrl/Cmd + P.');
            }
          } catch (e) {
            console.error(e);
            setStatus('Error al generar el PDF.');
            alert('No se pudo generar el PDF.\n' + e.message);
          } finally {
            setTimeout(() => setStatus(""), 5000);
          }
        }

        // ===== Persistencia local =====
        function saveLocal() { try { localStorage.setItem(FORM_KEY, JSON.stringify(datos())); } catch { } }
        function loadLocal() { try { const s = localStorage.getItem(FORM_KEY); if (s) setDatos(JSON.parse(s)); } catch { } }

        // ===== Modal: focus trap + Esc =====
        const modal = $('#modal');
        const modalCard = modal.querySelector('.modal-card');
        let lastFocused = null;

        function getFocusable() {
          return modalCard.querySelectorAll('button,[href],[tabindex]:not([tabindex="-1"])');
        }
        function trapFocus(e) {
          if (e.key !== 'Tab') return;
          const f = getFocusable();
          if (!f.length) return;
          const first = f[0], last = f[f.length - 1];
          if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
          else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
        }

        function openModal() {
          lastFocused = document.activeElement;
          modal.classList.add('show');
          const f = getFocusable();
          (f[0] || modalCard).focus();
          document.addEventListener('keydown', onKeydown);
        }
        function closeModal() {
          modal.classList.remove('show');
          document.removeEventListener('keydown', onKeydown);
          if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
        }
        function onKeydown(e) {
          if (e.key === 'Escape') closeModal();
          if (e.key === 'Tab') trapFocus(e);
        }

        // ===== Eventos =====
        document.getElementById('btnPreview').addEventListener('click', abrirPreview);
        document.getElementById('btnClose').addEventListener('click', cerrarPreview);
        document.getElementById('btnDownload').addEventListener('click', async () => {
          const d = datos();
          const required = ['ciudad', 'destinatario', 'nombre', 'matricula', 'categoria', 'problematica'];
          for (const k of required) { if (!d[k]) { alert('Faltan campos obligatorios.'); return; } }
          await generarPDF(d, { action: 'download' });
        });
        document.getElementById('btnPrint').addEventListener('click', async () => {
          const d = datos();
          const required = ['ciudad', 'destinatario', 'nombre', 'matricula', 'categoria', 'problematica'];
          for (const k of required) { if (!d[k]) { alert('Faltan campos obligatorios.'); return; } }
          await generarPDF(d, { action: 'print' });
        });
        document.getElementById('btnCopy').addEventListener('click', async () => {
          try {
            const d = datos();
            const { encabezadoTop, dest, cuerpo, pie } = await armarOficio(d);
            if (!cuerpo) { return; }
            const txt = `${encabezadoTop}\n\n${dest}\nPresente.\n\n${cuerpo}\n${pie}`;
            await navigator.clipboard.writeText(txt);
            setStatus('Texto copiado al portapapeles.');
          } catch (e) {
            console.error(e); setStatus('No se pudo copiar el texto.');
          } finally {
            setTimeout(() => setStatus(""), 3000);
          }
        });

        document.getElementById('fDenuncia').addEventListener('submit', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          const d = datos();
          const required = ['ciudad', 'destinatario', 'nombre', 'matricula', 'categoria', 'problematica'];
          for (const k of required) { if (!d[k]) { alert('Faltan campos obligatorios.'); return; } }
          await generarPDF(d, { action: 'print' });
        });

        // ‚ñ∫ Autocompletar: al elegir puesto, llena titular (destinatario readonly) y cargo (oculto)
        document.getElementById('puestoCatalogo').addEventListener('change', (e) => {
          const val = e.target.value || '';
          const dest = document.getElementById('destinatario');
          const cargo = document.getElementById('cargo');
          dest.value = '';
          cargo.value = '';
          if (!val) return;
          const [cargoTxt, titular] = val.split('|');
          if (cargoTxt) cargo.value = cargoTxt;
          if (titular) dest.value = titular;
          saveLocal();
        });

        // ‚ñ∫ Guardado local al cambiar campos
        document.getElementById('fDenuncia').addEventListener('input', saveLocal);

        // cerrar modal clic fuera
        document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') closeModal(); });

        // ‚ñ∫ Cargar local y defaults
        loadLocal();
        const f = $('#fecha'); if (f && !f.value) f.value = hoyISO();

        // Navigation
        document.getElementById("btnBack")?.addEventListener("click", () => history.back());
      });
    </script>
    </body>

  </html>