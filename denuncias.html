<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Denuncias y Reportes ‚Äî SInOS</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{
    --bg:#0b1022; --panel:#0e1730; --ring:rgba(91,215,242,.35);
    --txt:#dff9ff; --muted:#aee9f7; --primary:#5bd7f2; --sky:#60a5fa;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:980px;margin:0 auto;padding:24px}
  h1{margin:0 0 12px;font-size:24px}
  p.muted{color:var(--muted);margin-top:0}
  .card{background:linear-gradient(180deg,#0e1730,#0b1428);border:1px solid rgba(91,215,242,.28);
    border-radius:18px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
  form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-size:12px;color:#bdefff;margin:4px 0}
  input,select,textarea{
    width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(91,215,242,.28);
    background:#0a1329;color:var(--txt);outline:none
  }
  textarea{min-height:160px;resize:vertical;grid-column:1/-1}
  .grid-1{grid-column:1/-1}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .btn{appearance:none;border:1px solid rgba(91,215,242,.45);background:rgba(91,215,242,.14);
    color:#e6fbff;border-radius:12px;padding:10px 14px;font-size:14px;cursor:pointer}
  .btn:hover{box-shadow:0 0 0 1px var(--ring) inset, 0 10px 24px rgba(11,18,32,.55)}
  .btn.primary{background:linear-gradient(90deg,var(--primary),var(--sky));border:none;color:#072133}
  .preview{margin-top:16px;padding:14px;border-radius:12px;background:#0b1429;border:1px dashed rgba(91,215,242,.25)}
  .small{font-size:12px;color:#9edff0}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:680px){ .two{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Denuncias y Reportes</h1>
    <p class="muted">Completa el formulario y presiona <b>Generar PDF e imprimir</b>. El documento se estructura con apartados formales y desarrolla tu descripci√≥n.</p>

    <div class="card">
      <form id="fDenuncia" autocomplete="on">
        <div>
          <label for="nombre">Nombre del trabajador</label>
          <input id="nombre" name="nombre" required placeholder="Nombre(s) y apellidos">
        </div>
        <div>
          <label for="matricula">Matr√≠cula</label>
          <input id="matricula" name="matricula" required placeholder="Ej. 123456">
        </div>
        <div>
          <label for="categoria">Categor√≠a</label>
          <input id="categoria" name="categoria" required placeholder="Ej. Enfermera General A">
        </div>
        <div>
          <label for="secretaria">Secretar√≠a destinataria</label>
          <select id="secretaria" name="secretaria" required>
            <option value="Secretar√≠a General">Secretar√≠a General</option>
            <option value="Secretar√≠a del Trabajo">Secretar√≠a del Trabajo</option>
            <option value="Secretar√≠a de Conflictos">Secretar√≠a de Conflictos</option>
            <option value="Secretar√≠a del Interior y Propaganda">Secretar√≠a del Interior y Propaganda</option>
          </select>
        </div>

        <div class="grid-1 two">
          <div>
            <label for="lugar">Centro/√Årea (opcional)</label>
            <input id="lugar" name="lugar" placeholder="Ej. HGZ No. XX, Urgencias">
          </div>
          <div>
            <label for="contacto">Tel√©fono/Correo (opcional)</label>
            <input id="contacto" name="contacto" placeholder="Para notificaciones">
          </div>
        </div>

        <div class="grid-1">
          <label for="problematica">Describe la problem√°tica (hechos, fechas, involucrados, impactos)</label>
          <textarea id="problematica" name="problematica" required placeholder="Escribe de forma libre lo ocurrido, por orden cronol√≥gico si es posible."></textarea>
        </div>

        <div class="two grid-1">
          <div>
            <label for="nivel">Nivel de desarrollo</label>
            <select id="nivel" name="nivel">
              <option value="normal">Normal</option>
              <option value="extenso" selected>Extenso</option>
              <option value="muy">Muy extenso</option>
            </select>
          </div>
          <div>
            <label for="peticiones">Peticiones espec√≠ficas (opcional)</label>
            <input id="peticiones" placeholder="Ej. investigaci√≥n, medidas cautelares, restituci√≥n..." />
          </div>
        </div>

        <div class="row">
          <button type="button" class="btn" id="btnPreview">üëÅÔ∏è Vista previa</button>
          <button type="submit" class="btn primary">üñ®Ô∏è Generar PDF e imprimir</button>
          <span class="small">Todo se genera localmente; no se env√≠an datos a servidores.</span>
        </div>
      </form>

      <div id="preview" class="preview small" hidden></div>
    </div>
  </div>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // ===== utilidades de texto (sin IA) =====
    const $ = s => document.querySelector(s);

    const normalize = s => (s||'').replace(/\s+/g,' ').trim();
    const splitSentences = (text) => {
      return normalize(text)
        .replace(/([.;:!?])\s*(?=[A-Z√Å√â√ç√ì√ö√ë0-9])/g,'$1|')
        .split('|')
        .map(t=>t.trim()).filter(Boolean);
    };

    const extractHints = (text) => {
      const fechas = [...text.matchAll(/\b(\d{1,2}\/\d{1,2}\/\d{2,4}|\d{1,2}\s+de\s+\w+\s+de\s+\d{4})\b/gi)].map(m=>m[0]);
      const horas  = [...text.matchAll(/\b(\d{1,2}:\d{2}\s*(?:am|pm)?|\d{1,2}\s*h(?:oras)?)\b/gi)].map(m=>m[0]);
      const personas = [...text.matchAll(/\b([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+)+)\b/g)].map(m=>m[1]).slice(0,6);
      const lugares = [...text.matchAll(/\b(en|en las|en los)\s+([A-Z√Å√â√ç√ì√ö√ë][\w√Å√â√ç√ì√ö√ë√°√©√≠√≥√∫√±\. -]{2,})/g)].map(m=>m[2]).slice(0,4);
      return {fechas, horas, personas, lugares};
    };

    function encabezado(secretaria){
      const map = {
        'Secretar√≠a General': 'Secretar√≠a General del SNTSS Secci√≥n XX Michoac√°n',
        'Secretar√≠a del Trabajo': 'Secretar√≠a del Trabajo del SNTSS Secci√≥n XX Michoac√°n',
        'Secretar√≠a de Conflictos': 'Secretar√≠a de Conflictos del SNTSS Secci√≥n XX Michoac√°n',
        'Secretar√≠a del Interior y Propaganda': 'Secretar√≠a del Interior y Propaganda del SNTSS Secci√≥n XX Michoac√°n'
      };
      return map[secretaria] || secretaria;
    }

    function desarrollarProblematica(text, nivel='extenso'){
      const sents = splitSentences(text);
      const hints = extractHints(text);
      const bullets = sents.map(s => `‚Ä¢ ${s}`);

      const intro =
        `Me permito exponer una situaci√≥n que considero contraria a mis derechos laborales y a un ambiente de trabajo digno. A continuaci√≥n detallo los antecedentes y hechos relevantes para su conocimiento y atenci√≥n.`;

      const antecedentes =
        `De manera general, los acontecimientos aqu√≠ referidos han tenido lugar${hints.lugares.length ? ` principalmente en ${hints.lugares[0]}` : ''}${hints.fechas.length ? `, con fechas relevantes como ${hints.fechas.slice(0,2).join(' y ')}` : ''}${hints.horas.length ? ` y horarios aproximados ${hints.horas.slice(0,2).join(' y ')}` : ''}.`;

      const hechos =
        `HECHOS CRONOL√ìGICOS:\n${bullets.join('\n')}`;

      const impacto =
        `IMPACTO Y AFECTACIONES:\n‚Ä¢ La situaci√≥n descrita ha generado afectaciones a mi desempe√±o y bienestar, incluyendo estr√©s, incertidumbre y menoscabo en mis condiciones de trabajo.\n‚Ä¢ Solicito su intervenci√≥n para prevenir la repetici√≥n de estos hechos y restituir las condiciones laborales que correspondan.`;

      const base =
        `MARCO Y CONSIDERACIONES:\n‚Ä¢ Lo anterior se expone con base en los principios de legalidad, respeto, igualdad y no violencia laboral.\n‚Ä¢ Pido se salvaguarde mi integridad y confidencialidad, as√≠ como las de posibles testigos.`;

      const cierre =
        `Por lo anterior, agradezco se d√© tr√°mite a la presente y se me informe del seguimiento. Quedo a disposici√≥n para ampliar informaci√≥n y aportar documentaci√≥n adicional.`;

      // Ajustar longitud seg√∫n nivel
      let partes = [intro, antecedentes, hechos, impacto, base, cierre];
      if(nivel === 'normal'){ partes = [intro, hechos, cierre]; }
      if(nivel === 'muy'){
        const ampliacion =
          `DETALLE ADICIONAL:\n‚Ä¢ A mi leal saber y entender, los hechos tienen un patr√≥n que se manifiesta en distintos turnos o periodos. Resulta indispensable que se investigue integralmente, se escuchen a las partes y se revisen registros (listas de asistencia, roles, reportes, comunicaciones internas y cualquier otro documento relacionado).`;
        partes.splice(3,0,ampliacion);
      }

      return partes.join('\n\n');
    }

    function armarDocumento(datos){
      const {nombre, matricula, categoria, secretaria, problematica, nivel, lugar, contacto, peticiones} = datos;
      const fecha = new Date().toLocaleDateString('es-MX',{day:'2-digit',month:'long',year:'numeric'});

      const encabez = `${encabezado(secretaria)}\n\nPresente.`;
      const desarrollo = desarrollarProblematica(problematica, nivel);

      const pet = peticiones && peticiones.trim()
        ? `\n\nSOLICITUDES ESPEC√çFICAS:\n‚Ä¢ ${peticiones.trim().replace(/^[‚Ä¢\-\*]\s*/,'')}`
        : `\n\nSOLICITUDES:\n‚Ä¢ Se investiguen los hechos y se determinen responsabilidades.\n‚Ä¢ Se adopten medidas de protecci√≥n y no represalia.\n‚Ä¢ Se restituyan, en su caso, mis condiciones laborales.`;

      const pie =
`${lugar ? `\n\nLugar: ${lugar}` : ''}${contacto ? `\nMedio de contacto: ${contacto}` : ''}

ATENTAMENTE

${nombre}
Matr√≠cula: ${matricula}
Categor√≠a: ${categoria}
${fecha}`;

      return `${encabez}\n\n${desarrollo}${pet}\n${pie}`;
    }

    function mostrarPreview(texto){
      const box = $('#preview'); box.hidden = false;
      box.textContent = texto;
    }

    // ===== PDF + impresi√≥n (misma pesta√±a) =====
    async function generarPDFyImprimir(datos){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'letter' });

      const left = 64, top = 72, width = 468; // carta: 612x792 pt
      doc.setFont('Times','Bold'); doc.setFontSize(14);
      doc.text(encabezado(datos.secretaria), left, top);
      doc.setFont('Times','Normal'); doc.setFontSize(12);
      doc.text('Presente.', left, top+22);

      const texto = armarDocumento(datos)
        .replace(encabezado(datos.secretaria)+'\n\nPresente.\n\n',''); // evita duplicado

      const parrafos = texto.split(/\n{2,}/).map(p=>p.trim()).filter(Boolean);
      let y = top + 50;
      const lh = 16; // line height aprox

      doc.setFont('Times','Normal'); doc.setFontSize(12);
      parrafos.forEach(p=>{
        const lines = doc.splitTextToSize(p, width);
        if (y + lines.length*lh > 740){ doc.addPage(); y = top; }
        // Titulares ‚Äúen may√∫sculas:‚Äù se ponen semi-bold
        if (/^[A-Z√Å√â√ç√ì√ö√ë\s]+:/.test(p)){
          const [head, ...rest] = p.split(':');
          doc.setFont('Times','Bold'); doc.text(head+':', left, y); y += lh;
          doc.setFont('Times','Normal');
          if(rest.join(':').trim()){
            const rs = doc.splitTextToSize(rest.join(':').trim(), width);
            doc.text(rs, left, y); y += rs.length*lh + 6;
          }
        }else{
          doc.text(lines, left, y); y += lines.length*lh + 6;
        }
      });

      // Firma ya viene dentro del texto armado; nada extra aqu√≠.

      const blob = doc.output('blob');
      const url = URL.createObjectURL(blob);
      let iframe = document.getElementById('print-iframe');
      if(!iframe){
        iframe = document.createElement('iframe');
        iframe.id = 'print-iframe';
        iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
        iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0'; iframe.style.visibility='hidden';
        document.body.appendChild(iframe);
      }
      return new Promise(resolve=>{
        iframe.onload = () => { try{ iframe.contentWindow.focus(); setTimeout(()=>{ iframe.contentWindow.print(); resolve(); }, 120);}catch(e){ resolve(); } };
        iframe.src = url;
      });
    }

    // ===== Eventos =====
    const datosForm = () => ({
      nombre: normalize($('#nombre').value),
      matricula: normalize($('#matricula').value),
      categoria: normalize($('#categoria').value),
      secretaria: $('#secretaria').value,
      problematica: $('#problematica').value,
      nivel: $('#nivel').value,
      lugar: normalize($('#lugar').value),
      contacto: normalize($('#contacto').value),
      peticiones: $('#peticiones').value
    });

    $('#btnPreview').addEventListener('click', ()=>{
      const d = datosForm();
      if(!d.nombre || !d.matricula || !d.categoria || !d.problematica){
        alert('Completa al menos: Nombre, Matr√≠cula, Categor√≠a y Problem√°tica.'); return;
      }
      mostrarPreview( armarDocumento(d) );
    });

    $('#fDenuncia').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const d = datosForm();
      if(!d.nombre || !d.matricula || !d.categoria || !d.problematica){
        alert('Por favor, completa todos los campos obligatorios.'); return;
      }
      await generarPDFyImprimir(d);
    });
  </script>
</body>
</html>
