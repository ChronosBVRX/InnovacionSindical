<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Denuncias y Reportes ‚Äî SInOS</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{
    --bg:#0b1022; --panel:#0e1730; --ring:rgba(91,215,242,.35);
    --txt:#dff9ff; --muted:#aee9f7; --primary:#5bd7f2; --sky:#60a5fa;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:980px;margin:0 auto;padding:24px}
  h1{margin:0 0 12px;font-size:24px}
  p.muted{color:var(--muted);margin-top:0}
  .card{background:linear-gradient(180deg,#0e1730,#0b1428);border:1px solid rgba(91,215,242,.28);
    border-radius:18px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
  form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-size:12px;color:#bdefff;margin:4px 0}
  input,select,textarea{
    width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(91,215,242,.28);
    background:#0a1329;color:var(--txt);outline:none
  }
  textarea{min-height:160px;resize:vertical;grid-column:1/-1}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .btn{appearance:none;border:1px solid rgba(91,215,242,.45);background:rgba(91,215,242,.14);
    color:#e6fbff;border-radius:12px;padding:10px 14px;font-size:14px;cursor:pointer}
  .btn:hover{box-shadow:0 0 0 1px var(--ring) inset, 0 10px 24px rgba(11,18,32,.55)}
  .btn.primary{background:linear-gradient(90deg,var(--primary),var(--sky));border:none;color:#072133}
  .preview{margin-top:16px;padding:14px;border-radius:12px;background:#0b1429;border:1px dashed rgba(91,215,242,.25)}
  .small{font-size:12px;color:#9edff0}
  .grid-1{grid-column:1/-1}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Denuncias y Reportes</h1>
    <p class="muted">Completa el formulario y presiona <b>Generar PDF e imprimir</b>. El documento se formatea autom√°ticamente.</p>

    <div class="card">
      <form id="fDenuncia" autocomplete="on">
        <div>
          <label for="nombre">Nombre del trabajador</label>
          <input id="nombre" name="nombre" required placeholder="Nombre(s) y apellidos">
        </div>
        <div>
          <label for="matricula">Matr√≠cula</label>
          <input id="matricula" name="matricula" required placeholder="Ej. 123456">
        </div>
        <div>
          <label for="categoria">Categor√≠a</label>
          <input id="categoria" name="categoria" required placeholder="Ej. Enfermera General A">
        </div>
        <div>
          <label for="secretaria">Secretar√≠a destinataria</label>
          <select id="secretaria" name="secretaria" required>
            <option value="Secretar√≠a General">Secretar√≠a General</option>
            <option value="Secretar√≠a del Trabajo">Secretar√≠a del Trabajo</option>
            <option value="Secretar√≠a de Conflictos">Secretar√≠a de Conflictos</option>
            <option value="Secretar√≠a del Interior y Propaganda">Secretar√≠a del Interior y Propaganda</option>
          </select>
        </div>
        <div class="grid-1">
          <label for="problematica">Describe la problem√°tica</label>
          <textarea id="problematica" name="problematica" required placeholder="Escribe con detalle los hechos, fechas, lugares, personas involucradas y pruebas con que cuentes."></textarea>
        </div>

        <div class="row">
          <button type="button" class="btn" id="btnPreview">üëÅÔ∏è Vista previa</button>
          <button type="submit" class="btn primary">üñ®Ô∏è Generar PDF e imprimir</button>
          <span class="small">La impresi√≥n se genera localmente; no se env√≠an datos a servidores.</span>
        </div>
      </form>

      <div id="preview" class="preview small" hidden></div>
    </div>
  </div>

  <!-- jsPDF (cliente) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    const $ = s => document.querySelector(s);

    function encabezado(secretaria){
      const map = {
        'Secretar√≠a General': 'Secretar√≠a General del SNTSS Secci√≥n XX Michoac√°n',
        'Secretar√≠a del Trabajo': 'Secretar√≠a del Trabajo del SNTSS Secci√≥n XX Michoac√°n',
        'Secretar√≠a de Conflictos': 'Secretar√≠a de Conflictos del SNTSS Secci√≥n XX Michoac√°n',
        'Secretar√≠a del Interior y Propaganda': 'Secretar√≠a del Interior y Propaganda del SNTSS Secci√≥n XX Michoac√°n'
      };
      return map[secretaria] || secretaria;
    }

    function redactar({nombre, matricula, categoria, secretaria, problematica}){
      const fecha = new Date().toLocaleDateString('es-MX',{day:'2-digit',month:'long',year:'numeric'});
      return (
`${encabezado(secretaria)}

Presente.

Por este conducto me permito exponer lo siguiente:

${problematica.trim()}

Por lo anterior, solicito atentamente su intervenci√≥n conforme a derecho, y se me informe el seguimiento otorgado a la presente.

Sin otro particular, quedo a sus √≥rdenes.

ATENTAMENTE

${nombre}
Matr√≠cula: ${matricula}
Categor√≠a: ${categoria}
${fecha}`
      );
    }

    function mostrarPreview(texto){
      const box = $('#preview');
      box.hidden = false;
      box.textContent = texto;
    }

    // --- Generaci√≥n de PDF + impresi√≥n sin bloqueos (iframe oculto)
    async function generarPDFyImprimir(data){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'letter' });

      const left = 64, top = 72, width = 468; // carta: 612x792 pt
      doc.setFont('Times','Normal'); doc.setFontSize(12);

      // Encabezado
      doc.setFont('Times','Bold'); doc.setFontSize(14);
      doc.text(encabezado(data.secretaria), left, top);
      doc.setFont('Times','Normal'); doc.setFontSize(12);
      doc.text('Presente.', left, top + 22);

      // Cuerpo
      const cuerpo = redactar(data)
        .replace(encabezado(data.secretaria)+'\n\nPresente.\n\n',''); // evitar duplicado
      const l√≠neas = doc.splitTextToSize(cuerpo, width);
      doc.text(l√≠neas, left, top + 52, { align:'left', lineHeightFactor:1.45 });

      // Firma (al final)
      const firmaY = Math.min(700, top + 52 + (l√≠neas.length * 16));
      doc.setFont('Times','Bold'); doc.text('ATENTAMENTE', left, firmaY + 32);
      doc.setFont('Times','Normal');
      doc.text(data.nombre, left, firmaY + 52);
      doc.text(`Matr√≠cula: ${data.matricula}`, left, firmaY + 70);
      doc.text(`Categor√≠a: ${data.categoria}`, left, firmaY + 88);

      // Blob URL
      const blob = doc.output('blob');
      const url = URL.createObjectURL(blob);

      // Imprimir desde iframe oculto (misma pesta√±a, menos bloqueos)
      let iframe = document.getElementById('print-iframe');
      if(!iframe){
        iframe = document.createElement('iframe');
        iframe.id = 'print-iframe';
        iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
        iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0'; iframe.style.visibility='hidden';
        document.body.appendChild(iframe);
      }

      return new Promise(resolve=>{
        iframe.onload = () => {
          try{
            iframe.contentWindow.focus();
            // algunos navegadores requieren un peque√±o delay
            setTimeout(()=>{ iframe.contentWindow.print(); resolve(); }, 120);
          }catch(e){ resolve(); }
        };
        iframe.src = url;
      });
    }

    // --- Eventos
    $('#btnPreview').addEventListener('click', ()=>{
      const data = {
        nombre: $('#nombre').value.trim(),
        matricula: $('#matricula').value.trim(),
        categoria: $('#categoria').value.trim(),
        secretaria: $('#secretaria').value,
        problematica: $('#problematica').value.trim()
      };
      if(!data.nombre || !data.matricula || !data.categoria || !data.problematica){
        alert('Completa todos los campos.'); return;
      }
      mostrarPreview( redactar(data) );
    });

    $('#fDenuncia').addEventListener('submit', async (e)=>{
      e.preventDefault(); // evita navegaci√≥n/ventana nueva
      const data = {
        nombre: $('#nombre').value.trim(),
        matricula: $('#matricula').value.trim(),
        categoria: $('#categoria').value.trim(),
        secretaria: $('#secretaria').value,
        problematica: $('#problematica').value.trim()
      };
      if(!data.nombre || !data.matricula || !data.categoria || !data.problematica){
        alert('Por favor, completa todos los campos.'); return;
      }
      await generarPDFyImprimir(data);
    });
  </script>
</body>
</html>
