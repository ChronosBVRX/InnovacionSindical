<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Asistente Generador de Escritos ‚Äî Plataforma Sindical CG</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    /* Nueva Paleta Modernizada (Tonos Azules Profesionales) */
    --bg-dark: #0f172a;
    --bg-gradient: radial-gradient(circle at top center, #1e293b, #0f172a);
    --panel-bg: rgba(30, 41, 59, 0.7); /* Efecto cristal */
    --panel-border: rgba(148, 163, 184, 0.1);
    
    --primary: #38bdf8; /* Azul cielo brillante */
    --primary-hover: #0ea5e9;
    --accent: #7dd3fc;
    
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    
    --input-bg: rgba(15, 23, 42, 0.6);
    --input-border: rgba(148, 163, 184, 0.2);
    --focus-ring: rgba(56, 189, 248, 0.5);
    
    --radius: 12px;
  }

  * { box-sizing: border-box; }
  
  html, body {
    height: 100%; margin: 0;
    background: var(--bg-dark);
    background-image: var(--bg-gradient);
    color: var(--text-main);
    font-family: 'Inter', system-ui, sans-serif;
    -webkit-font-smoothing: antialiased;
  }

  .wrap { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
  
  /* Encabezado */
  .header-group { margin-bottom: 30px; text-align: center; }
  h1 { 
    margin: 10px 0; 
    font-size: 28px; 
    font-weight: 700; 
    background: linear-gradient(90deg, #fff, var(--primary)); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
  }
  p.muted { color: var(--text-muted); font-size: 15px; margin-top: 5px; line-height: 1.5; }
  
  .top-actions { display: flex; justify-content: flex-start; margin-bottom: 20px; }
  
  /* Tarjeta Principal (Glassmorphism) */
  .card {
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
    border-radius: 24px;
    padding: 32px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(16px);
  }

  form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  
  /* Etiquetas e Inputs */
  label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 8px;
    letter-spacing: 0.5px;
  }

  input, select, textarea {
    width: 100%;
    padding: 12px 16px;
    border-radius: var(--radius);
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: #fff;
    outline: none;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.2s ease;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--focus-ring);
    background: rgba(30, 41, 59, 0.9);
  }

  input::placeholder, textarea::placeholder { color: rgba(148, 163, 184, 0.5); }

  /* Estilo especial para Select */
  select {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2338bdf8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
    cursor: pointer;
  }

  /* Campos de solo lectura */
  input:read-only {
    background: rgba(0, 0, 0, 0.2);
    border-color: transparent;
    color: var(--text-muted);
    cursor: default;
  }

  /* √Årea de texto grande */
  textarea { min-height: 140px; resize: vertical; grid-column: 1/-1; line-height: 1.6; }
  .grid-full { grid-column: 1/-1; }

  /* Secci√≥n visualmente distinta para el Puesto */
  .highlight-section {
    grid-column: 1/-1;
    background: rgba(56, 189, 248, 0.05);
    border: 1px solid rgba(56, 189, 248, 0.15);
    padding: 20px;
    border-radius: 16px;
    margin-bottom: 10px;
  }
  
  /* Botones */
  .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 20px; }
  
  .btn {
    appearance: none;
    border: 1px solid var(--panel-border);
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-main);
    border-radius: 50px; /* Pill shape */
    padding: 12px 24px;
    font-size: 14px;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
  }
  
  .btn:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-1px);
  }

  .btn.primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-hover));
    border: none;
    color: #0f172a;
    box-shadow: 0 4px 15px rgba(56, 189, 248, 0.4);
  }
  
  .btn.primary:hover {
    filter: brightness(1.1);
    box-shadow: 0 6px 20px rgba(56, 189, 248, 0.5);
  }

  .small { font-size: 12px; color: var(--text-muted); margin-left: auto; }

  /* Toast de estado */
  #status {
    position: fixed; right: 20px; bottom: 20px;
    background: #1e293b;
    border-left: 4px solid var(--primary);
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    color: #fff;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    z-index: 100;
    transform: translateY(100px);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  #status:not(:empty) { transform: translateY(0); }

  /* ===== Modal (Preview) ===== */
  .modal {
    position: fixed; inset: 0;
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(5px);
    display: none;
    align-items: center; justify-content: center;
    z-index: 50;
    opacity: 0; transition: opacity 0.3s;
  }
  .modal.show { display: flex; opacity: 1; }
  
  .modal-card {
    width: clamp(320px, 95vw, 1000px);
    background: #1e293b;
    border: 1px solid var(--panel-border);
    border-radius: 20px;
    box-shadow: 0 25px 100px rgba(0,0,0,0.7);
    display: flex; flex-direction: column;
    overflow: hidden;
    animation: slideUp 0.4s ease-out;
  }
  
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  .modal-h {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 24px;
    background: #0f172a;
    border-bottom: 1px solid var(--panel-border);
  }
  .modal-t { font-weight: 700; color: #fff; font-size: 18px; }
  .modal-a { display: flex; gap: 10px; flex-wrap: wrap; }
  .modal-b { padding: 30px; overflow: auto; max-height: 80vh; background: #334155; }

  /* Hoja de Papel */
  .page {
    margin: 0 auto;
    background: #fff;
    color: #111;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    position: relative;
    /* Efecto de papel sutil */
    filter: contrast(0.95); 
  }
  .page.carta { width: 816px; height: 1056px; } 
  .sheet { 
    padding: 72px 64px; 
    font-family: "Times New Roman", Times, serif; 
    font-size: 12pt; /* Ajustado a tama√±o real de punto */
    line-height: 1.5; 
    white-space: pre-wrap; 
  }
  
  /* Estilos internos del documento para impresi√≥n */
  .sheet header { font-size: 11pt; text-align: right; margin-bottom: 2em; font-weight: 700; } 
  .sheet .dest { font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; text-transform: uppercase; }
  .sheet .pres { margin: 0 0 2em 0; }
  .sheet h6 { font-weight: 700; margin: 1.5em 0 0.5em 0; font-size: 12pt; text-transform: uppercase; }
  .sheet p { text-align: justify; margin-bottom: 1em; }
  .sheet .pie { 
    position: absolute; bottom: 80px; left: 64px; right: 64px; 
    text-align: center; font-weight: 700;
  }

  /* Responsive */
  @media (max-width: 768px) {
    form { grid-template-columns: 1fr; gap: 16px; }
    .card { padding: 20px; }
    .btn { width: 100%; justify-content: center; }
    .modal-h { flex-direction: column; gap: 15px; }
    .modal-a { width: 100%; justify-content: space-between; }
    .modal-a .btn { flex: 1; padding: 10px; font-size: 12px; }
    .page.carta { width: 100%; height: auto; min-height: 500px; aspect-ratio: 8.5/11; }
    .sheet { padding: 40px; font-size: 10px; } /* Solo para visualizaci√≥n m√≥vil */
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top-actions">
      <a class="btn" href="https://chronosbvrx.github.io/InnovacionSindical/">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        Regresar al men√∫
      </a>
    </div>

    <div class="header-group">
      <h1>Asistente Generador de Escritos</h1>
      <p class="muted">Redacta denuncias y reportes profesionales con ayuda de IA.<br>Previsualiza, descarga en PDF o imprime directamente.</p>
    </div>

    <div class="card">
      <form id="fDenuncia" autocomplete="on" novalidate>
        
        <div class="highlight-section">
          <label for="puestoCatalogo">1. ¬øA qui√©n va dirigido el escrito?</label>
          <select id="puestoCatalogo">
            <option value="">‚Äî Selecciona la Secretar√≠a o Comisi√≥n ‚Äî</option>

            <optgroup label="Secretar√≠as">
              <option value="Secretar√≠a General|Dr. Juan Gerardo Garc√≠a Gonz√°lez">Secretar√≠a General</option>
              <option value="Secretar√≠a del Interior y Propaganda|M.N.F. Amin Uriel Morales S√°nchez">Secretar√≠a del Interior y Propaganda</option>
              <option value="Secretar√≠a de Conflictos|C.E. Arturo Ochoa Huacuz">Secretar√≠a de Conflictos</option>
              <option value="Secretar√≠a del Trabajo|M.N.F. Carlos Alberto Guerrero Rasc√≥n">Secretar√≠a del Trabajo</option>
              <option value="Secretar√≠a de Asuntos al Exterior|M.N.F. Ignacio Agust√≠n Orozco P√©rez">Secretar√≠a de Asuntos al Exterior</option>
              <option value="Tesorer√≠a|EST. Azucena Herrera Mart√≠nez">Tesorer√≠a</option>
              <option value="Secretar√≠a de Previsi√≥n Social|O.T. Laura Ram√≠rez Huitzacua">Secretar√≠a de Previsi√≥n Social</option>
              <option value="Secretar√≠a de Igualdad Sustantiva|M.F. Gabriela Dur√°n Negrete">Secretar√≠a de Igualdad Sustantiva</option>
              <option value="Secretar√≠a de Asuntos T√©cnicos|M.N.F. Horacio Pe√±a Alfaro">Secretar√≠a de Asuntos T√©cnicos</option>
              <option value="Secretar√≠a de Actas y Acuerdos|M.A. C√©sar Augusto Contreras Flores">Secretar√≠a de Actas y Acuerdos</option>
              <option value="Secretar√≠a de Prensa|A.M. Yolanda Morelos Palomares">Secretar√≠a de Prensa</option>
              <option value="Secretar√≠a de Puestos Perif√©ricos|M.G. Luz Nayelly Esquivel Mart√≠nez">Secretar√≠a de Puestos Perif√©ricos</option>
              <option value="Secretar√≠a de Admisi√≥n y Cambios|J.G.E. Cecilio Vanegas Villalobos">Secretar√≠a de Admisi√≥n y Cambios</option>
              <option value="Secretar√≠a de Capacitaci√≥n y Adiestramiento|O.P. Am√©rica Hilda Reyes Reyes">Secretar√≠a de Capacitaci√≥n y Adiestramiento</option>
              <option value="Secretar√≠a de Calidad y Modernizaci√≥n|M.N.F. Carlos Mojica Rodr√≠guez">Secretar√≠a de Calidad y Modernizaci√≥n</option>
            </optgroup>

            <optgroup label="Comisiones ‚Äî Presidencias">
              <option value="Comisi√≥n de Honor y Justicia ‚Äî Presidencia|C.S.T. Jos√© Francisco Ruiz Dom√≠nguez">Honor y Justicia ‚Äî Presidencia</option>
              <option value="Comisi√≥n de Hacienda ‚Äî Presidencia|A.M. Fabiola Far√≠as Ambriz">Hacienda ‚Äî Presidencia</option>
              <option value="Comisi√≥n de Vigilancia ‚Äî Presidencia|A.M. Imelda Reyes L√≥pez">Vigilancia ‚Äî Presidencia</option>
              <option value="Comisi√≥n de Deportes ‚Äî Presidencia|J.G.P. Roberto Carlos Reyes Ortiz">Deportes ‚Äî Presidencia</option>
              <option value="Comisi√≥n de Fomento a la Seguridad Social ‚Äî Presidencia|Q.C. Gerardo Ordaz Salazar">Fomento a la Seguridad Social ‚Äî Presidencia</option>
              <option value="Comisi√≥n de Acci√≥n Pol√≠tica ‚Äî Presidencia|Lab. Irving Cruz Guerrero Castro">Acci√≥n Pol√≠tica ‚Äî Presidencia</option>
            </optgroup>

            <optgroup label="Subcomisiones mixtas ‚Äî Representaci√≥n sindical">
              <option value="Subcomisi√≥n Mixta de Becas ‚Äî Representaci√≥n Sindical|M.F. Jorge H√©ctor Zaragoza Palacios">Becas</option>
              <option value="Subcomisi√≥n Mixta de Bolsa de Trabajo ‚Äî Representaci√≥n Sindical|COORD. CONT. Uriel Tapia P√©rez">Bolsa de Trabajo</option>
              <option value="Subcomisi√≥n Mixta de Puestos de Confianza ‚ÄúB‚Äù ‚Äî Representaci√≥n Sindical|E.G. C√°ndido Mora Alcauter">Puestos de Confianza ‚ÄúB‚Äù</option>
              <option value="Subcomisi√≥n Mixta de Capacitaci√≥n y Adiestramiento ‚Äî Representaci√≥n Sindical|A.E.G. Juan Onofre Baez">Capacitaci√≥n y Adiestramiento</option>
              <option value="Subcomisi√≥n Mixta Aux. de Capacitaci√≥n y Adiestramiento ‚Äî Representaci√≥n Sindical|A.M. Araceli Barajas Flores">Aux. Capacitaci√≥n y Adiestramiento</option>
              <option value="Subcomisi√≥n Mixta de Seguridad e Higiene ‚Äî Representaci√≥n Sindical|A.U.O. Betsabe Hern√°ndez Flores">Seguridad e Higiene</option>
              <option value="Subcomisi√≥n Mixta Aux. de Seguridad e Higiene ‚Äî Representaci√≥n Sindical|A.U.O. Carmen Lizeth Ruiz Aguilar">Aux. Seguridad e Higiene (1)</option>
              <option value="Subcomisi√≥n Mixta Aux. de Seguridad e Higiene ‚Äî Representaci√≥n Sindical|A.S.G. Sergio Ortiz Mart√≠nez">Aux. Seguridad e Higiene (2)</option>
              <option value="Subcomisi√≥n Mixta Disciplinaria ‚Äî Representaci√≥n Sindical|Cont. Juan Carlos Serv√≠n Ju√°rez">Disciplinaria</option>
              <option value="Subcomisi√≥n Mixta de Escalaf√≥n ‚Äî Representaci√≥n Sindical|E.G. Hilda Ontiveros Cuellar">Escalaf√≥n</option>
              <option value="Subcomisi√≥n Mixta Paritaria de Protecci√≥n al Salario ‚Äî Representaci√≥n Sindical|M.N.F. J. Guadalupe Hern√°ndez Alcal√°">Paritaria de Protecci√≥n al Salario</option>
              <option value="Subcomisi√≥n Mixta de Pasajes ‚Äî Representaci√≥n Sindical|O.A. Jos√© Antonio Carrillo Bejarano">Pasajes</option>
              <option value="Subcomisi√≥n Mixta de Ropa de Trabajo y Uniformes ‚Äî Representaci√≥n Sindical|A.A. Julio Cesar Garc√≠a Salgado">Ropa de Trabajo y Uniformes</option>
              <option value="Subcomisi√≥n Mixta de Selecci√≥n de Recursos Humanos para Cambios de Rama ‚Äî Representaci√≥n Sindical|J.G.E. Gilberto Herrej√≥n Gonz√°lez">Selecci√≥n RH (Cambios de Rama)</option>
              <option value="Subcomisi√≥n Mixta de Tiendas ‚Äî Representaci√≥n Sindical|P.E.F.B. Humberto Guerrero Linares">Tiendas</option>
              <option value="Subcomisi√≥n Mixta de Jubilaciones y Pensiones ‚Äî Representaci√≥n Sindical|E.G.C. Maricela Navarrete Mora">Jubilaciones y Pensiones</option>
              <option value="Subcomisi√≥n Mixta de Revisi√≥n de Plantillas ‚Äî Representaci√≥n Sindical|E.G. Luis Fernando Garc√≠a Cervantes">Revisi√≥n de Plantillas</option>
            </optgroup>
          </select>
        </div>

        <div>
          <label for="destinatario">Nombre del titular (Autom√°tico)</label>
          <input id="destinatario" name="destinatario" placeholder="Se llena al elegir puesto..." readonly aria-readonly="true" required>
        </div>
        
        <div>
           <label for="fecha">Fecha del escrito</label>
           <input id="fecha" name="fecha" type="date">
        </div>

        <input id="cargo" name="cargo" type="hidden">

        <div class="grid-full">
            <hr style="border:0; border-top:1px solid var(--panel-border); margin: 10px 0 20px;">
        </div>

        <div>
          <label for="nombre">Nombre del trabajador</label>
          <input id="nombre" name="nombre" required placeholder="Nombre(s) y apellidos completos">
        </div>
        <div>
          <label for="matricula">Matr√≠cula</label>
          <input id="matricula" name="matricula" required placeholder="Ej. 123456" inputmode="numeric" pattern="\d+">
        </div>
        <div>
          <label for="categoria">Categor√≠a</label>
          <input id="categoria" name="categoria" required placeholder="Ej. Enfermera General A">
        </div>
        <div>
          <label for="lugar">Adscripci√≥n / Centro de Trabajo</label>
          <input id="lugar" name="lugar" placeholder="Ej. HGZ No. XX, Urgencias">
        </div>
        
        <div class="grid-full">
             <label for="ciudad">Ciudad / Municipio</label>
             <input id="ciudad" name="ciudad" placeholder="Ej. L√°zaro C√°rdenas, Michoac√°n" required>
        </div>

        <div class="grid-full">
          <label for="problematica">Descripci√≥n de los hechos (La IA redactar√° el oficio formal)</label>
          <textarea id="problematica" name="problematica" placeholder="Explica qu√© sucedi√≥, fechas, personas involucradas y qu√© solicitas..." required></textarea>
        </div>

        <div class="grid-full row" style="justify-content: flex-end;">
          <span class="small">Se generar√° un PDF tama√±o Carta.</span>
          <button type="button" class="btn" id="btnPreview">üëÅÔ∏è Vista Previa</button>
          <button type="submit" class="btn primary" id="btnGenerar">üöÄ Generar Documento</button>
        </div>
      </form>
    </div>
  </div>

  <div id="status" aria-live="polite"></div>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-card" tabindex="-1">
      <div class="modal-h">
        <div class="modal-t" id="modal-title">Vista previa del documento</div>
        <div class="modal-a">
          <button class="btn" id="btnCopy" type="button">üìã Copiar</button>
          <button class="btn" id="btnDownload" type="button">‚¨áÔ∏è PDF</button>
          <button class="btn primary" id="btnPrint" type="button">üñ®Ô∏è Imprimir</button>
          <button class="btn" id="btnClose" type="button" style="color: #ef4444; border-color: rgba(239,68,68,0.3);">‚úñ Cerrar</button>
        </div>
      </div>
      <div class="modal-b">
        <div id="page" class="page carta">
          <div id="sheet" class="sheet"></div>
        </div>
      </div>
    </div>
  </div>

  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // === CONFIG ===
    const API_BASE = "https://sinos-api.onrender.com"; 
    const FORM_KEY = 'sinos_denuncias_v1';

    const $ = s => document.querySelector(s);
    const N = s => (s||'').toString().trim();
    const setStatus = (t='')=> $('#status').textContent=t;

    const ensureJsPDF = () => new Promise((resolve, reject)=>{
      let tries = 0;
      const t = setInterval(()=>{
        tries++;
        if (window.jspdf && window.jspdf.jsPDF && window.html2canvas){
          clearInterval(t);
          resolve(window.jspdf);
        }
        if (tries > 200){ 
          clearInterval(t);
          reject(new Error('jsPDF/html2canvas no cargaron'));
        }
      }, 50);
    });

    const hoyISO = () => new Date().toISOString().slice(0,10);
    const fechaLarga = (iso) => {
      const d = iso ? new Date(iso) : new Date();
      return d.toLocaleDateString('es-MX', { day:'2-digit', month:'long', year:'numeric' });
    };

    function escapeHTML(s){
      return (s||'').replace(/[&<>"']/g, m => (
        { "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]
      ));
    }

    async function redactarIA(d){
      const ctrl = new AbortController();
      const timeout = setTimeout(()=> ctrl.abort(), 12000); 
      try{
        setStatus("üß† La IA est√° redactando tu escrito formal...");

        const hechos = [];
        if (N(d.problematica)) hechos.push(N(d.problematica));

        const payload = {
          tema: "Escrito de denuncia o reporte",
          tono: "formal",
          hechos,
          extras: "Analiza la problem√°tica y redacta un cuerpo claro y profesional en p√°rrafos; sin encabezado ni firma. A√±ade una despedida breve.",
          incluirDespedida: true,
          longitud: "media"
        };

        const res = await fetch(`${API_BASE}/escritor`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          signal: ctrl.signal
        });

        if(!res.ok){
          const txt = await res.text().catch(()=> '');
          throw new Error(`API /escritor ${res.status}: ${txt || res.statusText}`);
        }

        const json = await res.json();
        if (json.error){
          throw new Error(json.detail || json.error);
        }

        const cuerpo = json.cuerpo || "";
        const despedida = json.despedida ? "\n\n" + json.despedida : "";
        setStatus("‚úÖ Texto generado correctamente.");
        return `${cuerpo}${despedida}`;
      }catch(e){
        console.error(e);
        setStatus("‚ö†Ô∏è Error al redactar.");
        alert("No se pudo redactar con la IA.\n" + (e.name==='AbortError' ? 'Tiempo de espera agotado.' : e.message));
        return "";
      }finally{
        clearTimeout(timeout);
        setTimeout(()=>setStatus(""), 4000);
      }
    }

    async function armarOficio(d){
      const encabezadoTop = `${d.ciudad}, a ${fechaLarga(d.fecha || hoyISO())}`;
      const dest = `${d.destinatario}${N(d.cargo)?`\n${d.cargo}`:''}`;
      const cuerpo = await redactarIA(d);
      const pie =
`\nATENTAMENTE

${d.nombre}
Matr√≠cula: ${d.matricula}
Categor√≠a: ${d.categoria}${N(d.lugar)?`\n${d.lugar}`:''}`;
      return { encabezadoTop, dest, cuerpo, pie };
    }

    function datos(){
      return {
        ciudad: N($('#ciudad').value),
        fecha: N($('#fecha').value),
        destinatario: N($('#destinatario').value),
        cargo: N($('#cargo').value),
        nombre: N($('#nombre').value),
        matricula: N($('#matricula').value),
        categoria: N($('#categoria').value),
        lugar: N($('#lugar').value),
        problematica: N($('#problematica').value)
      };
    }

    function setDatos(d){
      if(!d) return;
      const ids = ['ciudad','fecha','destinatario','cargo','nombre','matricula','categoria','lugar','problematica'];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(el && d[id] !== undefined) el.value = d[id] || '';
      });
    }

    function buildPreviewHTML(encabezadoTop, dest, cuerpo, pie){
      const toParas = (txt)=> (txt||"").split(/\n{2,}/).map(p=>p.trim()).filter(Boolean);
      const esc = (s)=> escapeHTML(s).replace(/\n/g,'<br>');
      let html = `
        <header>${esc(encabezadoTop)}</header>
        <div class="dest">${esc(dest)}</div>
        <p class="pres">Presente.</p>
      `;
      toParas(cuerpo).forEach(p=>{
        if(/^[A-Z√Å√â√ç√ì√ö√ë\s\/]+:$/.test(p)){ html += `<h6>${esc(p)}</h6>`; }
        else { html += `<p>${esc(p)}</p>`; }
      });
      html += `<div class="pie">${esc(pie)}</div>`;
      return html;
    }

    let cachedOficio = null;
    let cachedKey = null;

    function getKeyFromDatos(d){
      return JSON.stringify({
        ciudad: d.ciudad,
        fecha: d.fecha,
        destinatario: d.destinatario,
        cargo: d.cargo,
        nombre: d.nombre,
        matricula: d.matricula,
        categoria: d.categoria,
        lugar: d.lugar,
        problematica: d.problematica
      });
    }

    function invalidateCache(){
      cachedOficio = null;
      cachedKey = null;
    }

    async function getOficio(d){
      const key = getKeyFromDatos(d);
      if (cachedOficio && cachedKey === key){
        return cachedOficio;
      }
      const oficio = await armarOficio(d);
      if (!oficio.cuerpo){
        return oficio;
      }
      cachedOficio = oficio;
      cachedKey = key;
      return oficio;
    }

    async function abrirPreview(){
      try{
        const d = datos();
        const required = ['ciudad','destinatario','nombre','matricula','categoria','problematica'];
        for(const k of required){
          if(!d[k]){
            alert('Por favor completa todos los campos obligatorios.');
            return;
          }
        }

        const sheet = $('#sheet');
        sheet.style.padding = `72px 64px`;

        const { encabezadoTop, dest, cuerpo, pie } = await getOficio(d);
        if(!cuerpo){ return; }

        sheet.innerHTML = buildPreviewHTML(encabezadoTop, dest, cuerpo, pie);
        openModal();
      }catch(e){
        console.error(e);
        alert('Ocurri√≥ un error generando la vista previa.');
      }
    }
    function cerrarPreview(){ closeModal(); }

    async function generarPDF(d, {action='print'} = {}){
      setStatus('üìÑ Generando documento PDF‚Ä¶');
      try{
        const { jsPDF } = await ensureJsPDF();
        const doc = new jsPDF({ unit:'pt', format:'letter' });

        const dims = {W:612, H:792};
        const M = 64; 
        const topBase = 72;

        const { encabezadoTop, dest, cuerpo, pie } = await getOficio(d);
        if(!cuerpo){ throw new Error('No se gener√≥ cuerpo del escrito.'); }

        const html = buildPreviewHTML(encabezadoTop, dest, cuerpo, pie);

        const wrapper = document.createElement('div');
        wrapper.style.position = 'fixed';
        wrapper.style.left = '-10000px';
        wrapper.innerHTML = `
          <div class="page carta">
            <div class="sheet" style="padding:0">
              ${html}
            </div>
          </div>
        `;
        document.body.appendChild(wrapper);

        wrapper.querySelector('.sheet header')?.style.setProperty('font-weight','700');
        wrapper.querySelectorAll('.sheet p')?.forEach(p=> p.style.textAlign='justify');

        await doc.html(wrapper.querySelector('.sheet'), {
          x: M,
          y: topBase - 24,
          width: dims.W - M*2,
          windowWidth: 816,
          html2canvas: { scale: 1 }
        });

        document.body.removeChild(wrapper);

        if(action==='download'){
          doc.save('Escrito_Sindicato.pdf');
          setStatus('‚úÖ PDF descargado.');
        } else {
          const blob = doc.output('blob');
          const url = URL.createObjectURL(blob);
          let iframe = document.getElementById('print-iframe');
          if(!iframe){
            iframe = document.createElement('iframe');
            iframe.id = 'print-iframe';
            iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
            iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0'; iframe.style.visibility='hidden';
            document.body.appendChild(iframe);
          }
          await new Promise(res=>{
            iframe.onload = ()=>{
              try{
                iframe.contentWindow.focus();
                setTimeout(()=>{
                  iframe.contentWindow.print();
                  setTimeout(()=> URL.revokeObjectURL(url), 5000);
                  res();
                }, 120);
              }catch(e){ res(); }
            };
            iframe.src = url;
          });
          setStatus('üñ®Ô∏è Listo para imprimir.');
        }
      }catch(e){
        console.error(e);
        setStatus('‚ùå Error al generar el PDF.');
        alert('No se pudo generar el PDF.\n' + e.message);
      }finally{
        setTimeout(()=>setStatus(""), 5000);
      }
    }

    function saveLocal(){
      try{ localStorage.setItem(FORM_KEY, JSON.stringify(datos())); }catch{}
    }
    function loadLocal(){
      try{
        const s = localStorage.getItem(FORM_KEY);
        if(s) setDatos(JSON.parse(s));
      }catch{}
    }

    const modal = $('#modal');
    const modalCard = modal.querySelector('.modal-card');
    let lastFocused = null;

    function getFocusable(){
      return modalCard.querySelectorAll('button,[href],[tabindex]:not([tabindex="-1"])');
    }
    function trapFocus(e){
      if(e.key !== 'Tab') return;
      const f = getFocusable();
      if(!f.length) return;
      const first = f[0], last = f[f.length-1];
      if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
      else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
    }

    function openModal(){
      lastFocused = document.activeElement;
      modal.classList.add('show');
      const f = getFocusable();
      (f[0] || modalCard).focus();
      document.addEventListener('keydown', onKeydown);
    }
    function closeModal(){
      modal.classList.remove('show');
      document.removeEventListener('keydown', onKeydown);
      if(lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
    }
    function onKeydown(e){
      if(e.key === 'Escape') closeModal();
      if(e.key === 'Tab') trapFocus(e);
    }

    document.getElementById('btnPreview').addEventListener('click', abrirPreview);
    document.getElementById('btnClose').addEventListener('click', cerrarPreview);
    document.getElementById('btnDownload').addEventListener('click', async ()=>{
      const d = datos();
      if(!d.problematica) { alert('Faltan campos'); return; }
      await generarPDF(d, {action:'download'});
    });
    document.getElementById('btnPrint').addEventListener('click', async ()=>{
      const d = datos();
      if(!d.problematica) { alert('Faltan campos'); return; }
      await generarPDF(d, {action:'print'});
    });
    document.getElementById('btnCopy').addEventListener('click', async ()=>{
      try{
        const d = datos();
        const { encabezadoTop, dest, cuerpo, pie } = await getOficio(d);
        if(!cuerpo){ return; }
        const txt = `${encabezadoTop}\n\n${dest}\nPresente.\n\n${cuerpo}\n${pie}`;
        await navigator.clipboard.writeText(txt);
        setStatus('üìã Texto copiado.');
      }catch(e){ setStatus('‚ùå No se pudo copiar.'); }
      finally{ setTimeout(()=>setStatus(""), 3000); }
    });

    document.getElementById('fDenuncia').addEventListener('submit', async (e)=>{
      e.preventDefault();
      e.stopPropagation();
      const d = datos();
      if(!d.problematica) { alert('Faltan campos'); return; }
      await generarPDF(d, {action:'print'});
    });

    document.getElementById('puestoCatalogo').addEventListener('change', (e)=>{
      const val = e.target.value || '';
      const dest = document.getElementById('destinatario');
      const cargo = document.getElementById('cargo');
      dest.value = '';
      cargo.value = '';
      if(!val) return;
      const [cargoTxt, titular] = val.split('|');
      if(cargoTxt) cargo.value = cargoTxt;
      if(titular) dest.value = titular;
      saveLocal();
      invalidateCache();
    });

    document.getElementById('fDenuncia').addEventListener('input', ()=>{
      saveLocal();
      invalidateCache();
    });

    document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') closeModal(); });

    loadLocal();
    const f = $('#fecha'); if(f && !f.value) f.value = hoyISO();
  });
  </script>
</body>
</html>
