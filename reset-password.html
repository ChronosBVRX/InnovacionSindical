<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Unidad en Acción — Restablecer contraseña</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{
    --bg:#0b1022; --panel:#0e1730; --ring:rgba(91,215,242,.35);
    --txt:#e6fbff; --muted:#aee9f7; --accent:#5bd7f2; --sky:#60a5fa; --err:#ff7b7b;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; color:var(--txt);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    background:
      radial-gradient(70vmax 70vmax at 50% 20%, rgba(96,165,250,.12), transparent 60%),
      radial-gradient(60vmax 60vmax at 80% 80%, rgba(91,215,242,.10), transparent 60%),
      linear-gradient(180deg,#0b1220,#0b1022);
  }
  .wrap{max-width:480px;margin:0 auto;padding:22px}
  .card{
    margin-top:40px;
    background:linear-gradient(180deg,var(--panel),#0b1328);
    border:1px solid rgba(91,215,242,.25); border-radius:16px; padding:20px;
    box-shadow:0 10px 40px rgba(0,0,0,.45);
  }
  .head{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .head img{
    width:42px;height:42px;border-radius:10px;border:1px solid rgba(91,215,242,.25);
    background:#071022;object-fit:contain
  }
  h1{margin:0;font-size:18px;color:#d8fbff}
  .muted{color:#aee9f7;font-size:13px}
  label{display:block;font-size:12px;color:#bdefff;margin:10px 0 4px}
  input{
    width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(91,215,242,.28);
    background:#0a1329;color:#e6fbff;outline:none
  }
  .btn{
    appearance:none;border:1px solid rgba(91,215,242,.45);background:rgba(91,215,242,.14);
    color:#e6fbff;border-radius:12px;padding:10px 14px;font-size:14px;cursor:pointer;
    width:100%;margin-top:14px;
  }
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--sky));border:none;color:#072133}
  .btn.secondary{background:transparent;border-color:rgba(174,233,247,.5);margin-top:8px}
  .error{color:var(--err);font-size:13px;margin-top:8px}
  .ok{color:#6ee7b7;font-size:13px;margin-top:8px}
  .small{font-size:12px;color:var(--muted);margin-top:8px}
  .center{text-align:center}
  .hidden{display:none}
  .spinner{
    width:18px;height:18px;border-radius:999px;
    border:2px solid rgba(148, 221, 255,.25);
    border-top-color:var(--accent);
    animation:spin 0.8s linear infinite;
    display:inline-block;vertical-align:middle;margin-right:6px;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <img src="https://raw.githubusercontent.com/ChronosBVRX/InnovacionSindical/main/Logo%20Unidad%20en%20Accion.png" alt="Unidad en Acción">
        <div>
          <h1>Restablecer contraseña</h1>
          <div class="muted">Unidad en Acción — Red Juventud Sindical</div>
        </div>
      </div>

      <!-- Estado de carga / validación de enlace -->
      <div id="viewLoading" class="center">
        <div class="spinner"></div>
        <div class="small">Verificando enlace de recuperación…</div>
      </div>

      <!-- Vista de error cuando el enlace no es válido -->
      <div id="viewInvalid" class="hidden">
        <p class="error">
          El enlace para restablecer la contraseña no es válido o ya fue utilizado.
        </p>
        <p class="small">
          Vuelve a solicitar un correo de recuperación desde la página de acceso.
        </p>
        <button class="btn secondary" type="button"
          onclick="location.href='https://chronosbvrx.github.io/InnovacionSindical/'">
          Volver al inicio
        </button>
      </div>

      <!-- Formulario para definir nueva contraseña -->
      <form id="viewForm" class="hidden" autocomplete="off">
        <p class="small">
          Escribe una nueva contraseña para tu cuenta. Usa al menos 6 caracteres.
        </p>
        <label for="newPass">Nueva contraseña</label>
        <input id="newPass" type="password" minlength="6" required placeholder="Mínimo 6 caracteres">

        <label for="newPass2">Repite la nueva contraseña</label>
        <input id="newPass2" type="password" minlength="6" required placeholder="Vuelve a escribirla">

        <button id="btnSave" class="btn primary" type="submit">
          Guardar nueva contraseña
        </button>

        <div id="msgError" class="error"></div>
        <div id="msgOk" class="ok"></div>

        <p class="small center">
          Después de guardar, podrás iniciar sesión normalmente desde la página de acceso.
        </p>
        <button class="btn secondary" type="button"
          onclick="location.href='https://chronosbvrx.github.io/InnovacionSindical/'">
          Ir al inicio
        </button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (async ()=>{
    /* ====== CONFIG (igual que en tu login) ====== */
    const SUPABASE_URL = "https://axsncdwshdvsysrpikwj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c25jZHdzaGR2c3lzcnBpa3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjkwMjQsImV4cCI6MjA3NTgwNTAyNH0.oapcH219puVjaR2DcG7dX51uhwVn530L1hhz8ASv7qs";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    const viewLoading = document.getElementById('viewLoading');
    const viewInvalid = document.getElementById('viewInvalid');
    const viewForm   = document.getElementById('viewForm');
    const msgError   = document.getElementById('msgError');
    const msgOk      = document.getElementById('msgOk');
    const btnSave    = document.getElementById('btnSave');

    // 1) Al llegar aquí desde el correo, Supabase usa detectSessionInUrl para
    // crear una sesión temporal (tipo "recovery"). La verificamos:
    try{
      const { data, error } = await supabase.auth.getSession();

      viewLoading.classList.add('hidden');

      if (error || !data || !data.session){
        // No hay sesión de recuperación válida → enlace inválido
        viewInvalid.classList.remove('hidden');
        return;
      }

      // Hay sesión válida → mostramos formulario para nueva contraseña
      viewForm.classList.remove('hidden');

    }catch(err){
      console.error(err);
      viewLoading.classList.add('hidden');
      viewInvalid.classList.remove('hidden');
      return;
    }

    // 2) Manejar envío del formulario
    viewForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msgError.textContent = '';
      msgOk.textContent = '';

      const pass1 = document.getElementById('newPass').value;
      const pass2 = document.getElementById('newPass2').value;

      if (!pass1 || !pass2){
        msgError.textContent = 'Completa ambos campos de contraseña.';
        return;
      }
      if (pass1.length < 6){
        msgError.textContent = 'La contraseña debe tener al menos 6 caracteres.';
        return;
      }
      if (pass1 !== pass2){
        msgError.textContent = 'Las contraseñas no coinciden.';
        return;
      }

      btnSave.disabled = true;
      btnSave.textContent = 'Guardando…';

      const { data, error } = await supabase.auth.updateUser({
        password: pass1
      });

      btnSave.disabled = false;
      btnSave.textContent = 'Guardar nueva contraseña';

      if (error){
        console.error(error);
        msgError.textContent = 'No se pudo actualizar la contraseña: ' + (error.message || '');
        return;
      }

      msgOk.textContent = '¡Listo! Tu contraseña se actualizó correctamente.';
      msgError.textContent = '';

      // Opcional: cerrar la sesión de recuperación después de unos segundos
      // y sugerir ir a la página de acceso normal.
      setTimeout(async ()=>{
        await supabase.auth.signOut();
      }, 3000);
    });
  })();
  </script>
</body>
</html>